---
title: "wgeel_indicators_overwiew"
author: "none"
date: "27/09/2021"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(RPostgres)
library(sf)
library(getPass)
library(ggforce)
library(ggplot2)
library(flextable)
library(tidyverse)
library(yaml)
cred=read_yaml("../../credentials.yml")
con = dbConnect(Postgres(), dbname=cred$dbname,host=cred$host,port=cred$port,user=cred$user, password=getPass())
load("../../R/shiny_data_visualisation/shiny_dv/data/maps_for_shiny.Rdata")
load("../../R/shiny_data_visualisation/shiny_dv/data/ref_and_eel_data.Rdata")
#emu_c <- st_as_sf(emu_c)
emu_c <- dplyr::filter(emu_c,!endsWith(emu_nameshort,"_o")) 

values=c(RColorBrewer::brewer.pal(12,"Set3"),
    RColorBrewer::brewer.pal(12, "Paired"), 
    RColorBrewer::brewer.pal(8,"Accent"),
    RColorBrewer::brewer.pal(8, "Dark2"))
country_ref=dbGetQuery(con,"select cou_code from ref.tr_country_cou")
color_countries = setNames(values,country_ref$cou_code)

```

# Downloading data

```{r download}
biomass <- dbGetQuery(con,"select e.* from datawg.t_eelstock_eel e  where eel_qal_id in (0,1,2,3,4) and eel_typ_id in (13,14,15)")

mortality <- dbGetQuery(con,"select e.* from datawg.t_eelstock_eel e where eel_qal_id in (0,1,2,3,4) and eel_typ_id in (17,18,19)")


nb_country_emu <- dbGetQuery(con,"select count(distinct eel_cou_code),count(distinct(eel_emu_nameshort)) from datawg.t_eelstock_eel 
                             where eel_typ_id in (13, 14, 15, 17, 18, 19) and eel_datasource='dc_2021'")
```

# Data availability
## General overview
Tables showing the numbers of the range and numbers of years provided for each indicator by each country
```{r data2020}
flextable(biomass %>% 
            mutate(eel_value=ifelse(is.na(eel_value & eel_missvaluequal == "NP"), 0,eel_value)) %>% 
            select(eel_typ_id,
                   eel_year,
                   eel_emu_nameshort,
                   eel_value) %>%
            mutate(eel_typ_id=case_when(eel_typ_id==13~"B0",eel_typ_id==14~"Bbest",eel_typ_id==15~"Bcurrent")) %>%
            na.omit() %>%
            group_by(eel_typ_id,
                     eel_emu_nameshort) %>%
            summarize(minyear=min(eel_year), maxyear=max(eel_year), nb_value=n()) %>%
            mutate(range=paste(minyear, maxyear, sep = "-")) %>%
            select(eel_typ_id, eel_emu_nameshort, nb_value, range) %>%
            arrange(eel_emu_nameshort) %>%
            pivot_wider(names_from=eel_typ_id, values_from=c(range, nb_value),
                        names_glue="{eel_typ_id}_{.value}",
                        names_sort=TRUE)) %>% autofit()
```


for mortality

```{r mortadata}
  

flextable(mortality %>% 
            mutate(eel_value=ifelse(is.na(eel_value & eel_missvaluequal == "NP"), 0,eel_value)) %>% 
            select(eel_typ_id,
                   eel_year,
                   eel_emu_nameshort,
                   eel_value) %>%
            mutate(eel_typ_id=case_when(eel_typ_id==17~"sumA",eel_typ_id==18~"sumF",eel_typ_id==19~"sumH")) %>%
            na.omit() %>%
            group_by(eel_typ_id,
                     eel_emu_nameshort) %>%
            summarize(minyear=min(eel_year), maxyear=max(eel_year), nb_value=n()) %>%
            mutate(range=paste(minyear, maxyear, sep = "-")) %>%
            select(eel_typ_id, eel_emu_nameshort, nb_value, range) %>%
            arrange(eel_emu_nameshort) %>%
            pivot_wider(names_from=eel_typ_id, values_from=c(range, nb_value),
                        names_glue="{eel_typ_id}_{.value}",
                        names_sort=TRUE)) %>% autofit()
  
        
          
          
```


```{r notans}
sort(country_p$cou_country[! country_p$cou_code %in% c(biomass$eel_cou_code , mortality$eel_cou_code)]) 
```

## Spatial coverage
Maps showings data avaibility. The symbol indicates wether the country have provided estimates for at least one (whatever year), two , three distinct indicators.
```{r indicatorsmaps}
data_avail = rbind.data.frame(mortality,biomass) %>%
  filter(!(is.na(eel_value) & eel_missvaluequal!="NP")) %>%
  group_by(eel_emu_nameshort) %>%
  summarize(b0=sum(eel_typ_id==13)>0,
         bbest=sum(eel_typ_id==14)>0,
         bcurrent=sum(eel_typ_id==15)>0,
         suma=sum(eel_typ_id==17)>0,
         sumf=sum(eel_typ_id==18)>0,
         sumh=sum(eel_typ_id==19)>0)
data_avail <- merge(emu_c, data_avail, by.x="emu_nameshort",by.y="eel_emu_nameshort",all.x=TRUE)
data_avail<- st_transform(data_avail, crs=3035)
data_avail$x <-st_coordinates(data_avail)[,1]
data_avail$y <-st_coordinates(data_avail)[,2]
data_avail$x[data_avail$emu_cou_code=="NO"] = 4172612.3
data_avail$y[data_avail$emu_cou_code=="NO"] = 4111023.3
data_avail<- data_avail %>%
  mutate(bsummary=coalesce(b0+bbest+bcurrent, 0),
         mortsummary=coalesce(suma+sumf+sumh,0),
         responded=ifelse(is.na(bsummary) & is.na(mortsummary), FALSE, TRUE))


ggplot(st_transform(country_p,crs=3035)) + geom_sf(fill=NA)+theme_bw()+
  geom_point(data=data_avail,aes(x=x,y=y,fill=as.factor(bsummary)),shape=21)+
  scale_fill_viridis_d("Biomass indicators",labels=c("none","one","two","three"))+
  xlab("")+ylab("")

ggplot(st_transform(country_p,crs=3035)) + geom_sf(fill=NA)+theme_bw()+
  geom_point(data=data_avail,aes(x=x,y=y,fill=as.factor(mortsummary)),shape=21)+
  scale_fill_viridis_d("Mortality indicators",labels=c("none","one","two","three"))+
  xlab("")+ylab("")

data_avail =data_avail %>% select(emu_nameshort,x,y,bsummary,responded,mortsummary,geometry) %>%
  pivot_longer(cols=ends_with("summary"),names_to="indicator",values_to="nb")

ggplot(st_transform(country_p,crs=3035)) + geom_sf(fill=NA)+theme_bw()+
  geom_point(data=data_avail,aes(x=x,y=y,fill=as.factor(nb)),shape=21)+
  scale_fill_viridis_d("Number of indicators",labels=c("none","one","two","three"))+
  xlab("")+ylab("")+facet_wrap(~indicator)

#ggsave(filename="/tmp/maps.png",width=16/2.54,height=10/2.54)
```

## Habitat coverage
This year for the first time, we asked aggregated data at the EMU scale, but asked for habitat coverage within indicator.

```{r habitatcoverage}
biomass <- dbGetQuery(con,"select * from datawg.t_eelstock_eel e  left join datawg.t_eelstock_eel_percent on eel_id=percent_id where eel_qal_id=1 and eel_typ_id in (13,14,15)")

mortality <- dbGetQuery(con,"select * from datawg.t_eelstock_eel e left join datawg.t_eelstock_eel_percent on eel_id=percent_id where eel_qal_id=1 and eel_typ_id in (17,18,19)")



biomass_long <- biomass%>%
  filter(!is.na(eel_value)) %>%
  select(eel_year,eel_typ_id,eel_emu_nameshort,perc_mo,perc_f,perc_c,perc_t) %>%
  pivot_longer(cols=c(perc_mo,perc_f,perc_t,perc_c), 
               names_to="habitat", values_to="perc") %>%
  mutate(habitat=toupper(gsub("perc_","",habitat)))%>%
  mutate(type="biomass",
         eel_typ_id=case_when(eel_typ_id==13~"B0",eel_typ_id==14~"Bbest",eel_typ_id==15~"Bcurrent"))

mortality_long <-mortality%>%
  filter(!is.na(eel_value)) %>%
  select(eel_year,eel_typ_id,eel_emu_nameshort,perc_mo,perc_f,perc_c,perc_t) %>%
  pivot_longer(cols=c(perc_mo,perc_f,perc_t,perc_c), 
               names_to="habitat", values_to="perc") %>%
  mutate(habitat=toupper(gsub("perc_","",habitat))) %>%
  mutate(type="mortality",
         eel_typ_id=case_when(eel_typ_id==17~"sumA",eel_typ_id==18~"sumF",eel_typ_id==19~"sumH"))

indicator <- biomass_long %>%
  bind_rows(mortality_long) %>%
  filter(perc >= 0)

flextable(indicator %>%
  group_by(type,habitat) %>%
  summarize(freq100=round(sum(perc==100)/n()*100),
            freq0=round(sum(perc==0)/n()*100)) %>%
  pivot_wider(names_from=habitat,values_from=c(freq0,freq100))) %>% autofit()
```
Marine open and coastal never accounted for. Significant part of transitional waters not accounted for.

# Maps of indicators
Values averages from 2018 to 2020 (3 years)

## per emu


```{r rasta}
# indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_emu where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
# indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort")
# indicator = st_transform(indicator,crs=3035)
# indicator$x <-st_coordinates(indicator)[,1]
# indicator$y <-st_coordinates(indicator)[,2]
# indicator$btarget <- .4*indicator$b0
# indicator$bscaled <- indicator$bcurrent/indicator$b0
# prettyscale <- pretty(range(indicator$bcurrent,na.rm=TRUE),n=2)
# prettyscale_scaled <- scales::rescale(prettyscale,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
# scalesb <-data.frame(b=prettyscale,bscale=prettyscale_scaled)
# # indicator$btarget <- scales::rescale(indicator$btarget,to=c(40190.79,200000.00),from=c(661,10400000))
#  indicator$bcurrent <- scales::rescale(indicator$bcurrent,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
# # indicator$bbest <- scales::rescale(indicator$bbest,to=c(40190.79,200000.00),from=c(661,10400000))
# # indicator$b0 <- scales::rescale(indicator$b0,to=c(40190.79,200000.00),from=c(661,10400000))
# 
# # indicator$bcurrent <- log(indicator$bcurrent)/log(max(indicator$b0,na.rm=TRUE))*100000
# # indicator$bbest <- log(indicator$bbest)/log(max(indicator$b0,na.rm=TRUE))*100000
# # indicator$b0 <- log(indicator$b0)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$suma <- indicator$suma /.92*20000
# indicator$sumf <- indicator$sumf /.92*20000
# indicator$sumh <- indicator$sumh /.92*20000
# 
# 
# legend <- data.frame(indicator=c("sumA","sumF"))
# 
# # indicator <- indicator %>%
# #   select(-sumh) %>%
# #   pivot_longer(cols=c(suma,sumf,b0,btarget,bcurrent,bbest),names_to="indicator",values_to="r") %>%
# #   mutate(start=ifelse(startsWith(indicator,"b"),pi,0),
# #          end=ifelse(startsWith(indicator,"b"),2*pi,pi),
# #          fill=case_when(indicator=="b0" ~ "grey",
# #                         indicator=="bcurrent" ~ "green",
# #                         indicator=="bbest" ~ "orange",
# #                         indicator=="btarget" ~ "red",
# #                         indicator=="sumf" ~ "yellow",
# #                         indicator=="suma" ~ "blue"),
# #          alpha=ifelse(indicator %in% c("b0","suma"),
# #                       1,
# #                       0)) %>%
# #   arrange(desc(r))
# #   
# # 
# # 
# # indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort")
# # indicator = st_transform(indicator,crs=3035)
# # indicator$x <-st_coordinates(indicator)[,1]
# # indicator$y <-st_coordinates(indicator)[,2]
# 
# ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA)+theme_bw()+
#   xlim(2618000,5286000)+ylim(1700000,4560000)+
# #  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = b0, start =pi,
# #                   end = 2*pi), fill = "grey",col=NA,alpha=1)+
# #  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = btarget, start =pi,
# #                   end = 2*pi), fill = "red",col=NA,alpha=.6)+
# #  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bbest, start = pi,
# #                   end = 2*pi ), fill = "orange",col=NA,alpha=.6)+
# #  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = pi,
# #                   end = 2*pi), fill = "green",col=NA,alpha=.6)+
#    geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = pi,
#                    end = 2*pi, fill = bscaled),col=NA,alpha=1)+
#   geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = suma, start =0,
#                    end = pi),fill=NA,col="blue")+
#   geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = sumf, start = 0,
#                    end = pi ),fill=NA,alpha=1,col="yellow")+
#   
#   xlab("")+ylab("") + 
#   geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =4200000, r0 = 0, r = bscale, start =pi,
#                    end = 2*pi), fill = NA,col="black")+
#   geom_text(data=scalesb,aes(x=3050000, y=4200000+bscale,label=paste0(b/1e3,"t")),
#             size=1,hjust="left")+
#   geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =3800000, r0 = 0, r = 20000, start =0,
#                    end = pi), fill = NA,col="black")+
#   geom_text(data=scalesb,aes(x=3000000, y=3800000+20000,label="0.92~year^{-1}" ),
#             size=1,hjust="right", parse=TRUE)+
#   geom_rect(data=legend,aes(col=indicator,xmin=0,ymin=0,xmax=0,ymax=0),fill=NA)+
#    scale_color_manual("",values=c("sumF" = "yellow",
#                           "sumA" = "blue"))+
#   scale_fill_viridis_c("Bcurrent/B0")
#   # scale_alpha_manual("",values=c("B0" = 1,
#   #                        "Bcurrent" = .6,
#   #                        "Bbest"= .6,
#   #                        "Btarget" = .6,
#   #                        "sumF" = 1,
#   #                        "sumA" = 1))
# 
# ggsave(filename="/tmp/maps.png",width=16/2.54,height=10/2.54)


```

### biomass
```{r biomassmap}
indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_emu where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort",all.x=TRUE)
indicator = st_transform(indicator,crs=3035)
indicator$x <-st_coordinates(indicator)[,1]
indicator$y <-st_coordinates(indicator)[,2]
indicator$btarget <- .4*indicator$b0
indicator$bscaled <- indicator$bcurrent/indicator$b0
prettyscale <- pretty(range(indicator$bcurrent,na.rm=TRUE),n=2)
prettyscale_scaled <- scales::rescale(prettyscale,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
scalesb <-data.frame(b=prettyscale,bscale=prettyscale_scaled)
# indicator$btarget <- scales::rescale(indicator$btarget,to=c(40190.79,200000.00),from=c(661,10400000))
 indicator$bcurrent <- scales::rescale(indicator$bcurrent,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
# indicator$bbest <- scales::rescale(indicator$bbest,to=c(40190.79,200000.00),from=c(661,10400000))
# indicator$b0 <- scales::rescale(indicator$b0,to=c(40190.79,200000.00),from=c(661,10400000))

# indicator$bcurrent <- log(indicator$bcurrent)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$bbest <- log(indicator$bbest)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$b0 <- log(indicator$b0)/log(max(indicator$b0,na.rm=TRUE))*100000
indicator$suma <- indicator$suma /.92*20000
indicator$sumf <- indicator$sumf /.92*20000
indicator$sumh <- indicator$sumh /.92*20000

indicator$x[indicator$eel_cou_code=="NO"] = 4172612.3
indicator$y[indicator$eel_cou_code=="NO"] = 4111023.3

# indicator <- indicator %>%
#   select(-sumh) %>%
#   pivot_longer(cols=c(suma,sumf,b0,btarget,bcurrent,bbest),names_to="indicator",values_to="r") %>%
#   mutate(start=ifelse(startsWith(indicator,"b"),pi,0),
#          end=ifelse(startsWith(indicator,"b"),2*pi,pi),
#          fill=case_when(indicator=="b0" ~ "grey",
#                         indicator=="bcurrent" ~ "green",
#                         indicator=="bbest" ~ "orange",
#                         indicator=="btarget" ~ "red",
#                         indicator=="sumf" ~ "yellow",
#                         indicator=="suma" ~ "blue"),
#          alpha=ifelse(indicator %in% c("b0","suma"),
#                       1,
#                       0)) %>%
#   arrange(desc(r))
#   
# 
# 
# indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort")
# indicator = st_transform(indicator,crs=3035)
# indicator$x <-st_coordinates(indicator)[,1]
# indicator$y <-st_coordinates(indicator)[,2]

ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA,size=.1)+theme_bw()+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = b0, start =pi,
#                   end = 2*pi), fill = "grey",col=NA,alpha=1)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = btarget, start =pi,
#                   end = 2*pi), fill = "red",col=NA,alpha=.6)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bbest, start = pi,
#                   end = 2*pi ), fill = "orange",col=NA,alpha=.6)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = pi,
#                   end = 2*pi), fill = "green",col=NA,alpha=.6)+
   geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = 0,
                   end = 2*pi, fill = bscaled),col=NA,alpha=1)+
  
  xlab("")+ylab("") + 
  geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =4200000, r0 = 0, r = bscale, start =pi,
                   end = 2*pi), fill = NA,col="black")+
  geom_text(data=scalesb,aes(x=3050000, y=4200000+bscale,label=paste0(b/1e3,"t")),
            size=2,hjust="left")+
  geom_point(data=indicator %>%
               filter(is.na(bcurrent)),
             aes(x=x,y=y),pch="x")+
  scale_fill_viridis_c(expression(B[current]/B[0]))
  # scale_alpha_manual("",values=c("B0" = 1,
  #                        "Bcurrent" = .6,
  #                        "Bbest"= .6,
  #                        "Btarget" = .6,
  #                        "sumF" = 1,
  #                        "sumA" = 1))

#ggsave(filename="C:/Users/pohlmann/Desktop/Home_Office/ICES/WKEPEMP3/Graphs/maps_biomass.png",width=16/2.54,height=10/2.54)
```

### mortality


```{r mortalitymap}
indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_emu where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort",all.x=TRUE)
indicator = st_transform(indicator,crs=3035)
indicator$x <-st_coordinates(indicator)[,1]
indicator$y <-st_coordinates(indicator)[,2]
indicator$btarget <- .4*indicator$b0
indicator$bscaled <- indicator$bcurrent/indicator$b0
indicator$x[indicator$eel_cou_code=="NO"] = 4172612.3
indicator$y[indicator$eel_cou_code=="NO"] = 4111023.3
# indicator$bcurrent <- log(indicator$bcurrent)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$bbest <- log(indicator$bbest)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$b0 <- log(indicator$b0)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$suma <- indicator$suma /.92*40000
# indicator$sumf <- indicator$sumf /.92*40000
# indicator$sumh <- indicator$sumh /.92*40000
prettyscale <- c(0,.92)
prettyscale_scaled <- scales::rescale(prettyscale,to=c(40000,200000),from=c(0,max(indicator$suma,na.rm=TRUE)))


indicator$sumfsuma <- indicator$sumf/indicator$suma

indicator$suma <- scales::rescale(indicator$suma,to=c(40000,200000), from=c(0,max(indicator$suma,na.rm=TRUE)))

scalesm <-data.frame(m=prettyscale,mscale=prettyscale_scaled,y0=c(4200000,4400000))

legend <- data.frame(indicator=c("sumA","sumF"))

ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA,size=.1)+theme_bw()+
  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = suma, start =0,
                   end = 2*pi,fill=sumfsuma),size=.2,col=NA)+
  # geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = sumf, start = 0,
  #                  end = 2*pi ),size=.2,fill=NA,col="yellow")+
  xlab("")+ylab("") + 
  geom_point(data=indicator %>%
               filter(is.na(suma) & is.na(sumf)),
             aes(x=x,y=y),pch="x")+
    geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =3800000, r0 = 0, r = 40000, start =0,
                   end = pi),size=.2, fill = NA,col="black")+
    geom_arc_bar(data=scalesm,aes(x0 = 3008000, y0 =y0, r0 = 0, r = mscale, start =0,
                   end = pi), fill = NA,col="black")+
  geom_text(data=scalesm,aes(x=3000000, y=y0+mscale,label=paste0(m,"~year^{-1}")),
            size=1,hjust="right", parse=TRUE)+
#    geom_rect(data=legend,aes(col=indicator,xmin=0,ymin=0,xmax=0,ymax=0),fill=NA)+

     # scale_color_manual("",values=c("sumF" = "yellow",
     #                      "sumA" = "blue"))
  scale_fill_viridis_c(expression(paste(Sigma,"F")/paste(Sigma,"A")))


#ggsave(filename="/tmp/maps_mortality.png",width=16/2.54,height=10/2.54)
```



## per country
Here, biomasses are summed over available EMUs and mortality are average (weighted averages based on bbest)

### biomass
```{r biomassmapcountry}
# indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_country where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
indicator <- precodata_country %>%
  filter(eel_year >=2018) %>%
  group_by(eel_cou_code) %>%
  summarize(b0=mean(b0,na.rm=TRUE),
            bcurrent=mean(bcurrent,na.rm=TRUE),
            bcurrent_b0_emu=mean(ratio_bcurrent_b0,na.rm=TRUE))
indicator <- merge(country_c, indicator, by.x="cou_code",by.y="eel_cou_code",all.x=TRUE)
indicator = st_transform(indicator,crs=3035)
indicator$x <-st_coordinates(indicator)[,1]
indicator$y <-st_coordinates(indicator)[,2]
indicator$x[indicator$cou_code=="NO"] = 4172612.3
indicator$y[indicator$cou_code=="NO"] = 4111023.3

indicator$btarget <- .4*indicator$b0
indicator$bscaled <- indicator$bcurrent/indicator$b0
prettyscale <- pretty(range(indicator$bcurrent,na.rm=TRUE),n=2)
prettyscale_scaled <- scales::rescale(prettyscale,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
scalesb <-data.frame(b=prettyscale,bscale=prettyscale_scaled)
# indicator$btarget <- scales::rescale(indicator$btarget,to=c(40190.79,200000.00),from=c(661,10400000))
 indicator$bcurrent <- scales::rescale(indicator$bcurrent,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))

 

 
 
ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA,size=.1)+theme_bw()+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = b0, start =pi,
#                   end = 2*pi), fill = "grey",col=NA,alpha=1)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = btarget, start =pi,
#                   end = 2*pi), fill = "red",col=NA,alpha=.6)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bbest, start = pi,
#                   end = 2*pi ), fill = "orange",col=NA,alpha=.6)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = pi,
#                   end = 2*pi), fill = "green",col=NA,alpha=.6)+
   geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = 0,
                   end = 2*pi, fill = bcurrent_b0_emu),col=NA,alpha=1)+
  
  xlab("")+ylab("") + 
  geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =4200000, r0 = 0, r = bscale, start =pi,
                   end = 2*pi), fill = NA,col="black")+
  geom_text(data=scalesb,aes(x=3050000, y=4200000+bscale,label=paste0(b/1e3,"t")),
            size=1,hjust="left")+
  geom_point(data=indicator %>%
               filter(is.na(bcurrent)),
             aes(x=x,y=y),pch="x")+
  scale_fill_viridis_c(expression(B[current]/B[0]))
  # scale_alpha_manual("",values=c("B0" = 1,
  #                        "Bcurrent" = .6,
  #                        "Bbest"= .6,
  #                        "Btarget" = .6,
  #                        "sumF" = 1,
  #                        "sumA" = 1))

#ggsave(filename="/tmp/maps_biomass_country.png",width=16/2.54,height=10/2.54)
```

### mortality


```{r mortalitymapcountry}
# indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_country where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
indicator <- precodata_country %>%
  filter(eel_year >=2018) %>%
  group_by(eel_cou_code) %>%
  summarize(suma=mean(suma,na.rm=TRUE),
            sumf=mean(sumf,na.rm=TRUE),
            sumfsuma_emu=mean(ratio_sumfsuma,na.rm=TRUE))
indicator <- merge(country_c, indicator, by.x="cou_code",by.y="eel_cou_code",all.x=TRUE)
indicator = st_transform(indicator,crs=3035)
indicator$x <-st_coordinates(indicator)[,1]
indicator$y <-st_coordinates(indicator)[,2]
indicator$x[indicator$cou_code=="NO"] = 4172612.3
indicator$y[indicator$cou_code=="NO"] = 4111023.3

prettyscale <- c(0,.92)
prettyscale_scaled <- scales::rescale(prettyscale,to=c(40000,200000),from=c(0,max(indicator$suma,na.rm=TRUE)))

indicator$sumf <- scales::rescale(indicator$sumf,to=c(40000,200000), from=c(0,max(indicator$suma,na.rm=TRUE)))

indicator$suma <- scales::rescale(indicator$suma,to=c(40000,200000), from=c(0,max(indicator$suma,na.rm=TRUE)))

scalesm <-data.frame(m=prettyscale,mscale=prettyscale_scaled,y0=c(4200000,4500000))



legend <- data.frame(indicator=c("sumA","sumF"))

ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA,size=.1)+theme_bw()+
  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = suma, start =0,
                   end = 2*pi,fill=sumfsuma_emu),size=.2,col=NA)+
  # geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = sumf, start = 0,
  #                  end = 2*pi ),size=.2,fill=NA,col="yellow")+
  xlab("")+ylab("") + 
  geom_point(data=indicator %>%
               filter(is.na(suma) & is.na(sumf)),
             aes(x=x,y=y),pch="x")+
    geom_arc_bar(data=scalesm,aes(x0 = 3008000, y0 =y0, r0 = 0, r = mscale, start =0,
                   end = pi), fill = NA,col="black")+
  geom_text(data=scalesm,aes(x=3000000, y=y0+mscale,label=paste0(m,"~year^{-1}")),
            size=1,hjust="right", parse=TRUE)+
#    geom_rect(data=legend,aes(col=indicator,xmin=0,ymin=0,xmax=0,ymax=0),fill=NA)+

     # scale_color_manual("",values=c("sumF" = "yellow",
     #                      "sumA" = "blue"))
  scale_fill_viridis_c(expression(paste(Sigma,"F")/paste(Sigma,"A")))


#ggsave(filename="/tmp/maps_mortality_country.png",width=16/2.54,height=10/2.54)
```



# Time trends
## Biomass
Each line represents an EMU.

```{r trendbiomass}
indicator <- dbGetQuery(con,"select eel_year,eel_cou_code,eel_emu_nameshort, b0,bbest,bcurrent, suma,sumf, sumh from datawg.precodata_emu")
indicator<- indicator %>%
  mutate(eel_cou_code=ifelse(eel_cou_code == substr(eel_emu_nameshort,1,2),
                             eel_cou_code,
                             "INT")) %>%
  filter(eel_cou_code!="IE" | eel_year !=2008)


ggplot(indicator %>% filter(!is.na(bcurrent/b0)),aes(x=eel_year,y=bcurrent/b0)) +
  geom_hline(yintercept=.4,col="red")+
  geom_line(aes(col=eel_cou_code,group=eel_emu_nameshort))+
#  scale_y_log10()+
  scale_color_manual("country",values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)],)+
  guides(lty=FALSE,col=FALSE)+ #geom_hline(yintercept=1)+
#  scale_y_sqrt()+

  theme_bw() + ylab(expression(B[current]/B[0]))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code,drop=TRUE,scales="free_y")

```

```{r trendmorta}
indicator <- dbGetQuery(con,"select eel_year,eel_cou_code,eel_emu_nameshort, b0,bbest,bcurrent, suma,sumf, sumh from datawg.precodata_emu")
indicator<- indicator %>%
  mutate(eel_cou_code=ifelse(eel_cou_code == substr(eel_emu_nameshort,1,2),
                             eel_cou_code,
                             "INT")) %>%
  filter(eel_cou_code!="IE" | eel_year !=2008)



ggplot(indicator %>% filter(!is.na(suma)),aes(x=eel_year,y=suma))+
  geom_hline(yintercept=0.92,col="red")+
  geom_line(aes(group=eel_emu_nameshort,col=eel_cou_code))+
  scale_color_manual(values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)])+
  guides(lty=FALSE, col=FALSE)+
#  scale_y_sqrt()+
  theme_bw() + ylab(expression(paste(Sigma,"A")))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code,drop=TRUE,scales="free_y")

color_countries = c(color_countries,"INT"="#ff5733")            

ggplot(indicator %>% filter(!is.na(sumf)),aes(x=eel_year,y=sumf))+
  geom_hline(yintercept=0.92,col="red")+
  geom_line(aes(group=eel_emu_nameshort,col=eel_cou_code))+
  scale_color_manual(values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)])+
  guides(lty=FALSE, col=FALSE)+
#  scale_y_sqrt()+
  theme_bw() + ylab(expression(paste(Sigma,"F")))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code, drop=TRUE,scales="free_y")



ggplot(indicator %>% filter(!is.na(sumh)),aes(x=eel_year,y=sumh))+
  geom_hline(yintercept=0.92,col="red")+
  geom_line(aes(group=eel_emu_nameshort,col=eel_cou_code))+
  scale_color_manual(values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)])+
  guides(lty=FALSE, col=FALSE)+
#  scale_y_sqrt()+
  theme_bw() + ylab(expression(paste(Sigma,"H")))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code, drop=TRUE,scales="free_y") 


```



# Time trend analyses
## Biomass
Time trend analyses are carried out on the ratio of Bcurrent/B0 and Bcurrent/B0_adjusted - as indicated by suffixes.\
B0_adjusted accounts for the fact that while B0, by definition, is a fixed value, Bcurrent partly depends on natural recruitment. The ratio Bcurrent/B0 will thus not accurately reflect the influence of continental factors on escapement biomass (most importantly effects of management measures) but also changes in natural recruitment. B0_adjusted incorporates changes in natural recruitment, therefore canceling out effects of natural recruitment on Bcurrent and removing the bias. Since a multitude of different methods and models is used by countries to calculate biomass indicators a general approximation for the adjustment of B0 was derived from WGEEL recruitment index by... _SENTENCE OR TWO FROM HILAIRE_   

The following restraints were defined for trend analyses:   
1. Only values after 2010 (Implementation of Eel regulation) were considered\
2. Time Series need to have at least 5 observations

Delta gives the difference between the initial (2010) and current (latest year reported) ratio of either Bcurrent/Bo or Bcurrent/B0_adjusted - as indicated by suffixes. The value thus indicates a quantitative measure of the change in biomass whereas Tau gives a qualitative estimate on whether the trend is positive/negative and significant (also see table footnote).


```{r trendbiomasstable}

library(Kendall)
#source("readingAnnex13.R") run this if you don't have Rdata below
load( file=file.path(getwd(),"data_dependencies","annex13.Rdata")) # annexes13_method,annexes13_traceability,annexes13_management,

eu_cou_codes=c("AT",	"BE",	"BG",	"HR",	"CY",	"CZ",	"DK",	"EE",	"FI",	"FR",	"DE",	"GR",	"HU",	"IE",	"IT",	"LV",	"LT",	"LU",	"MT",	"NL",	"PL",	"PT",	"RO",	"SK",	"SI",	"ES",	"SE",	"GB")

emu_sea= emu_p %>%
  filter(emu_cou_code %in% eu_cou_codes) %>%
  mutate(rec_zone = ifelse(emu_cou_code %in% c("NL","DK","NO","BE","LU", "CZ","SK") |
                             emu_nameshort %in% c("FR_Rhin","FR_Meus","GB_Tham","GB_Angl","GB_Humb","GB_Nort","GB_Solw",
                                                  "DE_Ems","DE_Wese","DE_Elbe","DE_Rhei","DE_Eide","DE_Maas") ,
                           "NS", 
                           ifelse(emu_cou_code %in% c("EE","FI","SE","LV","LT","AX", "PL","DE"),
                                  "BA",
                                  "EE")))


mor_wise = annexes13_method %>% select(emu_nameshort,mortality_wise)
mor_wise = merge(emu_sea %>% st_drop_geometry(),mor_wise)
mor_wise <- mor_wise %>% mutate(cohort_wise=grepl("ohort",mortality_wise)) %>%
  mutate(emu_nameshort = ifelse(emu_nameshort == "NL_Neth","NL_total",emu_nameshort))
load("../../R/shiny_data_visualisation/shiny_dv/data/recruitment/dat_ge.Rdata")
load("../../R/shiny_data_visualisation/shiny_dv/data/recruitment/dat_ye.Rdata")



estimate_b0 = function(emu, year, mor_wise,precodata){
  mod = switch(unique(mor_wise$rec_zone[mor_wise$emu_nameshort == emu]),
               "EE" = dat_ge %>% filter (area == "Elsewhere Europe"),
               "NS" = dat_ge %>% filter (area == "North Sea"),
               "BA" = dat_ye)
  if ("value_std_1960_1979" %in% names(mod)){
    Rcurrent <- mean(mod$value_std_1960_1979[mod$year %in% ((year-4):year)])
  } else {
    Rcurrent <- mean(mod$p_std_1960_1979[mod$year %in% ((year-4):year)])
  }
  if (unique(mor_wise$cohort_wise[mor_wise$emu_nameshort==emu]))
    Rcurrent <- switch(mor_wise$rec_zone[mor_wise$emu_nameshort == emu],
                       "EE" = mean(mod$p_std_1960_1979[mod$year %in% ((year-12):(year-7))]),
                       "NS" = mean(mod$p_std_1960_1979[mod$year %in% ((year-17):(year-12))]),
                       "BA" = mean(mod$value_std_1960_1979[mod$year %in% ((year-22):(year-17))]))
  precodata$bbest[precodata$eel_emu_nameshort==emu & precodata$eel_year==year] / Rcurrent
}

indicator_sub <- indicator %>%
  filter(eel_emu_nameshort %in% unique(mor_wise$emu_nameshort))
indicator_sub$b0_adj = mapply(estimate_b0,indicator_sub$eel_emu_nameshort, indicator_sub$eel_year,
                                MoreArgs=list(mor_wise=mor_wise,precodata=indicator_sub))

options(scipen = 999)
indicator <- indicator %>% left_join(indicator_sub %>% select(eel_year, eel_emu_nameshort, b0_adj), by = c("eel_year", "eel_emu_nameshort"))

invisible(capture.output(Kendall_bio_b0 <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                  mutate(ratio = bcurrent/b0) %>%
                  filter(eel_year >= 2010) %>%
                  select(eel_emu_nameshort, eel_year, ratio) %>%
                  drop_na(ratio)%>%
                  group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                  pivot_wider(names_from = eel_emu_nameshort, values_from = ratio) %>%
                  arrange(eel_year) %>%
                  select(-eel_year), 
                  function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

invisible(capture.output(Kendall_bio_b0_adj <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                      mutate(ratio = bcurrent/b0_adj) %>%
                      filter(eel_year >= 2010) %>%
                      select(eel_emu_nameshort, eel_year, ratio) %>%
                      drop_na(ratio)%>%
                      group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                      pivot_wider(names_from = eel_emu_nameshort, values_from = ratio) %>%
                      arrange(eel_year) %>%
                      select(-eel_year), 
                      function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))



Kendall_bio_tab <-  indicator %>%
                    group_by(eel_emu_nameshort) %>%
                    filter(eel_year >= 2010) %>%
                    mutate(ratio_b0 = bcurrent/b0,
                      ratio_b0_adj = bcurrent/b0_adj) %>%
                    mutate(Period = paste(min(eel_year), max(eel_year), sep = "-"),
                      n_b0 = length(ratio_b0[!is.na(ratio_b0)]),
                      n_b0_adj = length(ratio_b0_adj[!is.na(ratio_b0_adj)]),
                      Esc_perc_b0_2010 = round(ratio_b0[which.min(eel_year)], 3),
                      Esc_perc_b0_current = round(ratio_b0[which.max(eel_year)], 3),
                      Delta_b0 = ratio_b0[which.max(eel_year)] - ratio_b0[which.min(eel_year)],
                      Delta_b0_adj = ratio_b0_adj[which.max(eel_year)] - ratio_b0_adj[which.min(eel_year)]) %>%
                    filter(eel_year == max(eel_year) | eel_year == min(eel_year)) %>%
                    select(eel_emu_nameshort, Period, n_b0, n_b0_adj, Esc_perc_b0_2010, Esc_perc_b0_current, Delta_b0, Delta_b0_adj) %>%
                    unique() %>%
                    ungroup() %>%
                    arrange(eel_emu_nameshort) %>%
                    left_join(Kendall_bio_b0, by = "eel_emu_nameshort") %>%
                    rename(p_b0 = sl,
                      Tau_b0 = tau,
                      Denominator_b0 = D,
                      Score_b0 = S,
                      VarScore_b0 = varS) %>%
                    mutate(Delta_b0 = round(Delta_b0, 3),
                      p_b0 = round(p_b0, 3),
                      Tau_b0 = round(Tau_b0, 3),
                      Denominator_b0 = round(Denominator_b0, 0),
                      VarScore_b0 = round(VarScore_b0, 3)) %>%
                  left_join(Kendall_bio_b0_adj, by = "eel_emu_nameshort") %>%
                  rename(p_b0_adj = sl,
                    Tau_b0_adj = tau,
                    Denominator_b0_adj = D,
                    Score_b0_adj = S,
                    VarScore_b0_adj = varS) %>%
                  mutate(Delta_b0_adj = round(Delta_b0_adj, 3),
                    p_b0_adj = round(p_b0_adj, 3),
                    Tau_b0_adj = round(Tau_b0_adj, 3),
                    Denominator_b0_adj = round(Denominator_b0_adj, 0),
                    VarScore_b0_adj = round(VarScore_b0_adj, 3)) %>% 
                    filter_at(vars(Esc_perc_b0_2010, Esc_perc_b0_current, Delta_b0, Delta_b0_adj, Tau_b0, Tau_b0_adj), any_vars(!is.na(.))) 


flextable(Kendall_bio_tab %>%
            rename(EMU = eel_emu_nameshort) %>%
            mutate(Tau_b0 = ifelse(p_b0 <= 0.1, 
                            ifelse(p_b0 <= 0.05, paste(Tau_b0, "**"), paste(Tau_b0, "*")), as.character(Tau_b0)))  %>%
            mutate(Tau_b0_adj = ifelse(p_b0_adj <= 0.1,
                               ifelse(p_b0_adj <= 0.05, paste(Tau_b0_adj, "**"), paste(Tau_b0_adj, "*")), as.character(Tau_b0_adj)))  %>%
            select(EMU, Period, n_b0, n_b0_adj, Esc_perc_b0_2010, Esc_perc_b0_current, Delta_b0, Delta_b0_adj, Tau_b0, Tau_b0_adj) %>%
            mutate_all(~ifelse(is.nan(.), NA, .))) %>%
            autofit()

```

[*] indicates p > 0.1\
[**] indicates p > 0.05



## Mortality

Time trend analyses are carried out on the mortalites suma, sumf and sumh - as indicated by suffixes.\ 
The following restraints were defined for trend analyses:   
1. Only values after 2010 (Implementation of Eel regulation) were considered\
2. Time Series need to have at least 5 observations

Delta gives the difference between the initial (2010) and current (latest year reported) suma, sumf or sumh - as indicated by suffixes. The value thus indicates a quantitative measure of the change in mortality, whereas Tau gives a qualitative estimate on whether the trend is positive/negative and significant (also see table footnote).


```{r trendmortalitytable}

invisible(capture.output(Kendall_suma <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                  filter(eel_year >= 2010) %>%
                  select(eel_emu_nameshort, eel_year, suma) %>%
                  drop_na(suma)%>%
                  group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                  pivot_wider(names_from = eel_emu_nameshort, values_from = suma) %>%
                  arrange(eel_year) %>%
                  select(-eel_year), 
                  function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

invisible(capture.output(Kendall_sumf <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                  filter(eel_year >= 2010) %>%
                  select(eel_emu_nameshort, eel_year, sumf) %>%
                  drop_na(sumf)%>%
                  group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                  pivot_wider(names_from = eel_emu_nameshort, values_from = sumf) %>%
                  arrange(eel_year) %>%
                  select(-eel_year), 
                  function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

invisible(capture.output(Kendall_sumh <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                  filter(eel_year >= 2010) %>%
                  select(eel_emu_nameshort, eel_year, sumh) %>%
                  drop_na(sumh)%>%
                  group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                  pivot_wider(names_from = eel_emu_nameshort, values_from = sumh) %>%
                  arrange(eel_year) %>%
                  select(-eel_year), 
                  function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

Kendall_mort_tab <- indicator %>%
                    group_by(eel_emu_nameshort) %>%
                    filter(eel_year >= 2010) %>%
                    mutate(Period = paste(min(eel_year), max(eel_year), sep = "-"),
                      n_suma = length(suma[!is.na(suma)]),
                      n_sumf = length(sumf[!is.na(sumf)]),
                      n_sumh = length(sumh[!is.na(sumh)]),
                      suma_initial = round(suma[which.min(eel_year)], 3),
                      suma_current = round(suma[which.max(eel_year)], 3),
                      Delta_suma = suma[which.max(eel_year)] - suma[which.min(eel_year)],
                      Delta_sumf = sumf[which.max(eel_year)] - sumf[which.min(eel_year)],
                      Delta_sumh = sumh[which.max(eel_year)] - sumh[which.min(eel_year)]) %>%
                    filter(eel_year == max(eel_year) | eel_year == min(eel_year)) %>%
                    select(eel_emu_nameshort, Period, suma_initial, suma_current,  n_suma, n_sumf, n_sumh, Delta_suma, Delta_sumf, Delta_sumh) %>%
                    unique() %>%
                    ungroup() %>%
                    arrange(eel_emu_nameshort) %>%
                    left_join(Kendall_suma, by = "eel_emu_nameshort") %>%
                    rename(p_suma = sl,
                      Tau_suma = tau,
                      Denominator_suma = D,
                      Score_suma = S,
                      VarScore_suma = varS) %>%
                    mutate(Delta_suma = round(Delta_suma, 3),
                      p_suma = round(p_suma, 3),
                      Tau_suma = round(Tau_suma, 3),
                      Denominator_suma = round(Denominator_suma, 0),
                      VarScore_suma = round(VarScore_suma, 3)) %>%
                  left_join(Kendall_sumf, by = "eel_emu_nameshort") %>%
                    rename(p_sumf = sl,
                      Tau_sumf = tau,
                      Denominator_sumf = D,
                      Score_sumf = S,
                      VarScore_sumf = varS) %>%
                    mutate(Delta_sumf = round(Delta_sumf, 3),
                      p_sumf = round(p_sumf, 3),
                      Tau_sumf = round(Tau_sumf, 3),
                      Denominator_sumf = round(Denominator_sumf, 0),
                      VarScore_sumf = round(VarScore_sumf, 3)) %>% 
                  left_join(Kendall_sumh, by = "eel_emu_nameshort") %>%
                    rename(p_sumh = sl,
                      Tau_sumh = tau,
                      Denominator_sumh = D,
                      Score_sumh = S,
                      VarScore_sumh = varS) %>%
                    mutate(Delta_sumh = round(Delta_sumh, 3),
                      p_sumh = round(p_sumh, 3),
                      Tau_sumh = round(Tau_sumh, 3),
                      Denominator_sumh = round(Denominator_sumh, 0),
                      VarScore_sumh = round(VarScore_sumh, 3)) %>% 
                      filter_at(vars(Delta_suma, Delta_sumf, Delta_sumh, Tau_suma, Tau_sumf, Tau_sumh), any_vars(!is.na(.))) 


flextable(Kendall_mort_tab %>%
            rename(EMU = eel_emu_nameshort) %>%
            mutate(Tau_suma = ifelse(p_suma <= 0.1, 
                            ifelse(p_suma <= 0.05, paste(Tau_suma, "**"), paste(Tau_suma, "*")), as.character(Tau_suma)))  %>%
            mutate(Tau_sumf = ifelse(p_sumf <= 0.1,
                               ifelse(p_sumf <= 0.05, paste(Tau_sumf, "**"), paste(Tau_sumf, "*")), as.character(Tau_sumf)))  %>%
            mutate(Tau_sumh = ifelse(p_sumh <= 0.1,
                               ifelse(p_sumh <= 0.05, paste(Tau_sumh, "**"), paste(Tau_sumh, "*")), as.character(Tau_sumh)))  %>%
            select(EMU, Period, suma_initial, suma_current, n_suma, n_sumf, n_sumh, 
                   Delta_suma, Delta_sumf, Delta_sumh, Tau_suma, Tau_sumf, Tau_sumh) %>%
            mutate_all(~ifelse(is.nan(.), NA, .))) %>%
            autofit()

```

[*] indicates 0.05 < p < 0.1\
[**] indicates p < 0.05



# Test for effect of measures
## Fisher's exact test for all measures

Fisher's exact test for all EMUs where respective measures were implemented. The test is performed on measure type (10 types, but no data for 2 of them) x count of EMUs with an effect / no effect on either SumA, SumF, SumH or bcurr/b0 adjusted (=b0_adj). The result indicates whether an effect on either parameter was independent (=null hypothesis) of the measure type.\

_-_Result for b0 is interesting, eel governance seems to have an effect (tested specifically for this measure it is significant, see below), but overall b0 does not seem to dependend on measure type. Is that because "stochastically this is expected" (at 0.05 one in 20 would show dependence coincidentally, right?) / is the power not good. Not sure it makes sense or I make sense;) ..._

_Need to check if this makes sense, since the EMUs for the different measures are not the same but those where the respective measure was implemented_

```{r Fisher_all}

load("./data_dependencies/Annex15.Rdata")

counts <- res %>% 
  group_by(emu_name_short) %>%
  count(measure_type)

measures <- expand.grid(EMU = unique(res$emu_name_short),
            measure_type = unique(res$measure_type)) %>%
            left_join(counts, by=c("EMU" = "emu_name_short", "measure_type" = "measure_type")) %>%
            replace(is.na(.), 0) %>%
            mutate(binary_measure = ifelse(n == 0 , 0 , 1),
                   n = NULL) %>%
            left_join(Kendall_mort_tab %>% select(eel_emu_nameshort, p_suma, p_sumf, p_sumh, Tau_suma, Tau_sumf, Tau_sumh), by = c("EMU" = "eel_emu_nameshort")) %>%
            left_join(Kendall_bio_tab %>% select(eel_emu_nameshort, p_b0, p_b0_adj, Tau_b0, Tau_b0_adj), by = c("EMU" = "eel_emu_nameshort")) %>%
            mutate(sumA = ifelse(p_suma < 0.1 & Tau_suma < 0, 1, 0),
                   sumF = ifelse(p_sumf < 0.1 & Tau_sumf < 0, 1, 0),
                   sumH = ifelse(p_sumh < 0.1 & Tau_sumh < 0, 1, 0),
                   b0 = ifelse(p_b0 < 0.1 & Tau_b0 > 0, 1, 0),
                   b0_adj = ifelse(p_b0_adj < 0.1 & Tau_b0_adj > 0, 1, 0))

Fisher_sumA <- measures %>%
  mutate(measure_type = str_replace(measure_type, "Recreational fishery", "Recreational_fishery")) %>%
  filter(binary_measure == 1) %>%
  group_by(measure_type, sumA) %>%
  summarise(effect = n(), .groups = "keep") %>%
  spread(sumA, effect) %>%
  rename(effect = "1",
         no_effect = "0") %>%
  mutate("<NA>" = NULL) %>%
  drop_na() %>%
  mutate(total = sum(effect, no_effect),
         percentage = effect/total*100) %>%
  relocate(effect, .after = measure_type)

Fisher_sumF <- measures %>%
  mutate(measure_type = str_replace(measure_type, "Recreational fishery", "Recreational_fishery")) %>%
  filter(binary_measure == 1) %>%
  group_by(measure_type, sumF) %>%
  summarise(effect = n(), .groups = "keep") %>%
  spread(sumF, effect) %>%
  rename(effect = "1",
         no_effect = "0") %>%
  mutate("<NA>" = NULL) %>%
  drop_na() %>%
  mutate(total = sum(effect, no_effect),
         percentage = effect/total*100) %>%
  relocate(effect, .after = measure_type)

Fisher_sumH <- measures %>%
  mutate(measure_type = str_replace(measure_type, "Recreational fishery", "Recreational_fishery")) %>%
  filter(binary_measure == 1) %>%
  group_by(measure_type, sumH) %>%
  summarise(effect = n(), .groups = "keep") %>%
  spread(sumH, effect) %>%
  rename(effect = "1",
         no_effect = "0") %>%
  mutate("<NA>" = NULL) %>%
  drop_na() %>%
  mutate(total = sum(effect, no_effect),
         percentage = effect/total*100) %>%
  relocate(effect, .after = measure_type)

Fisher_b0_adj <- measures %>%
  mutate(measure_type = str_replace(measure_type, "Recreational fishery", "Recreational_fishery")) %>%
  filter(binary_measure == 1) %>%
  group_by(measure_type, b0_adj) %>%
  summarise(effect = n(), .groups = "keep") %>%
  spread(b0_adj, effect) %>%
  rename(effect = "1",
         no_effect = "0") %>%
  mutate("<NA>" = NULL) %>%
  drop_na() %>%
  mutate(total = sum(effect, no_effect),
         percentage = effect/total*100) %>%
  relocate(effect, .after = measure_type)

flextable(Fisher_sumA) %>% autofit() %>% set_caption(caption = paste("sumA, p =", round((fisher.test(Fisher_sumA[,c(2,3)])$p.value), 3)))
flextable(Fisher_sumF) %>% autofit() %>% set_caption(caption = paste("sumF, p =", round((fisher.test(Fisher_sumF[,c(2,3)])$p.value), 3)))
flextable(Fisher_sumH) %>% autofit() %>% set_caption(caption = paste("sumH, p =", round((fisher.test(Fisher_sumH[,c(2,3)])$p.value), 3)))
flextable(Fisher_b0_adj) %>% autofit() %>% set_caption(caption = paste("b0 adjusted, p =", round((fisher.test(Fisher_b0_adj[,c(2,3)])$p.value), 3)))

```



## Fisher's exact test per measure

Fishers exact test is performed on a 2x2 matrix per measure, i.e. count of EMUs wher measure is implemented / not implemented x count of EMus with an effect / no effect on either SumA, SumF, SumH or bcurr/b0 adjusted (=b0_adj). The test indicates whether an effect on either parameter was independent (= null hypothesis) of the implementation of the respective measure type. 

```{r Fisher_by_measure}

fisher_sumA <- measures %>% 
                     group_by(measure_type, binary_measure, sumA) %>%
                     summarise(value = n()) %>%
                     mutate(binary_measure = str_replace(binary_measure, "0", "not_implemented"),
                            binary_measure = str_replace(binary_measure, "1", "implemented")) %>%
                     drop_na() %>%
                     mutate(indicator = paste(binary_measure, sumA, sep = "_")) %>%
                     ungroup() %>%
                     select(-binary_measure, - sumA) %>%
                     spread(indicator, value) %>%
                     drop_na()
 
fisher_sumA$p_value <- apply(fisher_sumA, 1 ,function(x) {
                                        tbl <- matrix(as.numeric(x[2:5]), ncol=2, byrow=T)
                                        fisher.test(tbl)$p.value
                                        })

######################################

fisher_sumF <- measures %>% 
                     group_by(measure_type, binary_measure, sumF) %>%
                     summarise(value = n()) %>%
                     mutate(binary_measure = str_replace(binary_measure, "0", "not_implemented"),
                            binary_measure = str_replace(binary_measure, "1", "implemented")) %>%
                     drop_na() %>%
                     mutate(indicator = paste(binary_measure, sumF, sep = "_")) %>%
                     ungroup() %>%
                     select(-binary_measure, - sumF) %>%
                     spread(indicator, value) %>%
                     drop_na()
 
fisher_sumF$p_value <- apply(fisher_sumF, 1 ,function(x) {
                                        tbl <- matrix(as.numeric(x[2:5]), ncol=2, byrow=T)
                                        fisher.test(tbl)$p.value
                                        })

######################################
                                        
fisher_sumH <- measures %>% 
                     group_by(measure_type, binary_measure, sumH) %>%
                     summarise(value = n()) %>%
                     mutate(binary_measure = str_replace(binary_measure, "0", "not_implemented"),
                            binary_measure = str_replace(binary_measure, "1", "implemented")) %>%
                     drop_na() %>%
                     mutate(indicator = paste(binary_measure, sumH, sep = "_")) %>%
                     ungroup() %>%
                     select(-binary_measure, - sumH) %>%
                     spread(indicator, value) %>%
                     drop_na()
 
fisher_sumH$p_value <- apply(fisher_sumH, 1 ,function(x) {
                                        tbl <- matrix(as.numeric(x[2:5]), ncol=2, byrow=T)
                                        fisher.test(tbl)$p.value
                                        })

######################################  

fisher_b0_adj <- measures %>% 
                     group_by(measure_type, binary_measure, b0_adj) %>%
                     summarise(value = n()) %>%
                     mutate(binary_measure = str_replace(binary_measure, "0", "not_implemented"),
                            binary_measure = str_replace(binary_measure, "1", "implemented")) %>%
                     drop_na() %>%
                     mutate(indicator = paste(binary_measure, b0_adj, sep = "_")) %>%
                     ungroup() %>%
                     select(-binary_measure, - b0_adj) %>%
                     spread(indicator, value) %>%
                     drop_na()
 
fisher_b0_adj$p_value <- apply(fisher_b0_adj, 1 ,function(x) {
                                        tbl <- matrix(as.numeric(x[2:5]), ncol=2, byrow=T)
                                        fisher.test(tbl)$p.value
                                        })

flextable(fisher_sumA) %>% autofit() %>% set_caption(caption = "sumA")
flextable(fisher_sumF) %>% autofit() %>% set_caption(caption = "sumF")
flextable(fisher_sumH) %>% autofit() %>% set_caption(caption = "sumH")
flextable(fisher_b0_adj) %>% autofit() %>% set_caption(caption = "b0 adj")
```

