---
title: "WKEELMIGRATION SEASONALITY DATA TREATMENT"
author: "Cédric Briand, Jan Dag Pohlmann, Estibaliz diaz and Hilaire Drouineau, "
date: "january 2020"
output: html_document
---

```{r launch, echo=FALSE, include=FALSE}
require(knitr)
opts_knit$set(eval.after = 'fig.cap') # to be used in chunks used only to plot pictures
knitr::opts_chunk$set(echo=FALSE)
options(knitr.table.format = 'html') # options pour kable
options(knitr.kable.NA = '.')
setwd("C:\\workspace\\gitwgeel\\Misc\\wkeelmigration\\")
source("..\\..\\R\\utilities\\load_library.R")
source("functions.R")
load_package("readxl")
load_package("stringr")
load_package("pool")
load_package("DBI")
load_package("RPostgreSQL")
load_package("glue")
load_package("sqldf")
load_package("tidyverse")
load_package("ggforce") # better circular plots using ggplot
load_package("printr")

source("..\\..\\R\\shiny_data_integration\\shiny_di\\loading_functions.R")
source("..\\..\\R\\shiny_data_integration\\shiny_di\\database_reference.R") # extract_ref
load(file=str_c("C:\\workspace\\gitwgeel\\R\\shiny_data_integration\\shiny_di","\\common\\data\\init_data.Rdata"))  
datawd <- "C:\\Users\\cedric.briand\\OneDrive - EPTB Vilaine\\Projets\\GRISAM\\2020\\wkeemigration\\source\\"
datawd1 <- "C:\\Users\\cedric.briand\\OneDrive - EPTB Vilaine\\Projets\\GRISAM\\2020\\wkeemigration\\Treated commercial\\"

imgwd <- "C:\\workspace\\wgeeldata\\wkeelmigration\\image\\"

library("sf")
library("ggspatial")

dsn <-  paste0("PG:dbname='wgeel' host='localhost' port ='5436'",
		" user='", userlocal,
		"' password='", passwordlocal,"'")
```

# preparing the files

### BE

* No monthly data => remove the file

### DE
* Data for DE_Elbe is pretty much incomplete since only one state reported
  monthly catches. Thus, they are good for relative changes but we have to keep
  track that the absolute numbers are wrong for the EMU - Delete or use?
* Many rows reported as ND,NR,NM etc., with "WHOLE YEAR". -> We will not use
  those anyway, so I deleted them. However, as discussed so many times, this
  information is useful in the sense of knowing that it is not 0-catch, but e.g.
  no monthly data available. (Anyway, we have the original file stored if we
  want to use these information...) 

### ES
* ES_Anda was missing, I have add it. (No data before 2009 and forbidden later).
  In ES_Murc there is monthly data from 2002 on. For 2000 and 2001 data for the
  whole year has been provided. I have leaveD it.


### FI
* Total Landings for the whole country (EMU).  NO edits for the rest, it can be
  used


### FR
FR_Meus, FR_Rhin missing. I guess this is because they are international bassins
withoufh fishery (CEDRIC Confirm, there is no commercial fishery there). NO
edits for the rest, it can be used

### GB
* data for lough neagh not reported monthly -> Derek will provide monthly data
  for Y after Jan 20th, thus for now, the Neagh entries were deleted and a
  seperate file will be provided once available.
* data on Y&S is reported for GB_Total from 2011-2013 -> Assume there is no EMU
  data thus summed for all but GB_Scot & GB_neag, but sent an email to clarify.
  How to treat these? -> confirmed, left it in the sheet as GB_total  
* habitat is defined as NR for a lot of the data, if its unknown what are we
  going to do? -> Check with Cedric if we use those data (Cédric => I would say
  very probably not, if it's there we have it and can compare later on with what
  we have in the database for landings through shiny app, if not then it's
  probably not very important). I have sent an email to Ryan ". I guess that the
  problem is that you do not know where the catches happened exactly; if this is
   the case I´d suggest to writte “FTC” since it includes all the possible
  habitats" and he has agreed 

Jan-Dag: After habitat was recorded, GB_Dee is the only EMU with T, thus I'd
suggest using FC for the other EMUs before 2011. Also, after habitat was
recorded, all glass eel fisheries have habitat "F", so I'd suggest using only F
for glass eel fisheries before 2011. All others FC. -> Awaiting confirmation
from Ryan.
 
* glass eel catch data is reported for whole year (season Feb to May) in GB
  since 2014 for several EMUs -> deleted entries, except if it was 0, then
  converted to respective month according to comment
* GB_NorW was missing in the EMU list and was added to this sheet -> Cedric,
  does the EMU exist in the database? => Yes
* WAITING FOR AN ANSWER -> Jan-Dag: I have the file prepared and will upload it
  once clarified

### HR
* data for 2018 is preliminary, which I think we don't want. -> delete these
  rows? (wasn't done by me)
* otherwise no edits needed 

### IE
* no edits needed. Esti: I  have deleted some extra "0"s in the rows below and
  changed some months with lower case to upper case

### DK

* data for 2019 is preliminary, which I think we don't want. -> delete these
  rows? (wasn't done by me)
* otherwise no edits needed 

### LTU
* I have sent this mail to Arvydas: in some "eel_value" rows there was a "0" in
  places where "eel_missvaluequal" was NC or NR. I have deleted those "0"s,
  since this would mean 0 catches, not no data. I have found that in the T -
  Curonian Lagoon for some months (Jan, Feb, March, Nov and DEC) you have
  included 0 catches. I have checked the closure document, and I have seen that
  the fishery is closed during this months. Therefore, I think that it would be
  more correct not to include this months, (o catches means you have gone
  fishing and your catches have been 0. Please let me know if I´m correct.
  Arvydas´s answer: The main fishing gear for eel in the Curonian Lagoon is eel
  Fyke nets, fishing period are from April to October. The catch of eel depends
  on natural conditions. The water temperature is very low between November and
  March in Curonian Lagoon, which makes the eels passive and its does not
  migrate. But at the this  time (autumn, winter) in Curonian Lagoon fishermen
  used small mesh size traps for fishing for lamprey and smelt, and eels are
  sometimes caught like bycatch.  Eels are recorded by fishermen, so they appear
  in the statistics  (a few kilograms). But I agree that it would be more
  correct not to include this months. On the other hand, the increase  eel
  catches in November reflects climate change.SO i´LL DELETE Jan, Feb, March,
  Nov and DEC) 
* In some cases they have included data by month and also a total by year adding
  up all those months. I deleted the total because it duplicated the
  information.  
* In some cases, they don't have data by month and put "NC" or "ND" and then for
  the same year they do include whole year data. I deleted the NC and ND for
  months and left the annual data. 

### LV
* I have sent this mail to Janis. In the case of Latvia there was not a contact
  person to check the data, so I though you might be related to that.  In this
  way, I wanted to check with you that “0” catches is correct. You have included
  0 catches during oct, nov, dec, jan, feb, marc, apr. 0 catches mean that
  fisher have gone fishing and their catches have been 0. Is that the case? If
  the fishery was closed during these months you should write NP (no pertinent
  ). I have checked the closures files and they only describe closures during
  2018 and 2019 and they only mention closures during nov, dic, jan. Could you
  clarify please if the 0 s correspond to 0 catches or to a fishery closure?
  ANSWER: Yes, that is correct - 0 catches mean that fisher have gone fishing
  and their catches have been 0. There is no eel speciffic fisheries in coastal
  waters  - eel is a bycatch. In fresh waters also many fishermen use fyke nets
  and focus on multiple species, only some use eel specific gear. SO NO CHANGES
  NEEDED
* LV_Latv changed to LV_tota

### NL
* There are 0s in the catches, but they vary from year to year, so I understand
  that they do not correspond to closures in the fishery.
* I have changed  from NL_Neth  to NL_total
* ICes area was not included and I have included it =>(Cédric unless we are
  dealing with coastal or marine areas corresponding to ICES division, and I
  don't think we will have much of those, I don't think we are gonna use the
  ICES area). 

### NO
* I have found that eel_lfs_code is missing in some rows (see attached).
  Caroline has asked me to include YS in those cases
* I have sent a mail to Caroline to confirm that "0"s correspond to real 0
  catches. ANSWER FROM CAROLINE: "The fishery closed starting in from 2011. It
  opened partially in 2016 (and it is still the same today): to only a few
  fishers which could fish from July to October." and me answer "SO I understand
  that for the 2011-2015 period I should change the “0” catches to NP( this
  means that fishery was closed) and the rest of the 0s really mean 0 cacthes
  (there was a a fishery activity but catches were 0). Right?" ANSWER: right

### PL
* Data for the 2000-2003 is tagged as low quality. Should we use it?

### SE
* Message for Josephine , I have found that eel_lfs_code is missing in some rows
  (see attached). What should I include?. Answer from Josephine: "Also, if
  lifestage is also missing in certain places, that too would be because it’s
  missing in the original file, i.e. in the data we get from Swam. This is not
  an easy fix problem but Swam are at least aware that their data is far from
  perfect and they are working on improving their database, but that does not
  help us now. I’m sorry I don’t have a better answer to this…". So I have
  deleted the rows that do not contain life stage


# reading the files


```{r readfiles, echo=TRUE, include=TRUE}
fcl <- list.files(datawd1,pattern='commercial_landings')
load( file=str_c(datawd,"saved_data.Rdata"))
load(file=str_c(datawd,"cou.Rdata"))

datasource <- "wkeelmigration"
list_seasonality <- list()
for (f in fcl){
	# f <- fcl[1]
	path <- str_c(datawd1,f)	
	file<-basename(path)
	mylocalfilename<-gsub(".xlsx","",file)
	country <- substring(mylocalfilename,1,2)
	list_seasonality[[mylocalfilename]] <-	load_landings(path, datasource)
}

# list_seasonality is a list with all data sets (readme, data, series) as elements of the list
# below we extract the list of data and bind them all in a single data.frame
# to do so, I had to constrain the column type during file reading (see functions.R)
res <- map(list_seasonality,function(X){			X[["data"]]		}) %>% 
		bind_rows()
Hmisc::describe(res)

print(res[is.na(res$eel_emu_nameshort),],n=1000)
# all NA print(res[is.na(res$eel_emu_nameshort),],n=1000)
res <- res[!is.na(res$eel_emu_nameshort),]
# describe file again
Hmisc::describe(res)
# All ND, NP or NM
print(res[is.na(res$eel_value),],n=40)
# removing those rows
res <- res[!is.na(res$eel_value),]
nrow(res) 

unique(res$eel_month)
res$eel_month <- tolower(res$eel_month)
# removing whole year and missing year
resw <- res[res$eel_month%in%c("whole year"),]
#print(resw,n=72)
# ONLY GB_Neag and this is whole_year not remain year
resr <- res[res$eel_month%in%c("remain year"),]
print(resr,n=203)
res <-res[!res$eel_month%in%c("whole year", "remain year"),]
res$eel_month <- recode(res$eel_month, 
		"mar"=3, 
		"apr"=4, 
		"may"=5, 
		"jun"=6,
		"jul"=7,
		"aug"=8,
		"sep"=9,
		"oct"=10,
		"nov"=11,
		"dec"=12, 
		"jan"=1, 
		"feb"=2
)
Hmisc::describe(res$eel_month)
# number of data per emu
res %>% mutate("freq"=1) %>% filter(eel_year>2000 & eel_year<2019) %>%
#xtabs ( formula=freq ~ eel_year + eel_month +eel_emu_nameshort)


test <- res %>% mutate("freq"=1) %>% filter(eel_year>2000 & eel_year<2019) %>%
		xtabs ( formula=freq ~ eel_year + eel_month +eel_emu_nameshort +eel_lfs_code)%>%
		as.data.frame() %>% filter(Freq>2) 

# check those
```




