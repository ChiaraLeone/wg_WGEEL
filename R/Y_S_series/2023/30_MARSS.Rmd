### MARSS

```{r load libraries, include=FALSE}
source("../../utilities/load_library.R")
load_library("MARSS")
load_library("gridExtra")
load_library("xtable")
load_library("getPass")
load_library("RPostgres")
load_library("sf")
load_library("flextable")
load_library("broom")
load_library("eulerr")
load_library("dplyr")
load_library("knitr")
load_library("ggplot2")
load_library("ggmap")
load_library("tidyverse")
load_library("rnaturalearth")
load_library("parallel")
load_library("kableExtra")
load_library("mgcv")
load_library("ggmap")
load_library("ggrepel")
load_library("grid")
load_library("flextable")
load_library("yaml")
```


```{r widen data, include=FALSE}

# Indexes giving how serie ids relate to habitat type, restocking and ecoregions
subpop_fct <- d.cpue %>%
  select("ser_nameshort","ser_hty_code","ser_restocking","ecoregion") %>%
unique()

# Wide format of silver eel data
S_data <- d.cpue %>%
  select("das_year","ser_nameshort","das_value") %>% 
  complete(das_year,ser_nameshort) %>% # add na´s to non existing years
pivot_wider(names_from=ser_nameshort,values_from = das_value) # wide format

# Rearrange data for fitting MARSS model
Years <- S_data$das_year
S_ts <- S_data[,names(S_data)!="das_year"]
S_ts <- t(S_ts) # transpose matrix
S_ts <- S_ts[subpop_fct$ser_nameshort,] # rearrange row order(same as subpop_fct)
S_ts <- log(S_ts) # log data
S_ts[is.infinite(S_ts)] <- -15

n_series <- nrow(S_ts)

```


```{r Create MARSS model structure, silent=true}

# H1: panmictic population
Z1 <- factor(rep("pan", n_series))

# H2: Habitat type
Z2 <- factor(subpop_fct$ser_hty_code)

# H3: Restocking
Z3 <- factor(subpop_fct$ser_restocking)

# H4: Ecoregion
Z4 <- factor(subpop_fct$ecoregion)

# H5: North Sea vs. Elsewhere europe
Z5 <- factor(ifelse(subpop_fct$ecoregion %in% c("Greater North Sea", "Celtic Sea"), "North Sea", "Elsewhere Europe"))

# all models
Z.models <- list(Z1, Z2, Z3, Z4, Z5)
names(Z.models) <-
c("panmictic", "Habitat type", "Restocking", "Ecoregion", "North Sea vs. elsewhere europe")

# test with different Q models(i.e. different process errors)
Q.models <- c("diagonal and equal", "diagonal and unequal")

# Model parameters(the same across  all models) 
U.model <- "unequal"
R.model <- "diagonal and equal"
A.model <- "scaling"
B.model <- "identity"
x0.model <- "unequal"
V0.model <- "zero"
model.constant <- list(
U = U.model, R = R.model, A = A.model,
x0 = x0.model, V0 = V0.model, tinitx = 0
)

```

```{r Fit MARSS models, silent=TRUE}
out.tab <- NULL
fits <- list()
for (i in c(1,4,5)) { #1:length(Z.models))
for (Q.model in Q.models) {
fit.model <- c(list(Z = Z.models[[i]], Q = Q.model), model.constant)
fit <- MARSS(S_ts,
model = fit.model,
silent = TRUE, control = list(maxit = 1000)
)
out <- data.frame(
H = names(Z.models)[i], Q = Q.model, U = U.model,
logLik = fit$logLik, AICc = fit$AICc, num.param = fit$num.params,
m = length(unique(Z.models[[i]])),
num.iter = fit$numIter, converged = !fit$convergence,
stringsAsFactors = FALSE
)
out.tab <- rbind(out.tab, out)
fits <- c(fits, list(fit))
if (i == 1) next # one m for panmictic so only run 1 Q
}
}

```
```{r plot time series}

```


