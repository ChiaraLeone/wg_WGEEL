---
title: "DFA yellow and silver eels"
author: "ICES Data Group"
date: "`r format(Sys.time(), '%Y %B %d')`"
bibliography: references_dfa.bib
documentclass: article
output: 
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    reference_docx: "../Rmarkdown/ICES_template.docx" 
params:
  rerunDFA: FALSE
csl: "../Rmarkdown/ices-journal-of-marine-science.csl"

---


```{r setup, include=FALSE}
source("../utilities/load_library.R")

knitr::opts_chunk$set(echo = TRUE,warning=FALSE,message=FALSE,fig.width=14.9/2.54,dpi=300,
                      fig.height=10/2.54)
username = Sys.info()[["user"]]
if (username=="hilaire.drouineau"){
  setwd("/home/hilaire.drouineau/Documents/Bordeaux/migrateurs/WGEEL/github/wg_WGEEL/R/Y_S_series/")
}
load_library("gridExtra")
load_library("MARSS")
load_library("xtable")
load_library("getPass")
load_library("RPostgres")
load_library("sf")
load_library("flextable")
load_library("broom")
load_library("eulerr")
load_library("dplyr")
load_library("knitr")
load_library("ggplot2")
load_library("ggmap")
load_library("tidyverse")
load_library("rnaturalearth")
load_library("parallel")
load_library("kableExtra")
load_library("mgcv")
load_library("ggmap")
load_library("ggrepel")
load_library("grid")
load_library("data.table")
load_library("car")
library(yaml)
cred=read_yaml("../../credentials.yml")
con_wgeel = dbConnect(Postgres(), dbname=cred$dbname,host=cred$host,port=cred$port,user=cred$user, password=getPass())

CY<-as.integer(format(Sys.Date(), "%Y")) # current year ==> dont forget to update the graphics path below (

format_dfa =function(the.fit){
  H.inv=1
  Z.est = coef(the.fit, type="matrix")$Z
  if(ncol(Z.est)>1) H.inv = varimax(Z.est)$rotmat
  
  #rotate factor loadings
  Z<-coef(the.fit,type="matrix")$Z%*%H.inv
  
  #rotate trends
  trends<-solve(H.inv)%*%the.fit$states
  scale_val=coef(the.fit)$A
  list(Z=Z,trends=trends,scale_val=scale_alpha)
}

#a function to display nice Venn diagram
venn <- function(nameseries,Z,minZ){
  nameseries=as.character(nameseries)
  list_venn=do.call(c,lapply(1:(dim(Z)[2]),function(j){
    res=list(nameseries[which(Z[,j]>minZ)],nameseries[which(Z[,j]< -minZ)])
    names(res)=paste("Trend",j,c("+","-"),sep="")
    res
  }))
  list_venn$Any =nameseries[!nameseries %in%unlist(list_venn)]
  euler_fit<-euler(list_venn)
  lab=sapply(names(euler_fit$original.values),function(n){
    groups=strsplit(n,"&")[[1]]
    group_not=names(list_venn)[!names(list_venn) %in%groups]
    okgroup = apply(sapply(groups,function(g) nameseries %in% list_venn[[g]]),
            1,
            prod) 
    oknotgroup=1
    if(length(group_not)>0){
      oknotgroup=apply(sapply(group_not,
                              function(g) !nameseries %in% list_venn[[g]]),
            1,
            prod)
    }
    paste(nameseries[as.logical(
      okgroup*oknotgroup)],
      collapse="\n")
  })
   eulerr_options(quantities=list(cex=.6))
  plot(euler_fit,quantities=lab)
}


venn_belonging <- function(nameseries,Z,minZ){
  nameseries=as.character(nameseries)
  list_venn=do.call(c,lapply(1:(dim(Z)[2]),function(j){
    res=list(nameseries[which(Z[,j]>minZ)],nameseries[which(Z[,j]< -minZ)])
    names(res)=paste("Trend",j,c("+","-"),sep="")
    res
  }))
  list_venn$Any =nameseries[!nameseries %in%unlist(list_venn)]
  sapply(nameseries,function(ser) 
    paste(names(list_venn)[sapply(names(list_venn),
           function(g) ifelse(ser %in% list_venn[[g]], TRUE,FALSE))],
          collapse="; "))
}

generate_dataset_plot_gam = function(model){
  cou_code=levels(droplevels (model$model$ser_cou_code))
  
  do.call('rbind.data.frame',lapply(cou_code, function(cou){
    year_range= range(model$model$das_year[model$model$ser_cou_code==cou],
                      na.rm=TRUE)
    years=year_range[1]:year_range[2]
    pred=predict(model,data.frame(das_year=years,ser_cou_code=cou), type = "response",
            se.fit=TRUE)
    data.frame(year=years,
               cou_code=cou,
                 pred=pred$fit,
               lower=pred$fit-1.96*pred$se.fit,
               upper=pred$fit+1.96*pred$se.fit)
    
    }))
  
}

```

```{r dataloading, include=FALSE}
query='SELECT 
		das_id,
		das_value,
		das_effort,
		das_year,
		das_comment,
		ser_id,            
		cou_order,
		ser_nameshort,
		ser_area_division,
		ser_qal_id,
    ser_hty_code,
    ser_emu_nameshort,
    ser_uni_code,
    ser_cou_code,
    ser_comment,
    sam_samplingtype,
    ser_sam_id, ser_distanceseakm, ser_method, ser_sam_gear, ser_restocking,
		das_qal_id,
		das_last_update,
		f_subarea,
		lfs_code,          
		lfs_name
		from datawg.t_dataseries_das 
		join datawg.t_series_ser on das_ser_id=ser_id
		left join ref.tr_samplingtype_sam on ser_sam_id=sam_id
		left join ref.tr_lifestage_lfs on ser_lfs_code=lfs_code
		left join ref.tr_faoareas on ser_area_division=f_division
        left join ref.tr_country_cou on cou_code=ser_cou_code
		where ser_typ_id in (2,3) and das_value is not null and  (ser_qal_id IS NULL OR ser_qal_id IN (0,1,2,4)) and (das_qal_id IS NULL OR das_qal_id IN (1,2,4))'
mydata = dbGetQuery(con_wgeel,query)
mydata$ser_nameshort=as.factor(mydata$ser_nameshort)
mydata$ser_area_division=as.factor(mydata$ser_area_division)
mydata$f_subarea=as.factor(mydata$f_subarea)
mydata$lfs_code=as.factor(mydata$lfs_code)
mydata$ser_cou_code=as.factor(mydata$ser_cou_code)
mydata$ser_emu_nameshort=as.factor(mydata$ser_emu_nameshort)
mydata$lfs_name=as.factor(mydata$lfs_name)
mydata$ser_hty_code=as.factor(mydata$ser_hty_code)

# total number including those with only NULL value
nb_yellow = dbGetQuery(con_wgeel, "	SELECT count(*) FROM datawg.t_series_ser	WHERE  ser_typ_id in (2)") %>% pull()
nb_silver = dbGetQuery(con_wgeel, "	SELECT count(*) FROM datawg.t_series_ser	WHERE  ser_typ_id in (3)") %>% pull()

#sampling=read.table("sampling.csv",header=TRUE,sep=";")
sampling = dbGetQuery(con_wgeel, "SELECT ser_id,	ser_nameshort,	ser_comment,	sam_samplingtype,	ser_uni_code,	gea_name_en AS type FROM datawg.t_series_ser LEFT OUTER JOIN ref.tr_gear_gea ON (gea_id = ser_sam_gear)  LEFT OUTER JOIN ref.tr_samplingtype_sam ON (sam_id = ser_sam_id) WHERE ser_typ_id IN (2,3)")
mydata = merge(mydata,sampling[,c("ser_id","type")])



silver_dataall <- mydata %>%
  filter(lfs_code=="S")
yellow_dataall <- mydata %>%
  filter(lfs_code=="Y")
yellow_map=st_read(con_wgeel,query=paste("select ser_id,ser_x,ser_y,geom,ser_nameshort from datawg.t_series_ser where ser_id in (",
                                         paste(unique(yellow_dataall$ser_id),collapse=","),")",sep=""))
yellow_map$Updated = yellow_map$ser_id %in% unique((mydata %>% filter(das_year >=2018) %>% select(ser_id) %>% pull()))
silver_map=st_as_sf(st_read(con_wgeel,query=paste("select ser_id,ser_x,ser_y,geom,ser_nameshort from datawg.t_series_ser where ser_id in (",
                                         paste(unique(silver_dataall$ser_id),collapse=","),")",sep="")))
silver_map$Updated = silver_map$ser_id %in% unique((mydata %>% filter(das_year >=2018) %>% select(ser_id) %>% pull()))

# colors for countries
country_ref = dbGetQuery(con_wgeel, "SELECT cou_code, cou_country, cou_order FROM ref.tr_country_cou")
country_ref= country_ref[order(country_ref$cou_order), ]

values=c(RColorBrewer::brewer.pal(12,"Set3"),
	RColorBrewer::brewer.pal(12, "Paired"), 
	RColorBrewer::brewer.pal(8,"Accent"),
	RColorBrewer::brewer.pal(8, "Dark2"))
color_countries = setNames(values,country_ref$cou_code)


dbDisconnect(con_wgeel)
colorpalette=cbf_1 <- c("red","black")
```


# Introduction
Several time series of abundance of yellow eels and silver eels are collected
throughout Europe. However, the analysis of their trends is more complex than
for glass eel time series since yellow and silver eels abundances are the results of
both the general status of the population and local conditions (environmental
condition, anthropogenic pressures, life history traits, management actions,...)
in localities in which they are collected [@ices2014]. Despite these
difficulties, it is interesting to explore whether some common trends exist
among the available time series and whether they can be related to some factors,
especially whether some spatial patterns exist in these trends. This would be a first
exploration step before moving forward in a potential assessment of the standing
stock. In this context, we carry out a Dynamic Factor Analysis, a multivariate
method aiming at detecting common trends in a set of time series [@zuur2003a].
Such an exercise is worthwhile only when the number of available time series is important, 
therefore, we restricted this analysis to the recent period (post 2000) and focus
on recent trends. To complete the overview, we carried out GAM analyses on a longer period
(since 1975) to analyse the long-term trends. The trends were analysed separately for yellow and 
silver eels. The analysis is based on the time series of yellow and silver eel (standing stock) 
time series of abundance collected during the successive WGEEL Data Calls and 
contribute to the response to ToR b “Report on developments in the state of the European eel
(*Anguilla anguilla*) stock, the fisheries on it and other anthropogenic impacts”.

# Yellow eel
## Available data
`r length(unique(yellow_dataall$ser_id))` time series (out of `r nb_yellow`) provide data of quality 1, 2 or are
not rated through the current or past Data Call (Figure \@ref(fig:mapyellow)), originating from
`r length(unique(yellow_dataall$ser_cou_code))` countries and `r length(unique(yellow_dataall$ser_emu_nameshort))` EMUs.
See chapter **XXX** for a more comprehensive description of dataseries available.
<!--  Most of them are located in Great Britain or France. -->
<!-- `r length(unique(yellow_dataall$ser_id[yellow_dataall$ser_hty_code=="C"])) +  length(unique(yellow_dataall$ser_id[yellow_dataall$ser_hty_code=="MO"]))` -->
<!-- time series are collected in open sea or in coastal waters, -->
<!-- `r length(unique(yellow_dataall$ser_id[yellow_dataall$ser_hty_code=="T"]))` in transitional waters and -->
<!-- `r length(unique(yellow_dataall$ser_id[yellow_dataall$ser_hty_code=="F"]))` in freshwater. -->

<!-- à voir pour faire les stat : yellow_dataall %>% select(ser_id, ser_hty_code) %>% distinct() %>% group_by(ser_hty_code) %>% count() -->

```{r mapyellow,echo=FALSE,message=FALSE,warning=FALSE,fig.cap="Map of available yellow time series. Updated time series correspond to time series for which at least one value was provided for years the three last years",fig.height=14/2.54}
sf::sf_use_s2(FALSE)
 worldmap <- ne_countries(scale = 'medium', type = 'map_units',
                          returnclass = 'sf')
 europe_cropped <- st_crop(worldmap, xmin = -13, xmax = 27,
                                     ymin = 35, ymax = 65)

  my_map=get_stamenmap(bbox = c(left = -13, bottom = 35, right =
                                  27, top = 65), zoom = 6, maptype = c("terrain-background"))
#watercolor
	
	draw_key_text=
		function (data, params, size) 
	{
		if (is.null(data$label)) 
			data$label <- "series"
		grid::textGrob(data$label, 0.5, 0.5, rot = data$angle %||% 0, gp = gpar(cex = 2, col = alpha(data$colour %||% 
						data$fill %||% "black", data$alpha), fontfamily = data$family %||% 
					"", fontface = data$fontface %||% 1, fontsize = (data$size %||% 
						3.88) * .pt))
	}
	
  ggmap(my_map) + 
		geom_point(data=yellow_map,
			aes(x=ser_x,y=ser_y),cex=2,pch=20, col  = "red")+
		geom_label_repel(data=yellow_map,
			aes(x=ser_x,y=ser_y,label=ser_nameshort,col=Updated),cex=1.5, key_glyph=draw_key_text, max.overlaps = Inf, label.padding = 0.1) +
		scale_color_manual("Updated",values=colorpalette)+
		ylab("")+xlab("")

#knitr::include_graphics("images/yellow.png")
```

## Trends after 2000

```{r pointperyearYE,echo=FALSE, fig.cap="number of yellow eel time series available per year",fig.height=8/2.54}
point_per_year_YE<- yellow_dataall %>%
  group_by(das_year) %>%
  summarize(n=n_distinct(ser_id))

ggplot(point_per_year_YE,aes(y=n,x=das_year))+
  geom_line() + geom_point() +
  xlab("")+ylab("number of available data")+
  theme_bw()

#For GAMS, we do not restrict to the post 2000 period
#we keep only data with at least 10 years
nbpointsgam = yellow_dataall %>%
  filter(das_year>=1975)%>%
  group_by(ser_id) %>%
  summarise(nbyear=n_distinct(das_year))%>%
  filter(nbyear>=10)
yellow_data_gam <-yellow_dataall %>%
  filter(ser_id %in% nbpointsgam$ser_id & das_year>=1975 & das_year <= (CY-1))

#we also removed ser_id for which 0 represents more than 10% of data
yellow_data_gam <- yellow_data_gam %>%
  group_by(ser_id) %>%
  mutate(nb_values=n(),nb_zeros=sum(das_value==0)) %>%
  mutate(freq_zero=nb_zeros/nb_values)%>%
  filter(freq_zero < .1)

#we keep only data with at least 10 years
nbpoints = yellow_dataall %>%
  filter(das_year>=2000)%>%
  group_by(ser_id) %>%
  summarise(nbyear=n_distinct(das_year))%>%
  filter(nbyear>=10)
yellow_data <-yellow_dataall %>%
  filter(ser_id %in% nbpoints$ser_id & das_year>=2000 & das_year <= (CY-1))

#we also removed ser_id for which 0 represents more than 10% of data
yellow_data <- yellow_data %>%
  group_by(ser_id) %>%
  mutate(nb_values=n(),nb_zeros=sum(das_value==0)) %>%
  mutate(freq_zero=nb_zeros/nb_values)%>%
  filter(freq_zero < .1)
```

Currently, few pre-2000 data are recorded in the database (Figure \@ref(fig:pointperyearYE)), 
an effort should be made in the future to collect historical data. Many data values for `r CY` were still missing when
carrying out the analysis (only `r point_per_year_YE %>% filter(das_year == CY) %>% pull()` series have data for
`r CY`). 



In view of this, the analysis was restricted to the period ranging from 2000 to 
`r CY -1` with data series that have at least 10 observations on the period.

This leaves `r length(unique(yellow_data$ser_id))` time series (and restricted to series having less than 10% of 0). 
If we plot all the series, a GAM smoother indicates an overall decreasing trend (Figure \@ref(fig:plotTSYE)).

```{r plotTSYE,echo=FALSE,warning=FALSE, fig.cap="Yellow eel time series and GAM smoother"}
yellow_data_std=yellow_data%>%
  group_by(ser_id)%>%
  mutate(das_value=(das_value-mean(das_value,na.rm=TRUE))/sd(das_value,na.rm=TRUE))

ggplot(yellow_data_std,aes(x=das_year,y=das_value))+
  geom_line(aes(col=as.factor(ser_nameshort)))+
  geom_smooth(method="gam")+theme_bw()+xlab("year")+
  ylab("Standardised abundance index")+
  guides(col="none")
```

```{r gamYellow, echo=FALSE,warning=FALSE, fig.cap="Trends per country in yellow eel abundance estimated by a GAM"}
# test for an overall trend in the data
g0 <- gam(das_value~s(das_year), data=yellow_data_std, family = gaussian())

# test for trends per country
g1 <- gam(das_value~s(das_year, by=ser_cou_code), data=yellow_data_std, family = gaussian())

# compute mean of the standardized values to be included in figure
yellow_data_std_mean <- yellow_data_std %>% group_by(ser_cou_code, das_year) %>% 
                    summarize(mean_das_value=mean(das_value),
                              N=n()) %>% ungroup() %>% rename(cou_code=ser_cou_code)


cols<-colorRampPalette(c("chartreuse", "grey",  "navy"),space = "rgb")(length(cou_code))

yellow_gam_plot_recent=generate_dataset_plot_gam(g1)
yellow_gam_plot_recent$cou_code<-factor(yellow_gam_plot_recent$cou_code,levels=cou_ref$cou_code,ordered=TRUE)

ggplot(yellow_gam_plot_recent,aes(x=year,y=pred))+
  geom_line()+
  geom_point(aes(x=das_year,y=mean_das_value),data=yellow_data_std_mean) +
  geom_ribbon(aes(ymin=lower,ymax=upper),alpha=.3)+
  facet_wrap(vars(cou_code),scales="free_y")+
  scale_colour_manual(values=cols)+
  scale_fill_manual(values=cols)+
  theme_bw()+ ylab("relative abundance")

```

When plotted per country, a simple GAM smoother (explained deviance = `r round(summary(g1)$dev.expl * 100, 1)` %) shows
decreasing and stabilising curves in FR, NL. The same with a more pronounced increase after 2012 is estimated for ES (DK
seems to display a similar trend but the time series is shorter). On the other hand, a linear decrease is estimated in
IE, GB and DE, and an increase for SE (Figure \@ref(fig:gamYellow)). 

```{r table-yellow-gam, echo=FALSE, tab.cap = "Series included in the GAM analysis"}
flextable(nb_per_country <- yellow_data %>%
				group_by(ser_cou_code) %>%
				summarize(N=n(),Nseries=n_distinct(ser_id)) %>%
				dplyr::rename(Country=ser_cou_code))
```

```{r exploratory-analysis, echo = FALSE}

# change logical to factor
yellow_data_std$ser_restocking<-as.factor(yellow_data_std$ser_restocking)

# function to create the data for the graph (to put after l131)
generate_dataset_plot_gam_res = function(model){
	res_code=levels(droplevels (model$model$ser_restocking))
	
	do.call('rbind.data.frame',lapply(res_code, function(res){
				year_range= range(model$model$das_year[model$model$ser_restocking==res],
					na.rm=TRUE)
				years=year_range[1]:year_range[2]
				pred=predict(model,data.frame(das_year=years,ser_restocking=res),
					se.fit=TRUE)
				data.frame(year=years,
					res_code=res,
					pred=pred$fit,
					lower=pred$fit-1.96*pred$se.fit,
					upper=pred$fit+1.96*pred$se.fit)
				
			}))
	
}

# gam (to put r gamYellow)
g3 <- gam(das_value~s(das_year, by=ser_restocking), data=yellow_data_std)

# Graph of the results (to put r gamYellow)
yellow_gam_plot_recent=generate_dataset_plot_gam_res(g3)
ggplot(yellow_gam_plot_recent,aes(x=year,y=pred))+
	geom_line()+
	geom_ribbon(aes(ymin=lower,ymax=upper),alpha=.3)+
	facet_wrap(.~res_code,scales="free_y")+
	scale_colour_manual(values=cols)+
	scale_fill_manual(values=cols)+
	theme_bw()+ ylab("relative abundance (log scale)")

######
### habitat: HTY
######

#select only the data where we have hty code
yellow_data_std_hty<-yellow_data_std%>%filter(!is.na(ser_hty_code))

# function to create the data for the graph
generate_dataset_plot_gam_hty = function(model){
	hty_code=levels(droplevels (model$model$ser_hty_code))
	
	do.call('rbind.data.frame',lapply(hty_code, function(hty){
				year_range= range(model$model$das_year[model$model$ser_hty_code==hty],
					na.rm=TRUE)
				years=year_range[1]:year_range[2]
				pred=predict(model,data.frame(das_year=years,ser_hty_code=hty),
					se.fit=TRUE)
				data.frame(year=years,
					hty_code=hty,
					pred=pred$fit,
					lower=pred$fit-1.96*pred$se.fit,
					upper=pred$fit+1.96*pred$se.fit)
				
			}))
	
}

# GAM (to put r gamYellow)
g4 <- gam(das_value~s(das_year, by=ser_hty_code), data=yellow_data_std_hty)

# Graph (to put r gamYellow)
hty_code <- levels(droplevels (yellow_data_std_hty$ser_hty_code))

# compute mean values per year and habitat type
yellow_data_std_hty_mean <- yellow_data_std_hty %>% group_by(ser_hty_code,das_year) %>% summarize(average=mean(das_value)) %>% ungroup() %>% rename(hty_code=ser_hty_code)

# plot gam model and mean values for hty
yellow_gam_plot_recent=generate_dataset_plot_gam_hty(g4)
ggplot(yellow_gam_plot_recent,aes(x=year,y=pred))+
	geom_line()+
	geom_ribbon(aes(ymin=lower,ymax=upper),alpha=.3)+
	facet_wrap(.~hty_code,scales="free_y")+
	scale_colour_manual(values=cols)+
	scale_fill_manual(values=cols)+
	theme_bw()+ ylab("relative abundance (log scale)")

table(yellow_data_std_hty$ser_cou_code,yellow_data_std_hty$ser_hty_code)


######
### Gear
#####

#select only the data where we have hty code and change character into factor

yellow_data_std_gear<-yellow_data_std%>%filter(!is.na(ser_sam_gear))

yellow_data_std_gear$ser_sam_gear<-as.factor(yellow_data_std_gear$ser_sam_gear)

# function to create the data for the graph (to put after l131)

generate_dataset_plot_gam_type = function(model){
	gear_code=levels(droplevels (model$model$ser_sam_gear))
	
	do.call('rbind.data.frame',lapply(gear_code, function(gear){
				year_range= range(model$model$das_year[model$model$ser_sam_gear==gear],
					na.rm=TRUE)
				years=year_range[1]:year_range[2]
				pred=predict(model,data.frame(das_year=years,ser_sam_gear=gear),
					se.fit=TRUE)
				data.frame(year=years,
					gear_code=gear,
					pred=pred$fit,
					lower=pred$fit-1.96*pred$se.fit,
					upper=pred$fit+1.96*pred$se.fit)
				
			}))
	
}

# GAM (to put r gamYellow)
g4 <- gam(das_value~s(das_year, by=ser_sam_gear), data=yellow_data_std_gear)


# Graph (to put r gamYellow)
gear_code <- levels(droplevels (yellow_data_std_gear$ser_sam_gear))

yellow_gam_plot_recent=generate_dataset_plot_gam_type(g4)
ggplot(yellow_gam_plot_recent,aes(x=year,y=pred))+
	geom_line()+
	geom_ribbon(aes(ymin=lower,ymax=upper),alpha=.3)+
	facet_wrap(.~gear_code,scales="free_y")+
	scale_colour_manual(values=cols)+
	scale_fill_manual(values=cols)+
	theme_bw()+ ylab("relative abundance (log scale)")

table(yellow_data_std_hty$ser_cou_code,yellow_data_std_hty$ser_sam_gear)

######
### Distance to the sea
#####

yellow_data_std_dis<-yellow_data_std%>%filter(!is.na(ser_distanceseakm))

#select only the data where we have hty code

g0 <- gam(das_value~s(das_year)+s(ser_distanceseakm), data=yellow_data_std)
plot(g0)

ggplot(yellow_data_std_dis,aes(x=ser_distanceseakm,y=das_value))+
	geom_smooth(method="gam")+theme_bw()+xlab("distance to the sea (km)")+
	ylab("Standardised abundance index (log scale)")+
	guides(col=FALSE)

```

### Running the DFA
The DFA method is fully detailed in [@zuur2003]. The basic idea is to decompose each time series into a weighted sum of a few common trends and a noise factor:
$$
\begin{aligned}
Y_{j,t}=\mu_j + \sum_{i=1}^{n} w_{i,j} \cdot X_{i,t} +\epsilon_{j,t} \qquad \mbox{ with } \left \{ \epsilon_{j,t} \right \}  \sim N(0,\Sigma)
\end{aligned}
$$
with $Y_{j, t}$ the value of the series $j$ at time $t$, $\mu_j$ an intercept, $n$ the number of common trends, $w_{i, j}$ the weight of trend $i$ in the series $j$, $X_{i,t}$ the value of trend $i$ at time $t$ and $\epsilon_{j,t}$ a normal noise, potentially correlated between series through the variance-covariance matrix $\Sigma$ . Therefore, $X_{i,t}$ represent the trends common to the series and are modelled as random walks:

$$
\begin{aligned}
X_{i,t}=X_{i,t-1}+f_{i,t} \qquad \mbox{ with } f_{i,t} \sim N(0,Q)
\end{aligned}
$$

with $f_{i,t}$ the noise on the trend $i$ at time $t$ which follows a normal law, possibly correlated between trends with the variance-covariance matrix $Q$ which can be set to the identity matrix [@zuur2003a].
The method thus allows both to extract the common trends through the estimates of $X$, but also to see the importance of each trend in each series through $w$.

To fit the DFA, the user as to put some additional constraints. We will make 3 kinds of assumptions on $\Sigma$:

* $\Sigma$ is a diagonal matrix with equal elements in the diagonal (e.g. time series are independent with similar values of noise)
* $\Sigma$ is a diagonal matrix with unequal elements in the diagonal (e.g. time series are independent with different values of noise)
* $\Sigma$ is an unconstrained (e.g. time series are potentially not independent with different values of noise). This solution was not tested for yellow eels since the number of time series was too large compared to the number of observations.

One to 4 common trends are tested. The best combination of $\Sigma$ and number of trends is chosen by comparing AIC criteria. 
Before running the DFA, values were logtransformed (few 0 values were recorded and were replaced by 10% of the lower value of the series) and scales ((mean deleted and divided by the standard deviation)).


### Common trends

```{r dfa-yellow, results='hide',eval=TRUE,echo=FALSE}
if (params$rerunDFA){
  #replace 0 value
  list_zeros <- which(yellow_data$das_value == 0)
  for (i in list_zeros){
    ser_id=yellow_data$ser_id[i]
    yellow_data$das_value[i] <- 0.2 *
      min(yellow_data$das_value[yellow_data$das_value>0 & 
                                  yellow_data$ser_id == ser_id],na.rm=TRUE)
  }
	
  # put data in wide format
	data_dfa_yellow = yellow_data %>% as_tibble() %>%
	  select(ser_nameshort,das_value,das_year) %>%
	  arrange(das_year)%>%
	  pivot_wider(names_from= ser_nameshort, values_from=das_value)
  
	# plot yellow data series
  graph_serie(yellow_data)
  
  
  
  #Design of experiments
  S=c("diagonal and equal","diagonal and unequal")
  nbtrend=1:4
  expe=expand.grid(S=S,nbtrend=nbtrend)

  #Now we make a loop of DFA to find the best model
	DFA_yellow = run_DFA(data_dfa_yellow, expe, log = TRUE)

	# save results
	save(DFA_yellow, file="./dfa.rdata")

}
```

One trends was estimated after selection by AICc criteria (Table \@ref(tab:comparisonYE) and Figure \@ref(fig:trendsyellow)).

```{r comparisonYE,echo=FALSE,tab.cap='Model comparisons for yellow eel DFA'}
source("DFA_functions.R")
load("./dfa.rdata")
table_summary_models(summary_models(DFA_yellow)) # Model comparison
```


```{r trendsyellow, echo=FALSE, fig.cap="Estimated common trends in yellow eel time series"}

source("DFA_functions.R")
load("./dfa.rdata")
DFA = best_DFA(DFA_yellow) # results for best
DFA_results = results_DFA(DFA) # can be long
graph_trends(DFA_results$trends,year=sort(unique(yellow_data$das_year)),sign_trends=-1)

```

```{r tab-loadingsYE,echo=FALSE,tab.cap="Factor loadings of the yellow eel DFA (red names stand for loadings absolute values greater than 0.2)"}

graph_Z(DFA_results$Z.conf,sign_trends=-1)

```

Trend 1 shows a monotonous decreasing trend over the period.

The factor loadings $w$ are displayed in the following plots (Figure \@ref(fig:seriesloadingsYE)). Following @zuur2003,
we only focused on loading with absolute values greater than 0.2 to focus on the most important trends and presented on
a Venn diagram (Figure \@ref(fig:vennyellow))


```{r seriesloadingsYE, echo=FALSE,fig.cap="Factor loadings of the yellow eel DFA (red names stand for loadings absolute values greater than 0.2)",fig.height=16/2.54}

Venn_diagram(DFA_results$Z,sign_trends=-1) 

```


```{r facotr-glm-yellow, echo = FALSE}

#r trendsyellow

yellow_z_dfa <- data.frame(namesseries=rownames(DFA_results$Z),z1=DFA_results$Z[,1])
sel_param<-unique(data.frame(nameshort=mydata$ser_nameshort, res=mydata$ser_restocking, hty=mydata$ser_hty_code, cou_code=mydata$ser_cou_code, samplingtype=mydata$sam_samplingtype, sam_id=mydata$ser_sam_id,distanceseakm=mydata$ser_distanceseakm, sam_gear=mydata$ser_sam_gear))

yellow_dfa<-merge(yellow_z_dfa, sel_param, by.x="namesseries", by.y="nameshort")
modelz1<-glm(z1~ res+hty+as.factor(sam_gear)+distanceseakm, family = gaussian, data = yellow_dfa)

Anova(modelz1)
summary(modelz1)

```

```{r vennyellow, echo=FALSE, fig.cap="Venn diagram of the yellow eel DFA"}
Venn_diagram(DFA_results$Z,sign_trends=-1)
```


```{r spatialpatternAllYE,echo=FALSE,fig.cap="Spatial maps of yellow DFA loadings", warning=FALSE, message=FALSE, fig.height=16/2.54}

Z=DFA_results$Z # factor loadings
minZ=0.2 # minum value accepted for factor loading
yellow_belonging=data.frame(ser_nameshort=rownames(Z),
                            Trend=venn_belonging(rownames(Z),
                                                 Z,
                                                 minZ))
yellow_belonging <- yellow_belonging %>%
  mutate(Trend1=ifelse(Z[,1]>minZ,"+",
                       ifelse(Z[,1]< -minZ, "-",0)))
yellow_belonging = merge(yellow_belonging,
                         unique(yellow_data[,c("ser_id","ser_nameshort")]))
yellow_belonging=merge(yellow_map,
                       yellow_belonging)
ggplot(yellow_belonging)+
  geom_sf(data=europe_cropped)+
  geom_sf(data=yellow_belonging,aes(fill=Trend,col=Trend))+
  scale_fill_brewer(type="qual", palette = "Set3")+
  scale_color_brewer(type="qual", palette = "Set3")+
  theme_bw()
```


```{r spatialpatternTrendsYE,echo=FALSE,fig.cap="Spatial maps of yellow DFA loadings, detailed by trend", warning=FALSE, message=FALSE, fig.height=16/2.54}

yellow_belonging=data.frame(ser_nameshort=rownames(Z),
                            Trend=venn_belonging(rownames(Z),
                                                 Z,
                                                 minZ))
# yellow_belonging=data.frame(ser_nameshort=namesseries,
#                             Trend=venn_belonging(namesseries,
#                                                  Z,
#                                                  minZ))
yellow_belonging <- yellow_belonging %>%
  mutate(Trend1=ifelse(Z[,1]>minZ,"+",
                       ifelse(Z[,1]< -minZ, "-",0)))
yellow_belonging = merge(yellow_belonging,
                         unique(yellow_data[,c("ser_id","ser_nameshort")]))
yellow_belonging=merge(yellow_map,
                       yellow_belonging)
#t2<-ggplot(yellow_belonging)+
#  geom_sf(data=europe_cropped)+
#  geom_sf(data=yellow_belonging,aes(fill=Trend2,col=Trend2))+
#  scale_fill_brewer(type="qual")+
#  scale_color_brewer(type="qual")+
#  theme_bw()

ggplot(yellow_belonging)+
  geom_sf(data=europe_cropped)+
  geom_sf(data=yellow_belonging,aes(fill=Trend1,col=Trend1))+
  scale_fill_brewer(type="qual")+
  scale_color_brewer(type="qual")+
  theme_bw()
# grid.arrange(t1,t2,ncol=1)
```


Many series are positively correlated to Trend 1, indicating a constant decline 
of abundance since the 2000s (Figure \@ref(fig:vennyellow)). Some time series are
negatively correlated to trend 1, but among them, many are also positively
correlated to trend 2, indicating a slight increase or stability at the beginning
of the period and then a decrease till 2007. Regarding time series dominated
mostly by a negative correlation with trend 1 (i.e. a monotonic increase over the
period), they all came from Great Britain, and half of them are located far from
the coast. On the whole, it is difficult to distinguish any clear spatial pattern
in the trends (Figures \@ref(fig:spatialpatternAllYE) and 
\@ref(fig:spatialpatternTrendsYE)).

The fits of the DFA model to the different time series are presented in Figure \@ref(fig:fitsyellow)



```{r fitsyellow, echo=FALSE,warning=FALSE, fig.cap="Yellow DFA fits to time series", fig.width=16/2.54, fig.height=25/2.54}
d <- residuals(DFA,interval="confidence") #augment is replace since MARSS 3.11, see https://github.com/nwfsc-timeseries/MARSS/releases
d$.conf.low <- d$.fitted+qnorm(0.05/2)*d$.sigma
d$.conf.up <- d$.fitted-qnorm(0.05/2)*d$.sigma

	data_dfa_yellow = yellow_data %>% as_tibble() %>%
	  select(ser_nameshort,das_value,das_year) %>%
	  arrange(das_year)%>%
	  pivot_wider(names_from= ser_nameshort, values_from=das_value)
	
TT <- nrow(data_dfa_yellow) - 1
# some tests
#cor.test(d$value, d$.fitted)
#ggplot(data = d) + geom_point(aes(x=value, y =.fitted, color = .rownames)) + geom_abline(intercept = 0, slope = 1)

ggplot(data = d) +
  geom_line(aes(t, .fitted)) +
  geom_point(aes(t, value)) +
  geom_ribbon(aes(x=t, ymin=.conf.low, ymax=.conf.up), linetype=2, alpha=0.2) +
  facet_wrap(vars(.rownames)) +
  xlab("") + ylab("standarized abundance index")+ 
  theme_bw()
 
```


## Historical trends
We also fitted GAM over a period starting in 1975 to put the post-2000
trends in an historical perspective. For many countries, data do not start before the 2000s, so the reader should refer
to the previous section (DE, DK, ES, FR). A decreasing trend is observed in most other countries
(NL, NO, IE, GB) except in Sweden where an increasing trend is observed  (Figure \@ref(fig:gamYellowHist)) though
the early trend is only based on two time series.

```{r gamYellowHist, echo=FALSE,warning=FALSE, fig.cap="Trends per country in yellow eel abundance estimated by a GAM "}
yellow_data_std_gam=yellow_data_gam%>%
  mutate(das_value=das_value)%>%
  group_by(ser_nameshort)%>%
  mutate(das_value=(das_value-mean(ifelse(das_year>=2000,
                                          das_value,
                                          NA),na.rm=TRUE))/sd(ifelse(das_year>=2000,
                                          das_value,
                                          NA),na.rm=TRUE))


#g0 <- gam(das_value~s(das_year), data=yellow_data_std_gam)
g1 <- gam(das_value~s(das_year, by=ser_cou_code), data=yellow_data_std_gam, family = gaussian())
#g2 <- gam(das_value~s(das_year, by=ser_nameshort), data=yellow_data_std_gam)
#AIC(g0, g1, g2)
cou_code <- levels(droplevels (yellow_data_std_gam$ser_cou_code))

cols<-colorRampPalette(c("chartreuse", "grey",  "navy"),space = "rgb")(length(cou_code))

yellow_gam_plot=generate_dataset_plot_gam(g1)
ggplot(yellow_gam_plot,aes(x=year,y=pred))+
  geom_line()+
  geom_ribbon(aes(ymin=lower,ymax=upper),alpha=.3)+
  facet_wrap(.~cou_code,scales="free_y")+
  scale_colour_manual(values=cols)+
  scale_fill_manual(values=cols)+
  theme_bw()+ ylab("relative abundance")

```



# Silver eel
## Available data
`r length(unique(silver_dataall$ser_id))` time series (out of `r nb_silver`)
provide data through the current or past Data Call l (Figure
\@ref(fig:mapsilver)), originating from `r length(unique(silver_dataall$ser_cou_code))` countries and
`r length(unique(silver_dataall$ser_emu_nameshort))` EMUs. Most of them are located in Northern Europe. See chapter
**XXX** for a more comprehensive description of dataseries available.

```{r mapsilver,echo=FALSE,message=FALSE,warning=FALSE,fig.cap="Map of available silver time series. Updated time series correspond to time series for which at least one value was provided for years the three last years",fig.height=14/2.54}
 worldmap <- ne_countries(scale = 'medium', type = 'map_units',
                          returnclass = 'sf')
 europe_cropped <- st_crop(worldmap, xmin = -13, xmax = 27,
                                     ymin = 35, ymax = 65)

 my_map=get_stamenmap(bbox = c(left = -13, bottom = 35, right =
                                  27, top = 65), zoom = 6, maptype = c("terrain-background"))
#watercolor
draw_key_text=
	function (data, params, size) 
{
	if (is.null(data$label)) 
		data$label <- "series"
	grid::textGrob(data$label, 0.5, 0.5, rot = data$angle %||% 0, gp = gpar(cex = 2, col = alpha(data$colour %||% 
					data$fill %||% "black", data$alpha), fontfamily = data$family %||% 
				"", fontface = data$fontface %||% 1, fontsize = (data$size %||% 
					3.88) * .pt))
}

ggmap(my_map) + 
	geom_point(data=silver_map,
		aes(x=ser_x,y=ser_y),cex=2,pch=20, col  = "red")+
	geom_label_repel(data=silver_map,
		aes(x=ser_x,y=ser_y,label=ser_nameshort,col=Updated),cex=1.5, key_glyph=draw_key_text, max.overlaps = Inf, label.padding = 0.1) +
	scale_color_manual("Updated",values=colorpalette)+
	ylab("")+xlab("")
#knitr::include_graphics("images/silver.png")
```

## Trends since 2000

```{r pointperyearSE,echo=FALSE, fig.cap="number of yellow eel time series available per year",fig.height=8/2.54}
point_per_year_SE<- silver_dataall %>%
  group_by(das_year) %>%
  summarize(n=n_distinct(ser_id))

ggplot(point_per_year_SE,aes(y=n,x=das_year))+
  geom_line()+ geom_point() +
  xlab("")+ylab("number of available data")+
  theme_bw()


#For GAMS, we do not restrict to the post 2000 period
#we keep only data with at least 10 years
nbpointsgam = silver_dataall %>%
  filter(das_year>=1975)%>%
  group_by(ser_id) %>%
  summarise(nbyear=n_distinct(das_year))%>%
  filter(nbyear>=10)
silver_data_gam <-silver_dataall %>%
  filter(ser_id %in% nbpointsgam$ser_id & das_year>=1975 & das_year <= (CY-1))

#we also removed ser_id for which 0 represents more than 10% of data
silver_data_gam <- silver_data_gam %>%
  group_by(ser_id) %>%
  mutate(nb_values=n(),nb_zeros=sum(das_value==0)) %>%
  mutate(freq_zero=nb_zeros/nb_values)%>%
  filter(freq_zero < .1)


#we keep only data with at least 10 years
nbpoints = silver_dataall %>%
  filter(das_year>=2000)%>%
  group_by(ser_id) %>%
  summarise(nbyear=n_distinct(das_year))%>%
  filter(nbyear>=10)
silver_data <-silver_dataall %>%
  filter(ser_id %in% nbpoints$ser_id & das_year>=2000 & das_year<=(CY-1))



#we also removed ser_id for which 0 represents more than 10% of data
silver_data <- silver_data %>%
  group_by(ser_id) %>%
  mutate(nb_values=n(),nb_zeros=sum(das_value==0)) %>%
  mutate(freq_zero=nb_zeros/nb_values)%>%
  filter(freq_zero < .1)

```
Similarly to yellow eels, few pre-2000 data series are available in the database (Figure \@ref(fig:pointperyearSE)).
Many data values for `r CY` were still missing when carrying out the analysis (only
`r point_per_year_SE %>% filter(das_year == CY) %>% pull()` series have data for `r CY`). 

In
view of this, we restricted the analysis to the period 2000 to `r CY - 1`, with time series having at least 10 observations
over the period. 

This leaves `r length(unique(silver_data$ser_id))` time series. If we plot all
the series, a GAM smoother indicates an overall slightly decreasing trend (Figure
\@ref(fig:plotTSSE)).


```{r plotTSSE,echo=FALSE,warning=FALSE, fig.cap="Silver eel time series and GAM smoother"}
silver_data_std=silver_data%>%
  group_by(ser_id)%>%
  mutate(das_value=(das_value-mean(das_value,na.rm=TRUE))/sd(das_value,na.rm=TRUE))

ggplot(silver_data_std,aes(x=das_year,y=das_value))+
  geom_line(aes(col=as.factor(ser_nameshort)))+
  geom_smooth(method="gam")+theme_bw()+xlab("year")+
  ylab("Standardised abundance index")+
  guides(col=FALSE)
```



When plotted per country, a simple GAM smoother shows decreasing trend in DK,
FR, NO, the same but with a stabilization in GB (Figure \@ref(fig:gamSilver)).
SE and ES display rather increasing trend, while IE is more stable. DE is
erratic, especially because there are no data at the beginning of the period.
The trend correspdond to log transformed and scaled values.

```{r gamSilver, echo=FALSE,warning=FALSE, fig.cap="Trends per country in silver eel abundance estimated by a GAM"}
#g0 <- gam(das_value~s(das_year), data=silver_data_std)
g1 <- gam(das_value~s(das_year, by=ser_cou_code), data=silver_data_std, family = gaussian())
#g2 <- gam(das_value~s(das_year, by=ser_nameshort), data=silver_data_std)
#AIC(g0, g1, g2)
cou_code <- levels(droplevels (silver_data_std$ser_cou_code))
cols<-colorRampPalette(c("chartreuse", "grey",  "navy"),space = "rgb")(length(cou_code))
silver_gam_plot_recent=generate_dataset_plot_gam(g1)
ggplot(silver_gam_plot_recent,aes(x=year,y=pred))+
  geom_line()+
  geom_ribbon(aes(ymin=lower,ymax=upper),alpha=.3)+
  facet_wrap(.~cou_code,scales="free_y")+
  scale_colour_manual(values=cols)+
  scale_fill_manual(values=cols)+
  theme_bw()+ ylab("relative abundance")
```


```{r table-silver-gam, echo=FALSE, tab.cap = "Series included in the GAM analysis"}
flextable(nb_per_country <- silver_data %>% mutate(ser_cou_code =  tidyr::replace_na(as.character(ser_cou_code),  "Internat.")) %>%
				group_by(ser_cou_code) %>%
				summarize(N=n(),Nseries=n_distinct(ser_id)) %>%
				dplyr::rename(Country=ser_cou_code) )
```

### Running the DFA
We applied the same method as for yellow eels so readers can refer to the 
corresponding section for further details.

### Common trends

```{r dfa silver, results='hide',eval=TRUE,echo=FALSE}
if (params$rerunDFA){

  # put data in wide format
  	data_dfa_silver = silver_data %>% as_tibble() %>%
	  select(ser_nameshort,das_value,das_year) %>%
	  arrange(das_year)%>%
	  pivot_wider(names_from= ser_nameshort, values_from=das_value)
  
  	# plot raw data series
  	graph_serie(silver_data)
  
  
  
  #Design of experiments
  S=c("diagonal and equal","diagonal and unequal")
  nbtrend=1:4
  expe=expand.grid(S=S,nbtrend=nbtrend)

  #Now we make a loop of DFA to find the best model
	DFA_silver = run_DFA(data_dfa_silver, expe, log = TRUE)
	
	# save results
	save(DFA_silver, file="./dfasilver.rdata")

}
```
  
The model selection leads to the estimation of a single trend (Table
\@ref(tab:comparisonSE) and Figure \@ref(fig:trendssilver)).


```{r comparisonSE,echo=FALSE,tab.cap="Model comparisons for silver eel DFA"}
load("./dfasilver.rdata")
summary_models(DFA_silver)
table_summary_models(summary_models(DFA_silver))

```
  
  
```{r trendssilver, echo=FALSE, fig.cap="Estimated common trend in silver eel time series"}
# N_ts=nrow(silver_wide) #number of time series
# TT=ncol(silver_wide)-1 #number of time steps
# y=as.matrix(silver_wide[,-1]) #matrix of obseravation
# rownames(y)=silver_wide$ser_nameshort
# 
# formatted_matrices_silver=format_dfa(best_fit_silver)
# 
# namesseries=silver_wide$ser_nameshort
# 
# trends=formatted_matrices_silver$trends
# Z=formatted_matrices_silver$Z
# save(Z, file = "./Zsilver.Rdata")
# #plot the factor loadings
# minZ = 0.2
# m=dim(trends)[1]
# 
# trends_long <- as.data.frame(t(trends))
# names(trends_long)=paste("Trend",1:ncol(trends_long))
# trends_long$year=as.numeric(names(silver_wide)[-1])
# trends_long<-trends_long %>%
#   pivot_longer(starts_with("Trend"),names_to="Trend")
#   ggplot(trends_long,aes(x=year,y=value))+
#     geom_line()+
#     facet_wrap(.~Trend)+
#     theme_bw()
table_summary_models(summary_models(DFA_silver))
graph_summary_models(summary_models(DFA_silver))
DFA = best_DFA(DFA_silver)
DFA_results = results_DFA(DFA) # can be long


  	data_dfa_silver = silver_data %>% as_tibble() %>%
	  select(ser_nameshort,das_value,das_year) %>%
	  arrange(das_year)%>%
	  pivot_wider(names_from= ser_nameshort, values_from=das_value)

graph_trends(DFA_results$trends,year=sort(unique(data_dfa_silver$das_year)),sign_trends=-1)

```
  
 
```{r tab-loadingsSE,echo=FALSE,tab.cap="Factor loadings of the silver eel DFA (red names stand for loadings absolute values greater than 0.2)"}
m <- 1 #number of trends
Z_tab = as_tibble(data.frame(rownames(Z),  Z))
colnames(Z_tab) = c("Series", paste0("Trend ", 1:m))
Z_tab = Z_tab %>% arrange(Series)
ft <- flextable(Z_tab  %>% mutate(across(2:(1+m), round, 2))) #digits no more supported in colformat_num
for(i in 1:m)
	 ft = ft %>% color(abs(Z_tab %>% select(paste0("Trend ", i))) > 0.2, paste0("Trend ", i), color = "red")
autofit(ft)
``` 
  
The factor loadings are displayed in the Figure \@ref(fig:seriesloadingssilver) 
(importance of each trend in each time series) and corresponding Venn diagram in Figure \@ref(fig:vennsilver).
  
```{r seriesloadingssilver, echo=FALSE,fig.cap="Factor loadings of the silver eel DFA"}
graph_Z(DFA_results$Z.conf,sign_trends=-1)

```


```{r vennsilver, echo=FALSE, fig.cap="Venn diagram of the silver eel DFA"}
Venn_diagram(DFA_results$Z,sign_trends=-1)
```


```{r spatialpatternAllSE,echo=FALSE,fig.cap="Spatial maps of silver DFA loadings (+ stands for a positive correlaction to trend 1)", warning=FALSE, message=FALSE, fig.heigth=16/2.54}
Z=DFA_results$Z # factor loadings
minZ=0.2 # minum value accepted for factor loading

silver_belonging=data.frame(ser_nameshort=rownames(Z),
                            Trend=venn_belonging(rownames(Z),
                                                 Z,
                                                 minZ))
silver_belonging <- silver_belonging %>%
  mutate(Trend1=ifelse(Z[,1]>minZ,"+",
                       ifelse(Z[,1]< -minZ, "-",0)))
silver_belonging = merge(silver_belonging,
                         unique(silver_data[,c("ser_id","ser_nameshort")]),
                         by="ser_nameshort")
silver_belonging=merge(silver_map,
                       silver_belonging)

ggplot(silver_belonging)+
  geom_sf(data=europe_cropped)+
  geom_sf(data=silver_belonging,aes(fill=Trend1,col=Trend1))+
  scale_fill_brewer(type="qual")+
  scale_color_brewer(type="qual")+
  theme_bw()
```


About `r round(100*sum(silver_belonging$Trend=="Trend1+")/nrow(silver_belonging))`%
of the series are positively correlated to trend 1 indicating a decline in the
abundance (Figure \@ref(fig:seriesloadingssilver)). However, about 
`r round(100*sum(silver_belonging$Trend=="Trend1-")/nrow(silver_belonging))`% 
are negatively correlated suggesting an increase, and about 
`r round(100*sum(silver_belonging$Trend=="Any")/nrow(silver_belonging))`% are 
not correlated to any trends, suggesting some stability. As for yellow eels, 
there is no obvious spatial pattern in the trends 
(Figure \@ref(fig:spatialpatternAllSE)).

DFA fits to data are presented in Figure \@ref(fig:fitsilver).

```{r fitsilver, echo=FALSE,warning=FALSE, fig.cap="Silver DFA fits to time series", fig.width=16/2.54, fig.height=16/2.54}
d <- residuals(DFA,interval="confidence") #augment is replace since MARSS 3.11, see https://github.com/nwfsc-timeseries/MARSS/releases
d$.conf.low <- d$.fitted+qnorm(0.05/2)*d$.sigma
d$.conf.up <- d$.fitted-qnorm(0.05/2)*d$.sigma

ggplot(data = d) +
  geom_line(aes(t, .fitted)) +
  geom_point(aes(t, value)) +
  geom_ribbon(aes(x=t, ymin=.conf.low, ymax=.conf.up), linetype=2, alpha=0.2) +
  facet_wrap(vars(.rownames)) +
  xlab("") + ylab("standarized abundance index")+   theme_bw()
  #scale_x_continuous(breaks=seq(1,TT,10),labels=colnames(y)[seq(1,TT,10)])+

```

## Historical trends

We also fitted GAM over a period starting in 1975 to put the post-2000
trends in an historical perspective. For Germany and Danemark, time series are short and the
reader should refer to the previous section. For Spain, Great Britain, Norway and Ireland, the abundances
are very low with respect to the late 1970s levels (Figure \@ref(fig:gamSilverHist)).
However, the dynamic is slightly different among countries:

* an early decrease in the late 1970s in IE or GB and then a relative stability
* a decrease in the late 1980s in Spain and then a period of stability or small increase
* a rather monotonic decrease in Norway

In France, an increase is observed in the 1980s and then decreased.
Finally, and similarly to yellow eels, Sweden is the only country displaying an increase
of abundance, especially after the 1980s. 

```{r gamSilverHist, echo=FALSE,warning=FALSE, fig.cap="Trends per country in silver eel abundance estimated by a GAM"}
silver_data_std_gam=silver_data_gam%>%
#  filter(das_value>0) %>%
  mutate(das_value=das_value)%>%
  group_by(ser_id)%>%
  mutate(das_value=(das_value-mean(ifelse(das_year>=2000,
                                          das_value,
                                          NA),na.rm=TRUE))/sd(ifelse(das_year>=2000,
                                          das_value,
                                          NA),na.rm=TRUE))


#g0 <- gam(das_value~s(das_year), data=silver_data_std_gam)
g1 <- gam(das_value~s(das_year, by=ser_cou_code), data=silver_data_std_gam, family = gaussian())
#g2 <- gam(das_value~s(das_year, by=ser_nameshort), data=silver_data_std_gam)

cou_code <- levels(droplevels (yellow_data_std_gam$ser_cou_code))
cols<-colorRampPalette(c("chartreuse", "grey",  "navy"),space = "rgb")(length(cou_code))

silver_gam_plot=generate_dataset_plot_gam(g1)
ggplot(silver_gam_plot,aes(x=year,y=pred))+
  geom_line()+
  geom_ribbon(aes(ymin=lower,ymax=upper),alpha=.3)+
  facet_wrap(.~cou_code,scales="free_y")+
  scale_colour_manual(values=cols)+
  scale_fill_manual(values=cols)+
  theme_bw()+ ylab("relative abundance")

```




# Discussion / Conclusion
Yellow and silver eels time series of abundance have been collected in at least 14 countries
all over Europe for as long as nearly 1 century. This analysis is a first intent to analyse the 
provided data. As explained in the introduction, such as analysis is complex
du to the complexity of the life of the species and its fractal dimension during
the continental growth phase [@dekker2000a].

Two complementary analyses were used: a DFA analysis to depict common trends in the 
recent period and a GAM analysis on the long term. In the short term, while the majority
of the time series indicate a declining trend of abundance, this general picture hinders
very contrasted situations and increases of abundance of yellow eels and silver eels
have been observed in some river basins. This contrast is likely to be related to
different conditions (environmental conditions, anthropogenic pressures,
management practices) among river basins and there is no clear spatial pattern
in the trends. Interestingly, while a shift of trend was detected for yellow eel
around 2007 (trend 2), this shift occurred before or just after the implementation
of the Eel Regulation so that the Regulation cannot be the only direct cause. 
Various reasons may explain such a shift such as changes in management practices,
changes in monitoring protocol in anticipation or in response to Eel Management 
Plan, but also changes in local environmental conditions. On the
whole, since other trends are nearly monotonic, it suggests that the Eel
Regulation has not led to major changes in the abundance of yellow and 
silver eels in these basins, but this is not necessarily a surprise since the growth phase 
last from 5 to 20 years depending on the habitats and sex [@vollestad1992].

The few available time series allow to put the recent trends into an historical perspective. 
Though results on the long old time should be taken with caution given the limited
time series, most of them display a decreasing trend since the 1975. Some variations
exist among countries. While the decrease starts as soon as the beginning of the period
in many countries, the decrease appears to start later in Spain. As such, it would have
occured about 5 years after the decline in recruitment, i.e. about the duration of the 
growth phase in southern Europe. France also shows an increase at the beginning of the time
series, but data only started in the mid 80s, so it is impossible to conclude for older years.
Moreover, this increase is concomitant with some increasing oscillations, for example in Ireland,
so this may have been a temporary situation. Sweden display atypical increasing trends compared
to other countries. It is difficult to conclude on the reasons of these trends, but we can 
suggest that fishery closure in Western Sweden may have played a role, and restocking may also
have played a role (though it occurs mainly in Inland EMUs).

As a first analysis, the results do provide a very partial overview of what have indeed happened. It would be worthwhile
collecting more series and carrying out further analysis to understand the reasons of these different trends. More
specifically, it would be interesting to analyse whether the distance to the sea (data
not available currently) plays a role in the results. Other factors, such as monitoring
method or particular management measure (restocking, barrier’s mitigation, fishery closure, …) may also be analysed. As a next step, it would be worthwhile comparing trends with
recruitment and mortalities estimates in each EMU.


```{r summaryData}
all_series = bind_rows(silver_dataall,yellow_dataall) %>%
  group_by(ser_id,ser_nameshort,ser_cou_code,
           lfs_code,
         type,
         ser_uni_code,
         ser_hty_code) %>%
  summarize(first_year=min(das_year,na.rm=TRUE),
            last_year=max(das_year,na.rm=TRUE),
            npres=sum(!(is.na(das_year)))) %>%
  mutate(nmissing=1+last_year-first_year-npres) %>%
  mutate(usedshort=as.integer(ser_id %in% c(yellow_data$ser_id,
                                 silver_data$ser_id)),
         usedlong=ser_id %in% as.integer(c(yellow_data_std_gam$ser_id,
                                silver_data_std_gam$ser_id))) %>%
  ungroup() %>%
  select(ser_nameshort,
         ser_cou_code,
         first_year,
         last_year,
         npres,
         nmissing,
         lfs_code,
         type,
         ser_uni_code,
         ser_hty_code,
         usedshort,
         usedlong) %>%
  arrange(lfs_code,
          ser_cou_code,ser_nameshort)

colheader=c("code","country","min","max","n+","n-",
           "life stage","sampling type","unit",
           "habitat","kept short","kept long")
names(colheader)=names(all_series)
ft=flextable(all_series) %>%
  set_header_labels(values=colheader)
autofit(ft)
  
```

# References