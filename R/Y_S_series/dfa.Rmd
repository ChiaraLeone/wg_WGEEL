---
title: "DFA yellow and silver eels"
author: "ICES Data Group"
date: "18/08/2020"
bibliography: references_dfa.bib
documentclass: article
output: 
  bookdown::html_document2:
    fig_caption: yes
    number_sections: yes
params:
  rerunDFA: FALSE
---

```{r setup, include=FALSE}
load_library=function(necessary) {
	if(!all(necessary %in% installed.packages()[, 'Package']))
		install.packages(necessary[!necessary %in% installed.packages()[, 'Package']], dep = T)
	for(i in 1:length(necessary))
		library(necessary[i], character.only = TRUE)
}

knitr::opts_chunk$set(echo = TRUE)
username = Sys.info()[["user"]]
if (username=="hilaire.drouineau"){
  setwd("/home/hilaire.drouineau/Documents/Bordeaux/migrateurs/WGEEL/github/wg_WGEEL/R/Y_S_series/")
}
load_library("gridExtra")
load_library("MARSS")
load_library("xtable")
load_library("getPass")
load_library("RPostgreSQL")
load_library("sf")
load_library("broom")
load_library("eulerr")
load_library("dplyr")
load_library("knitr")
load_library("ggplot2")
load_library("ggmap")
load_library("tidyverse")
load_library("rnaturalearth")
load_library("parallel")
load_library("mgcv")
con_wgeel=dbConnect(PostgreSQL(),
                    dbname="wgeel",
                    host="localhost",
                    port=5435,
	                  user= getPass(msg="username"),
	                  password= getPass())
CY<-2020 # current year ==> dont forget to update the graphics path below (

format_dfa =function(the.fit){
  H.inv=1
  Z.est = coef(the.fit, type="matrix")$Z
  if(ncol(Z.est)>1) H.inv = varimax(Z.est)$rotmat
  #rotate factor loadings
  Z<-coef(the.fit,type="matrix")$Z%*%H.inv
  #rotate trends
  trends<-solve(H.inv)%*%the.fit$states
  scale_val=coef(the.fit)$A
  list(Z=Z,trends=trends,scale_val=scale_alpha)
}

#a function to display nice Venn diagram
venn <- function(nameseries,Z,minZ){
  nameseries=as.character(nameseries)
  list_venn=do.call(c,lapply(1:(dim(Z)[2]),function(j){
    res=list(nameseries[which(Z[,j]>minZ)],nameseries[which(Z[,j]< -minZ)])
    names(res)=paste("Trend",j,c("+","-"),sep="")
    res
  }))
  list_venn$Any =nameseries[!nameseries %in%unlist(list_venn)]
  euler_fit<-euler(list_venn)
  lab=sapply(names(euler_fit$original.values),function(n){
    groups=strsplit(n,"&")[[1]]
    group_not=names(list_venn)[!names(list_venn) %in%groups]
    okgroup = apply(sapply(groups,function(g) nameseries %in% list_venn[[g]]),
            1,
            prod) 
    oknotgroup=1
    if(length(group_not)>0){
      oknotgroup=apply(sapply(group_not,
                              function(g) !nameseries %in% list_venn[[g]]),
            1,
            prod)
    }
    paste(nameseries[as.logical(
      okgroup*oknotgroup)],
      collapse="\n")
  })
   eulerr_options(quantities=list(cex=.6))
  plot(euler_fit,quantities=lab)
}


venn_belonging <- function(nameseries,Z,minZ){
  nameseries=as.character(nameseries)
  list_venn=do.call(c,lapply(1:(dim(Z)[2]),function(j){
    res=list(nameseries[which(Z[,j]>minZ)],nameseries[which(Z[,j]< -minZ)])
    names(res)=paste("Trend",j,c("+","-"),sep="")
    res
  }))
  list_venn$Any =nameseries[!nameseries %in%unlist(list_venn)]
  sapply(nameseries,function(ser) 
    paste(names(list_venn)[sapply(names(list_venn),
           function(g) ifelse(ser %in% list_venn[[g]], TRUE,FALSE))],
          collapse="; "))
}

generate_dataset_plot_gam = function(model){
  cou_code=levels(droplevels (model$model$ser_cou_code))
  
  do.call('rbind.data.frame',lapply(cou_code, function(cou){
    year_range= range(model$model$das_year[model$model$ser_cou_code==cou],
                      na.rm=TRUE)
    years=year_range[1]:year_range[2]
    pred=predict(model,data.frame(das_year=years,ser_cou_code=cou),
            se.fit=TRUE)
    data.frame(year=years,
               cou_code=cou,
                 pred=pred$fit,
               lower=pred$fit-1.96*pred$se.fit,
               upper=pred$fit+1.96*pred$se.fit)
    
    }))
  
}

```

```{r data loading, include=FALSE}
query='SELECT 
		das_id,
		das_value,       
		das_year,
		das_comment,
		ser_id,            
		cou_order,
		ser_nameshort,
		ser_area_division,
		ser_qal_id,
    ser_hty_code,
    ser_emu_nameshort,
    ser_cou_code,
    ser_comment,
    ser_sam_id,
		das_qal_id,
		das_last_update,
		f_subarea,
		lfs_code,          
		lfs_name
		from datawg.t_dataseries_das 
		join datawg.t_series_ser on das_ser_id=ser_id
		left join ref.tr_lifestage_lfs on ser_lfs_code=lfs_code
		left join ref.tr_faoareas on ser_area_division=f_division
        left join ref.tr_country_cou on cou_code=ser_cou_code
		where ser_typ_id in (2,3) and das_value is not null'
mydata = dbGetQuery(con_wgeel,query)
mydata$ser_nameshort=as.factor(mydata$ser_nameshort)
mydata$ser_area_division=as.factor(mydata$ser_area_division)
mydata$f_subarea=as.factor(mydata$f_subarea)
mydata$lfs_code=as.factor(mydata$lfs_code)
mydata$ser_cou_code=as.factor(mydata$ser_cou_code)
mydata$ser_emu_nameshort=as.factor(mydata$ser_emu_nameshort)
mydata$lfs_name=as.factor(mydata$lfs_name)
mydata$ser_hty_code=as.factor(mydata$ser_hty_code)


silver_dataall <- mydata %>%
  filter(lfs_code=="S")
yellow_dataall <- mydata %>%
  filter(lfs_code=="Y")
yellow_map=st_read(con_wgeel,query=paste("select ser_id,geom from datawg.t_series_ser where ser_id in (", paste(unique(yellow_dataall$ser_id),collapse=","),")",sep=""))
silver_map=st_read(con_wgeel,query=paste("select ser_id,geom from datawg.t_series_ser where ser_id in (", paste(unique(silver_dataall$ser_id),collapse=","),")",sep=""))

dbDisconnect(con_wgeel)

```


# Introduction
Several time series of abundance of yellow eels and silver eels are collected
throughout Europe. However, the analysis of their trends is more complex than
for glass eel time-series since yellow and silver abundances are the results of
both the general status of the population and local conditions (environmental
condition, anthropogenic pressures, life history traits, management actions...)
in river basins in which they are collected [@ices2014]. Despite these
difficulties, it would be interesting to detect whether some common trends exist
among the available data series and whether they can be related to monitoring
methods, locations of the data or other factors. This would be a first
exploration step before moving forward in a potential assessment of the standing
stock. In this context, we carry out a dynamic Factor Analysis, a multivariate
method aiming at detecting common trends in a set of time-series [@zuur2003a].
Similary to glass-eel recruitment models, we restricted the data set to times
series for which at least 10 years of data were available and carry out silver
eel and yellow eel analysis separetely.

# Yellow eel
## Available data
`r length(unique(yellow_dataall$ser_id))` time series are available (Figure \@ref(fig:mapyellow)), originating from `r length(unique(yellow_dataall$ser_cou_code))` countries and `r length(unique(yellow_dataall$ser_emu_nameshort))` EMUs. Most of them are located in the Bristish Islands or France. `r length(unique(yellow_dataall$ser_id[yellow_dataall$ser_hty_code=="C"]))` time series are collected in coastal waters, `r length(unique(yellow_dataall$ser_id[yellow_dataall$ser_hty_code=="T"]))` in transitional waters and `r length(unique(yellow_dataall$ser_id[yellow_dataall$ser_hty_code=="F"]))` in freshwater.

```{r mapyellow,echo=FALSE,message=FALSE,warning=FALSE,fig.cap="Map of available yellow time series"}
 worldmap <- ne_countries(scale = 'medium', type = 'map_units',
                          returnclass = 'sf')
 europe_cropped <- st_crop(worldmap, xmin = -13, xmax = 27,
                                     ymin = 35, ymax = 65)
# ggplot(yellow_map)+geom_sf(data=europe_cropped)+geom_sf(data=yellow_map,col="red")+
#   theme_bw()
knitr::include_graphics("images/yellow.png")
```

## Trends after 2000
There are few data series started before 2000 (Figure \@ref(fig:pointperyearYE)) so we restrict the analysis to the dataseries that have at least 10 observations after 2000 and stops in 2019 to avoid incomplete data in 2020. 

```{r pointperyearYE,echo=FALSE, fig.cap="number of yellow eel time series available per year"}
point_per_year_YE<- yellow_dataall %>%
  group_by(das_year) %>%
  summarize(n=n_distinct(ser_id))

ggplot(point_per_year_YE,aes(y=n,x=das_year))+
  geom_line()+
  xlab("")+ylab("number of available data")+
  theme_bw()

#For GAMS, we do not restrict to the post 2000 period
#we keep only data with at least 10 years
nbpointsgam = yellow_dataall %>%
  filter(das_year>=1975)%>%
  group_by(ser_id) %>%
  summarise(nbyear=n_distinct(das_year))%>%
  filter(nbyear>=10)
yellow_data_gam <-yellow_dataall %>%
  filter(ser_id %in% nbpointsgam$ser_id & das_year>=1975 & das_year <= 2019)

#we also removed ser_id for which 0 represents more than 10% of data
yellow_data_gam <- yellow_data_gam %>%
  group_by(ser_id) %>%
  mutate(nb_values=n(),nb_zeros=sum(das_value==0)) %>%
  mutate(freq_zero=nb_zeros/nb_values)%>%
  filter(freq_zero < .1)

#we keep only data with at least 10 years
nbpoints = yellow_dataall %>%
  filter(das_year>=2000)%>%
  group_by(ser_id) %>%
  summarise(nbyear=n_distinct(das_year))%>%
  filter(nbyear>=10)
yellow_data <-yellow_dataall %>%
  filter(ser_id %in% nbpoints$ser_id & das_year>=2000 & das_year <= 2019)

#we also removed ser_id for which 0 represents more than 10% of data
yellow_data <- yellow_data %>%
  group_by(ser_id) %>%
  mutate(nb_values=n(),nb_zeros=sum(das_value==0)) %>%
  mutate(freq_zero=nb_zeros/nb_values)%>%
  filter(freq_zero < .1)



```

This leaves `r length(unique(yellow_data$ser_id))` time series. If we plot all the series, a gam smoother indicates an overall decreasing trend (Figure \@ref(fig:plotTSYE)).

```{r plotTSYE,echo=FALSE,warning=FALSE, fig.cap="Yellow eel time series and gam smoother"}
yellow_data_std=yellow_data%>%
  mutate(das_value=log(das_value))%>%
  group_by(ser_id)%>%
  mutate(das_value=(das_value-mean(das_value,na.rm=TRUE))/sd(das_value,na.rm=TRUE))

ggplot(yellow_data_std,aes(x=das_year,y=das_value))+
  geom_line(aes(col=as.factor(ser_nameshort)))+
  geom_smooth(method="gam")+theme_bw()+xlab("year")+
  ylab("Standardised abundance index (log scale)")
```

When plotted per country, a simple gam smoother shows descreating and
stabilizing curves in  FR, NL, the same with a more pronounced increase after
2012 for DK, ES, a linear decrease in IE, GB, and an increase for
NO SE, with a more complex curve for SE (Figure \@ref(fig:gamYellow)). The trend correspdond to log
transformed and scaled values.

```{r gamYellow, echo=FALSE,warning=FALSE, fig.cap="Trends per country in yellow eel abundance estimated by a gam"}
g0 <- gam(das_value~s(das_year), data=yellow_data_std)
g1 <- gam(das_value~s(das_year, by=ser_cou_code), data=yellow_data_std)
#g2 <- gam(das_value~s(das_year, by=ser_nameshort), data=yellow_data_std)
cou_code <- levels(droplevels (yellow_data_std$ser_cou_code))
#AIC(g0, g1, g2)

cols<-colorRampPalette(c("chartreuse", "grey",  "navy"),space = "rgb")(length(cou_code))

yellow_gam_plot_recent=generate_dataset_plot_gam(g1)
ggplot(yellow_gam_plot_recent,aes(x=year,y=pred))+
  geom_line(aes(col=cou_code))+
  geom_ribbon(aes(ymin=lower,ymax=upper,fill=cou_code),alpha=.3)+
  facet_wrap(.~cou_code,scales="free_y")+
  scale_colour_manual(values=cols)+
  scale_fill_manual(values=cols)+
  theme_bw()+ ylab("relative abundance (log scale)")

```


```{r,include=FALSE}
kable(nb_per_country <- yellow_data %>%
				group_by(ser_cou_code) %>%
				summarize(N=n(),Nseries=n_distinct(ser_id)) %>%
				dplyr::rename(Country=ser_cou_code))
```



### Running the DFA
The DFA method is fully detailed in [@zuur2003]. The basic idea is to decompose each time series into a weighted sum of a few common trends and a noise factor:
$$
\begin{aligned}
Y_{j,t}=\mu_j + \sum_{i=1}^{n} w_{i,j} \cdot X_{i,t} +\epsilon_{j,t} \qquad \mbox{ with } \left \{ \epsilon_{j,t} \right \}  \sim N(0,\Sigma)
\end{aligned}
$$
with $Y_{j, t}$ the value of the series $j$ at time $t$, $\mu_j$ an intercept, $n the number of common trends, $w_{i, j}$ the weight of trend $i$ in the series $j$, $X_{i,t}$ the value of trend $i$ at time $t and $\epsilon_{j,t}$ a normal noise, potentially correlated between series through the variance covariance matrix $\Sigma$ . Therefore, $X_{i,t}$ represent the trends common to the series and are modelled as random walks:
$$
\begin{aligned}
X_{i,t}=X_{i,t-1}+f_{i,t} \qquad \mbox{ with } f_{i,t} \sim N(0,Q)
\end{aligned}
$$

with $f_{i,t} the noise on the trend $i$ at time $t$ which follows a normal law, possibly correlated between trends with the covariance covariance matrix $Q$ which can be set to the identity matrix [@zuur2003a].
The method thus allows both to extract the common trends through the estimates of $X$, but also to see to what extent each of the importance of each trend in each series through $w$.

To fit the DFA, the user as to put some additionnal constraints. We will make 3 kind of assumptions on $\Sigma$:
* $\Sigma$ is a diagonal matrix with equal elements in the diagonal (e.g. time series are independent with similar values of noise)
* $\Sigma$ is a diagonal matrix with unequal elements in the diagonal (e.g. time series are independent with different values of noise)
* $\Sigma$ is a unconstrained (e.g. time series are potentially not independent with different values of noise) (this solution was not tested for Yellow eel since the number of time series was too large compared to the number of observations)
1 to 4 common trends are tested. The best combination of $\Sigma$ and number of trends is chosen by comparing AICc criterion. 


### Common trends
Before running the DFA, values were logtransformed (few 0 value were recorded and were replaced by 10% of the lower value of the series) and scales ((mean deleted and divided by the standard deviation)).

```{r dfa yellow, results='hide',eval=FALSE}
if (params$rerunDFA){
  #replace 0 value
  list_zeros <- which(yellow_data$das_value == 0)
  for (i in list_zeros){
    ser_id=yellow_data$ser_id[i]
    yellow_data$das_value[i] <- 0.1 *
      min(yellow_data$das_value[yellow_data$das_value>0 & 
                                  yellow_data$ser_id == ser_id],na.rm=TRUE)
  }
  
  #put data in wide format and select from 1980
  yellow_wide <-yellow_data %>%
    ungroup %>% #removed the ser_id grouping
    mutate(das_value=log(das_value))%>%
    select(ser_nameshort,das_value,das_year) %>%
    arrange(das_year)%>%
    pivot_wider(id_cols=c(ser_nameshort,das_year),names_from=das_year,values_from=das_value)
  
  #then we scaled time series (substract the mean and divide by standard deviation)
  yellow_wide[,-1] <- sweep(yellow_wide[,-1],1,rowMeans(yellow_wide[,-1],na.rm=TRUE),"-")
  yellow_wide[,-1] <- sweep(yellow_wide[,-1],1,apply(yellow_wide[,-1],1,sd,na.rm=TRUE),"/")
  
  
  #Define some constants
  N_ts=nrow(yellow_wide) #number of time series
  TT=ncol(yellow_wide)-1 #number of time steps
  y=as.matrix(yellow_wide[,-1]) #matrix of obseravation
  rownames(y)=yellow_wide$ser_nameshort
  
  #Design of experiments
  #S=c("diagonal and equal","diagonal and unequal","unconstrained")
  S=c("diagonal and equal","diagonal and unequal")
  nbtrend=1:4
  expe=expand.grid(S=S,nbtrend=nbtrend)
  
  #Now we make a loop of DFA to find the best model
  model_comparisonsYE= mcmapply(function(s,m){
    dfa.model=list(R=s, m=m)
    kemz=MARSS(y, model=dfa.model, form="dfa",z.score=TRUE,control=list(maxit=2000))
    aicc=MARSSaic(kemz, output="AICc")$AICc
    aic=MARSSaic(kemz, output="AIC")$AIC
    list(Trends=m,AICc=aicc,AIC=aic,Sigma=s,dfa=kemz)
  },as.character(expe$S),expe$nbtrend, mc.cores=4,SIMPLIFY=FALSE)
  
    results_yellow=do.call(rbind.data.frame,lapply(model_comparisonsYE,function(x) {
    data.frame(Trends=x["Trends"],
               Sigma=x["Sigma"],
               AIC=x["AIC"],
               AICc=x["AICc"])})
  )
  save.image(file="./dfa.rdata")
}
```

Two common trends were estimated after selection by AIC criterion (Table \@ref(tab:comparisonYE) and Figure \@ref(fig:trendsyellow)).

```{r comparisonYE,echo=FALSE}
load("./dfa.rdata")
knitr::kable(results_yellow,digits=2,caption="Model comparisons for yellow eel DFA")
best_fit_yellow=model_comparisonsYE[[which(results_yellow$AIC==min(results_yellow$AIC))]]$dfa
```


```{r trendsyellow, echo=FALSE, fig.cap="Estimated common trends in yellow eel time series"}
N_ts=nrow(yellow_wide) #number of time series
TT=ncol(yellow_wide)-1 #number of time steps
y=as.matrix(yellow_wide[,-1]) #matrix of obseravation
rownames(y)=yellow_wide$ser_nameshort

formatted_matrices_yellow=format_dfa(best_fit_yellow)

namesseries=yellow_wide$ser_nameshort

trends=formatted_matrices_yellow$trends
Z=formatted_matrices_yellow$Z
#plot the factor loadings
minZ = 0.1
m=dim(trends)[1]

trends_long <- as.data.frame(t(trends))
names(trends_long)=paste("Trend",1:ncol(trends_long))
trends_long$year=as.numeric(names(yellow_wide)[-1])
trends_long<-trends_long %>%
  pivot_longer(starts_with("Trend"),names_to="Trend")
ggplot(trends_long,aes(x=year,y=value))+
  geom_line()+
  facet_wrap(.~Trend)+
  theme_bw()

```

Trend 1 shows a monotonous trend over the period while trend 2 indicates a shift after 2007.

The factor loadings are displayed in the following plots (Figure \@ref(fig:seriesloadingsYE)). Following @zuur2003, we only focused on loading with absolute values greater than 0.1 to focus on the most important trends and presented on a Venn diagram (Figure \@ref(fig:vennyellow))


```{r seriesloadingsYE, echo=FALSE,fig.cap="Factor loadings of the yellow eel DFA"}
ylims = c(-1.1*max(abs(Z)), 1.1*max(abs(Z)))
par(mfrow=c(ceiling(m/2),2), mar=c(0.5,2.5,1.5,0.5), oma=c(0.4,1,1,1))
for(i in 1:m) {
    #plot(c(1:N_ts)[abs(Z[,i])>minZ], as.vector(Z[abs(Z[,i])>minZ,i]),
  #     type="h", lwd=2, xlab="", ylab="", xaxt="n", ylim=ylims, xlim=c(0,N_ts+1))
  plot(c(1:N_ts), as.vector(Z[,i]),
       type="h", lwd=2, xlab="", ylab="", xaxt="n", ylim=ylims, xlim=c(0,N_ts+1))
  for(j in 1:N_ts) {
    # if(Z[j,i] > minZ) {text(j, -0.05, namesseries[j], srt=90, adj=1, cex=0.5)}
    # if(Z[j,i] < -minZ) {text(j, 0.05, namesseries[j], srt=90, adj=0, cex=0.5)}
    if(Z[j,i] > 0) {text(j, -0.05, namesseries[j], srt=90, adj=1, cex=0.5,col=ifelse(Z[j,i]>minZ,2,1))}
    if(Z[j,i] < 0) {text(j, 0.05, namesseries[j], srt=90, adj=0, cex=0.5,col=ifelse(Z[j,i]< -minZ,2,1))}
    abline(h=0, lwd=1, col="gray")
  } # end j loop
  mtext(bquote(~italic(z[list(i,.(i))])),side=3,line=.5)
} # end i loop

# ##kept if two trends
# loadings_y = as.data.frame(Z[,1:2])
# names(loadings_y)=c("loading_trend_1","loading_trend_2")
# ggplot(loadings_y,aes(x=loading_trend_1,y=loading_trend_2))+
#   geom_point()+
#   theme_bw()
```

```{r vennyellow, echo=FALSE, fig.cap="Venn diagram of the yellow eel DFA"}
venn(namesseries,Z,minZ)
```


```{r spatialpatternAllYE,echo=FALSE,fig.cap="Spatial maps of yellow DFA loadings", warning=FALSE, message=FALSE, fig.width=10}
yellow_belonging=data.frame(ser_nameshort=namesseries,
                            Trend=venn_belonging(namesseries,
                                                 Z,
                                                 minZ))
yellow_belonging <- yellow_belonging %>%
  mutate(Trend1=ifelse(Z[,1]>minZ,"+",
                       ifelse(Z[,1]< -minZ, "-",0)),
         Trend2=ifelse(Z[,2]>minZ,"+",
                       ifelse(Z[,2]< -minZ, "-",0)))
yellow_belonging = merge(yellow_belonging,
                         unique(yellow_data[,c("ser_id","ser_nameshort")]))
yellow_belonging=merge(yellow_map,
                       yellow_belonging)
ggplot(yellow_belonging)+
  geom_sf(data=europe_cropped)+
  geom_sf(data=yellow_belonging,aes(fill=Trend,col=Trend))+
  scale_fill_brewer(type="qual")+
  scale_color_brewer(type="qual")+
  theme_bw()
```


```{r spatialpatternTrendsYE,echo=FALSE,fig.cap="Spatial maps of yellow DFA loadings", warning=FALSE, message=FALSE, fig.width=10}
yellow_belonging=data.frame(ser_nameshort=namesseries,
                            Trend=venn_belonging(namesseries,
                                                 Z,
                                                 minZ))
yellow_belonging <- yellow_belonging %>%
  mutate(Trend1=ifelse(Z[,1]>minZ,"+",
                       ifelse(Z[,1]< -minZ, "-",0)),
         Trend2=ifelse(Z[,2]>minZ,"+",
                       ifelse(Z[,2]< -minZ, "-",0)))
yellow_belonging = merge(yellow_belonging,
                         unique(yellow_data[,c("ser_id","ser_nameshort")]))
yellow_belonging=merge(yellow_map,
                       yellow_belonging)
t2<-ggplot(yellow_belonging)+
  geom_sf(data=europe_cropped)+
  geom_sf(data=yellow_belonging,aes(fill=Trend2,col=Trend2))+
  scale_fill_brewer(type="qual")+
  scale_color_brewer(type="qual")+
  theme_bw()

t1 <- ggplot(yellow_belonging)+
  geom_sf(data=europe_cropped)+
  geom_sf(data=yellow_belonging,aes(fill=Trend1,col=Trend1))+
  scale_fill_brewer(type="qual")+
  scale_color_brewer(type="qual")+
  theme_bw()
grid.arrange(t1,t2,ncol=2)
```


Many series are positively correlated to Trend 1 which that indicates a constant decline of the abundance since the 2000s (Figure \@ref(fig:vennyellow)). Some timeseries are negatively correlated to trend 2, but amont them, many are also positively correlated to trend2, indicating a slight increase or stability at the beginning of the period and then a decrease till 2007. Regarding time series dominated mostly by a negative correlation with trend 1 (i.e. a monotonic increase over the period), they all came from Great Britain, and half of them are located far from the coast. On the whole, it is difficult to distinguish any clear spatial pattern in the trends (Figures \@ref(fig:spatialpatternAllYE) and \@ref(fig:spatialpatternTrendsYE)).

The fits of the DFA model to the different time series is presented in Figure \@ref(fig:fitsyellow)



```{r fitsyellow, echo=FALSE,warning=FALSE, fig.cap="Yellow DFA fits to time series"}
d <- broom::augment(best_fit_yellow,interval="confidence")
ggplot(data = d) +
  geom_line(aes(t, .fitted)) +
  geom_point(aes(t, y)) +
  geom_ribbon(aes(x=t, ymin=.conf.low, ymax=.conf.up), linetype=2, alpha=0.2) +
  facet_wrap(vars(.rownames)) +
  xlab("") + ylab("standarized abundance index")+
  scale_x_continuous(breaks=seq(1,TT,10),labels=colnames(y)[seq(1,TT,10)])+
  theme_bw()
```


## Historical trends
We also fitted gam over a period starting in 1975 to put the post-2000
trends in an historical perspective. For many countries, data do not start before the 2000s, so the reader should refer
to the previous section (DE, DK, ES, FR). A decreasing trend is observed in most other countries
(NL, NO, IE, GB) except in Sweeden where an increasing trend is observed  (Figure \@ref(fig:gamYellowHist)).

```{r gamYellowHist, echo=FALSE,warning=FALSE, fig.cap="Trends per country in yellow eel abundance estimated by a gam "}
yellow_data_std_gam=yellow_data_gam%>%
  filter(das_value>0) %>%
  mutate(das_value=log(das_value))%>%
  group_by(ser_nameshort)%>%
  mutate(das_value=(das_value-mean(ifelse(das_year>=2000,
                                          das_value,
                                          NA),na.rm=TRUE))/sd(ifelse(das_year>=2000,
                                          das_value,
                                          NA),na.rm=TRUE))


g0 <- gam(das_value~s(das_year), data=yellow_data_std_gam)
g1 <- gam(das_value~s(das_year, by=ser_cou_code), data=yellow_data_std_gam)
#g2 <- gam(das_value~s(das_year, by=ser_nameshort), data=yellow_data_std_gam)
#AIC(g0, g1, g2)
cou_code <- levels(droplevels (yellow_data_std_gam$ser_cou_code))

cols<-colorRampPalette(c("chartreuse", "grey",  "navy"),space = "rgb")(length(cou_code))

yellow_gam_plot=generate_dataset_plot_gam(g1)
ggplot(yellow_gam_plot,aes(x=year,y=pred))+
  geom_line(aes(col=cou_code))+
  geom_ribbon(aes(ymin=lower,ymax=upper,fill=cou_code),alpha=.3)+
  facet_wrap(.~cou_code,scales="free_y")+
  scale_colour_manual(values=cols)+
  scale_fill_manual(values=cols)+
  theme_bw()+ ylab("relative abundance (log scale)")


```



# Silver eel
## Available data
`r length(unique(silver_dataall$ser_id))` time series are available (Figure \@ref(fig:mapsilver)), originating from `r length(unique(silver_dataall$ser_cou_code))` countries and `r length(unique(silver_dataall$ser_emu_nameshort))` EMUs. Most of them are located in Northern Europe. `r length(unique(silver_dataall$ser_id[silver_dataall$ser_hty_code=="C"]))` time series are collected in coastal waters and `r length(unique(silver_dataall$ser_id[silver_dataall$ser_hty_code=="F"]))` in freshwater, while the habitat type was not reported for .`r length(unique(silver_dataall$ser_id[is.na(silver_dataall$ser_hty_code)]))`

```{r mapsilver,echo=FALSE,message=FALSE,warning=FALSE,fig.cap="Map of available silver eel time series"}
# g=ggplot(silver_map)+geom_sf(data=europe_cropped)+geom_sf(data=silver_map,col="red")+
#  theme_bw()
# print(g)
knitr::include_graphics("images/silver.png")
```

## Trends since 2000
There are few data series started before 2000 so, as a first start, we restrict the analysis to the dataseries that have at least 10 observations after 2000 (Figure \@ref(fig:pointperyearSE)). 

```{r pointperyearSE,echo=FALSE, fig.cap="number of yellow eel time series available per year"}
point_per_year_SE<- silver_dataall %>%
  group_by(das_year) %>%
  summarize(n=n_distinct(ser_id))

ggplot(point_per_year_SE,aes(y=n,x=das_year))+
  geom_line()+
  xlab("")+ylab("number of available data")+
  theme_bw()


#For GAMS, we do not restrict to the post 2000 period
#we keep only data with at least 10 years
nbpointsgam = silver_dataall %>%
  filter(das_year>=1975)%>%
  group_by(ser_id) %>%
  summarise(nbyear=n_distinct(das_year))%>%
  filter(nbyear>=10)
silver_data_gam <-silver_dataall %>%
  filter(ser_id %in% nbpointsgam$ser_id & das_year>=1975 & das_year <= 2019)

#we also removed ser_id for which 0 represents more than 10% of data
silver_data_gam <- silver_data_gam %>%
  group_by(ser_id) %>%
  mutate(nb_values=n(),nb_zeros=sum(das_value==0)) %>%
  mutate(freq_zero=nb_zeros/nb_values)%>%
  filter(freq_zero < .1)


#we keep only data with at least 10 years
nbpoints = silver_dataall %>%
  filter(das_year>=2000)%>%
  group_by(ser_id) %>%
  summarise(nbyear=n_distinct(das_year))%>%
  filter(nbyear>=10)
silver_data <-silver_dataall %>%
  filter(ser_id %in% nbpoints$ser_id & das_year>=2000 & das_year<=2019)



#we also removed ser_id for which 0 represents more than 10% of data
silver_data <- silver_data %>%
  group_by(ser_id) %>%
  mutate(nb_values=n(),nb_zeros=sum(das_value==0)) %>%
  mutate(freq_zero=nb_zeros/nb_values)%>%
  filter(freq_zero < .1)

```

This leaves `r length(unique(silver_data$ser_id))` time series. If we plot all the series, a gam smoother indicates an overall decreasing trend (Figure \@ref(fig:plotTSSE)).


```{r plotTSSE,echo=FALSE,warning=FALSE, fig.cap="Silver eel time series and gam smoother"}
silver_data_std=silver_data%>%
  mutate(das_value=log(das_value))%>%
  group_by(ser_id)%>%
  mutate(das_value=(das_value-mean(das_value,na.rm=TRUE))/sd(das_value,na.rm=TRUE))

ggplot(silver_data_std,aes(x=das_year,y=das_value))+
  geom_line(aes(col=as.factor(ser_nameshort)))+
  geom_smooth(method="gam")+theme_bw()+xlab("year")+
  ylab("Standardised abundance index (log scale)")
```



When plotted per country, a simple gam smoother shows descreating trend in DK, FR, NO, the same but with a stabilization in GB (Figure \@ref(fig:gamSilver)). SE and ES display rather increasing trend, while IE is more stable. DE is erratic, especially because there are no data at the beginning of the period. The trend correspdond to log
transformed and scaled values.

```{r gamSilver, echo=FALSE,warning=FALSE, fig.cap="Trends per country in silver eel abundance estimated by a gam"}

g0 <- gam(das_value~s(das_year), data=silver_data_std)
g1 <- gam(das_value~s(das_year, by=ser_cou_code), data=silver_data_std)
#g2 <- gam(das_value~s(das_year, by=ser_nameshort), data=silver_data_std)
#AIC(g0, g1, g2)
cou_code <- levels(droplevels (silver_data_std$ser_cou_code))

cols<-colorRampPalette(c("chartreuse", "grey",  "navy"),space = "rgb")(length(cou_code))
silver_gam_plot_recent=generate_dataset_plot_gam(g1)
ggplot(silver_gam_plot_recent,aes(x=year,y=pred))+
  geom_line(aes(col=cou_code))+
  geom_ribbon(aes(ymin=lower,ymax=upper,fill=cou_code),alpha=.3)+
  facet_wrap(.~cou_code,scales="free_y")+
  scale_colour_manual(values=cols)+
  scale_fill_manual(values=cols)+
  theme_bw()+ ylab("relative abundance (log scale)")

```

```{r,include=FALSE}
kable(nb_per_country <- silver_data %>%
				group_by(ser_cou_code) %>%
				summarize(N=n(),Nseries=n_distinct(ser_id)) %>%
				dplyr::rename(Country=ser_cou_code))
```

### Running the DFA
We applied the same method as for yellow eel so readers can refer to the corresponding section for further details.

### Common trends
Before running the DFA, values were logtransformed (a 0 value was recorded for a single observation (time series SkaY) and was replaced by 10% of its lower value) and scales ((mean deleted and divided by the standard deviation)).

```{r dfa silver, results='hide',eval=FALSE}
if (params$rerunDFA){
  #put data in wide format and select from 1980
  silver_wide <-silver_data %>%
    ungroup(ser_id)%>%
    mutate(das_value=log(das_value))%>%
    select(ser_nameshort,das_value,das_year) %>%
    arrange(das_year)%>%
    pivot_wider(id_cols=c(ser_nameshort,das_year),names_from=das_year,values_from=das_value)
  
  #then we scaled time series (substract the mean and divide by standard deviation)
  silver_wide[,-1] <- sweep(silver_wide[,-1],1,rowMeans(silver_wide[,-1],na.rm=TRUE),"-")
  silver_wide[,-1] <- sweep(silver_wide[,-1],1,apply(silver_wide[,-1],1,sd,na.rm=TRUE),"/")
  
  
  #Define some constants
  N_ts=nrow(silver_wide) #number of time series
  TT=ncol(silver_wide)-1 #number of time steps
  y=as.matrix(silver_wide[,-1]) #matrix of obseravation
  rownames(y)=silver_wide$ser_nameshort
  
  #Design of experiments
  S=c("diagonal and equal","diagonal and unequal","unconstrained")
  #S=c("diagonal and equal","diagonal and unequal")
  nbtrend=1:4
  expe=expand.grid(S=S,nbtrend=nbtrend)
  
  #Now we make a loop of DFA to find the best model
  model_comparisonsSE= mcmapply(function(s,m){
    dfa.model=list(R=s, m=m)
    kemz=MARSS(y, model=dfa.model, form="dfa",z.score=TRUE,control=list(maxit=2000))
    if (kemz$convergence>0) kemz=MARSS(y, model=dfa.model, form="dfa",z.score=TRUE,control=list(maxit=2000),method="BFGS")
    aicc=MARSSaic(kemz, output="AICc")$AICc
    aic=MARSSaic(kemz, output="AIC")$AIC
    list(Trends=m,AICc=aicc,AIC=aic,Sigma=s,dfa=kemz,convergence=kemz$convergence==0)
  },as.character(expe$S),expe$nbtrend, mc.cores=4,SIMPLIFY=FALSE)
  
    results_silver=do.call(rbind.data.frame,lapply(model_comparisonsSE,function(x) {
    data.frame(Trends=x["Trends"],
               Sigma=x["Sigma"],
               AIC=x["AIC"],
               AICc=x["AICc"],
               convergence=x["convergence"])})
  )
  save.image(file="./dfa.rdata")
}
```
  
The model selection leads to the estimation of a single trend (Table \@ref(tab:comparisonSE) and Figure \@ref(fig:trendssilver))
  
```{r comparisonSE,echo=FALSE}
load("./dfa.rdata")
knitr::kable(results_silver,digits=2,caption="Model comparisons for silver eel DFA")
best_fit_silver=model_comparisonsSE[[which(results_silver$AIC==min(results_silver$AIC))]]$dfa
```
  
  
```{r trendssilver, echo=FALSE, fig.cap="Estimated common trend in silver eel time series"}
N_ts=nrow(silver_wide) #number of time series
TT=ncol(silver_wide)-1 #number of time steps
y=as.matrix(silver_wide[,-1]) #matrix of obseravation
rownames(y)=silver_wide$ser_nameshort

formatted_matrices_silver=format_dfa(best_fit_silver)

namesseries=silver_wide$ser_nameshort

trends=formatted_matrices_silver$trends
Z=formatted_matrices_silver$Z
#plot the factor loadings
minZ = 0.1
m=dim(trends)[1]

trends_long <- as.data.frame(t(trends))
names(trends_long)=paste("Trend",1:ncol(trends_long))
trends_long$year=as.numeric(names(silver_wide)[-1])
trends_long<-trends_long %>%
  pivot_longer(starts_with("Trend"),names_to="Trend")
  ggplot(trends_long,aes(x=year,y=value))+
    geom_line()+
    facet_wrap(.~Trend)+
    theme_bw()
  
```
  
  
  
The factor loadings are displayed in the Figure \@ref(fig:seriesloadingssilver) (importance of each trend in each time series) and corresponding Venn diagram in Figure \@ref(fig:vennsilver).
  
```{r seriesloadingssilver, echo=FALSE,fig.cap="Factor loadings of the silver eel DFA"}
ylims = c(-1.1*max(abs(Z)), 1.1*max(abs(Z)))
par(mfrow=c(ceiling(m/2),2), mar=c(0.5,2.5,1.5,0.5), oma=c(0.4,1,1,1))
for(i in 1:m) {
    #plot(c(1:N_ts)[abs(Z[,i])>minZ], as.vector(Z[abs(Z[,i])>minZ,i]),
  #     type="h", lwd=2, xlab="", ylab="", xaxt="n", ylim=ylims, xlim=c(0,N_ts+1))
  plot(c(1:N_ts), as.vector(Z[,i]),
       type="h", lwd=2, xlab="", ylab="", xaxt="n", ylim=ylims, xlim=c(0,N_ts+1))
  for(j in 1:N_ts) {
    # if(Z[j,i] > minZ) {text(j, -0.05, namesseries[j], srt=90, adj=1, cex=0.5)}
    # if(Z[j,i] < -minZ) {text(j, 0.05, namesseries[j], srt=90, adj=0, cex=0.5)}
    if(Z[j,i] > 0) {text(j, -0.05, namesseries[j], srt=90, adj=1, cex=0.5,col=ifelse(Z[j,i]>minZ,2,1))}
    if(Z[j,i] < 0) {text(j, 0.05, namesseries[j], srt=90, adj=0, cex=0.5,col=ifelse(Z[j,i]< -minZ,2,1))}
    abline(h=0, lwd=1, col="gray")
  } # end j loop
  mtext(bquote(~italic(z[list(i,.(i))])),side=3,line=.5)
} # end i loop
  
##kept if two trends
# loadings_y = as.data.frame(Z[,1:2])
# names(loadings_y)=c("loading_trend_1","loading_trend_2")
# ggplot(loadings_y,aes(x=loading_trend_1,y=loading_trend_2))+
#   geom_point()+
#   theme_bw()
```


```{r vennsilver, echo=FALSE, fig.cap="Venn diagram of the silver eel DFA"}
venn(namesseries,Z,minZ)
```


```{r spatialpatternAllSE,echo=FALSE,fig.cap="Spatial maps of silver DFA loadings", warning=FALSE, message=FALSE, fig.width=10}
silver_belonging=data.frame(ser_nameshort=namesseries,
                            Trend=venn_belonging(namesseries,
                                                 Z,
                                                 minZ))
silver_belonging <- silver_belonging %>%
  mutate(Trend1=ifelse(Z[,1]>minZ,"+",
                       ifelse(Z[,1]< -minZ, "-",0)))
silver_belonging = merge(silver_belonging,
                         unique(silver_data[,c("ser_id","ser_nameshort")]))
silver_belonging=merge(silver_map,
                       silver_belonging)
ggplot(silver_belonging)+
  geom_sf(data=europe_cropped)+
  geom_sf(data=silver_belonging,aes(fill=Trend1,col=Trend1))+
  scale_fill_brewer(type="qual")+
  scale_color_brewer(type="qual")+
  theme_bw()
```


About `r round(100*sum(silver_belonging$Trend=="Trend1+")/nrow(silver_belonging))`%  of the series are positively correlated to trend 1 indicating a decline in the abundance (Figure \@ref(fig:seriesloadingssilver)). However, about `r round(100*sum(silver_belonging$Trend=="Trend1-")/nrow(silver_belonging))`% are negatively correlated suggesting an increase, and about `r round(100*sum(silver_belonging$Trend=="Any")/nrow(silver_belonging))`% are not correlated to any trends, suggesting a stability. As for yellow eel, there are no obvious spatial pattern in the trends (Figure \@ref(fig:spatialpatternAllSE)).

DFA fits to data are presented in Figure \@ref(fig:fittsilver).

```{r fitssilver, echo=FALSE,warning=FALSE, fig.cap="Silver DFA fits to time series"}
d <- broom::augment(best_fit_silver,interval="confidence")
ggplot(data = d) +
  geom_line(aes(t, .fitted)) +
  geom_point(aes(t, y)) +
  geom_ribbon(aes(x=t, ymin=.conf.low, ymax=.conf.up), linetype=2, alpha=0.2) +
  facet_wrap(vars(.rownames)) +
  xlab("") + ylab("standarized abundance index")+
  scale_x_continuous(breaks=seq(1,TT,10),labels=colnames(y)[seq(1,TT,10)])+
  theme_bw()
```

## Historical trends

We also fitted gam over a period starting in 1975 to put the post-2000
trends in an historical perspective. For Germany and Danemark, time series are short and the
reader should refer to the previous section. For Spain, Great Britain, Norway and Ireland, the abundances
are very low with respect to the late 1970s levels (Figure \@ref(fig:gamSilverHist)).
However, the dynamic are slightly different among countries:

* an early decrease in the late 1970s in IE or GB and then a relateive stability
* a decrease in the late 80s in Spain and then a period of stability or small increase
* a rather monotonic decrease in Norway

In France, an increase is observed in the 1980s and then decreased, however for 
this country the y-scale has a limited range indicating that abundance is more stable than in other countries.
Finally, and similarly to yellow eel, Sweeden is the only country displaying an increase
of abundance, especially after the 1980s. 

```{r gamSilverHist, echo=FALSE,warning=FALSE, fig.cap="Trends per country in silver eel abundance estimated by a gam"}
silver_data_std_gam=silver_data_gam%>%
  filter(das_value>0) %>%
  mutate(das_value=log(das_value))%>%
  group_by(ser_id)%>%
  mutate(das_value=(das_value-mean(ifelse(das_year>=2000,
                                          das_value,
                                          NA),na.rm=TRUE))/sd(ifelse(das_year>=2000,
                                          das_value,
                                          NA),na.rm=TRUE))


g0 <- gam(das_value~s(das_year), data=silver_data_std_gam)
g1 <- gam(das_value~s(das_year, by=ser_cou_code), data=silver_data_std_gam)
#g2 <- gam(das_value~s(das_year, by=ser_nameshort), data=silver_data_std_gam)

cou_code <- levels(droplevels (yellow_data_std_gam$ser_cou_code))
cols<-colorRampPalette(c("chartreuse", "grey",  "navy"),space = "rgb")(length(cou_code))

silver_gam_plot=generate_dataset_plot_gam(g1)
ggplot(silver_gam_plot,aes(x=year,y=pred))+
  geom_line(aes(col=cou_code))+
  geom_ribbon(aes(ymin=lower,ymax=upper,fill=cou_code),alpha=.3)+
  facet_wrap(.~cou_code,scales="free_y")+
  scale_colour_manual(values=cols)+
  scale_fill_manual(values=cols)+
  theme_bw()+ ylab("relative abundance (log scale)")

```




# Discussion

A gam model per country does not accounts for the variability between sites.

# Conclusion
Yellow and silver eels time series of abundance have been collected in many countries all over Europe for many years. While the majority of the time series indicate a declining trend of abundance, this general picture hinders very contrasted situations and increases of abundance of yellow eels and silver eels have been observed in some river basins. This contrast is likely to be related to different conditions (environmental conditions, anthropogenic pressures, management practices) among river basins and there are no clear spatial pattern in the trends. Interestingly, while a shift of trend was detected for yellow eel around 2007 (trend 2), this shift occured before or just after the implementation of the Eel Regulation so that the Regulation can not be the only direct cause. Various reasons may explain such a shift such as changes in management practices, changes in monitoring protocol in anticipation or in response to Eel Management Plan, but also changes in local environmental conditions for some times. On the whole, cince other trends are nearly monotonic, it suggests that the Eel Regulation has not led to major changes in the abundance of yellow and silver eel, but this it not necessarily a surprise since the growth phase last from 5 to 20 years depending on the habitats and sex [@vollestad1992].
The few available time series allow to put the recent trend into an historical perspective. It shows that despite the recent heterogeneity in trends, yellow eel have decreased a lot since the 1960s


#References