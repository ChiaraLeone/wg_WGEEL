---
title: "Country report export for `r if (exists('params')) params$country else 'test'`"
author: "ICES Data Group"
date: "`r Sys.Date()`"
documentclass: article
output: 
  bookdown::html_document2:
    fig_caption: true
    number_sections: true
    toc: yes
    toc_depth: 3
    toc_float: true
params:
  year:
    label: "year start"
    value: 1960
    input: slider
    min: 1900
    max: 2020
    step: 1
    sep: ""
  country:   
    label: "Country"
    value: FR
    input: select
    choices: [FR, IE, SE]
  G:   
    label: "Glass eel"
    value: TRUE
  Y:   
    label: "Yellow eel"
    value: TRUE
  YS:   
    label: "Yellow silver eel"
    value: TRUE    
  S:   
    label: "Silver eel"
    value: TRUE
  Gr:   
    label: "Glass eel rec"
    value: TRUE
  Yr:   
    label: "Yellow eel rec"
    value: TRUE
  YSr:   
    label: "Yellow silver eel rec"
    value: TRUE    
  Sr:   
    label: "Silver eel rec"
    value: TRUE
  releaseG:   
    label: "Release G"
    value: TRUE
  releaseOG:   
    label: "Release OG"
    value: TRUE
  releaseQG:   
    label: "Release QG"
    value: TRUE
  releaseY:   
    label: "Release Y"
    value: TRUE
  releaseYS:   
    label: "Release YS"
    value: TRUE    
  releaseS:   
    label: "Release S"
    value: TRUE

---

```{r setup, include=FALSE}
require(knitr)
knitr::opts_chunk$set(echo = FALSE, warnings=FALSE, fig.width=12, fig.height=8)
opts_knit$set(eval.after = 'fig.cap' ) # to be used in chunks used only to plot pictures
options(knitr.table.format = 'pandoc') # options pour kable
options(knitr.kable.NA = '.')
my_pandoc_to <- knitr::opts_knit$get('rmarkdown.pandoc.to') # this variable will tell the kind of compilation used
CY=2020
getUsername <- function(){
	name <- Sys.info()[["user"]]
	return(name)
}
if (getUsername() == "cedric.briand") setwd("C:/workspace/gitwgeel/R/Rmarkdown") 
if (!exists("params")){
  warnings("You are not using Rstudio, params set in setup")
  params<-list("country"='FR',G=TRUE,Y=TRUE,YS=TRUE,S=TRUE,Gr=TRUE,Yr=TRUE,YSr=TRUE,Sr=TRUE,
			releaseG=TRUE, releaseY=TRUE,releaseQG=TRUE,releaseOG=TRUE,releaseYS=TRUE,releaseS=TRUE,
			year=1960)
}
```





```{r load_utilities, eval=TRUE, echo=FALSE,include=FALSE}

source("../utilities/load_library.R")

#-----------------
# other libraries
#-----------------
load_package("readxl")
load_package("stringr")
load_package("tidyverse")
load_package("rlang")
load_package("dplyr")
load_package("RColorBrewer")
load_package("scales")
load_package('stringr') # text handling
load_package("ggplot2") # for excel
load_package("gridExtra")
load_package("colorspace")
load_package("ggrepel")
load_package("viridis")
load_package("glue")
load_package("kableExtra")
load_package("pander")

# load functions ------------------------------------------------------------------------------------
# retrieve reference tables needed
# the shiny is launched from shiny_data_integration/shiny thus we need the ../
if(is.null(options()$sqldf.RPostgreSQL.user)) 
	source("../shiny_data_visualisation/shiny_dv/database_connection.R")
source("../shiny_data_visualisation/shiny_dv/database_reference.R")
source("../shiny_data_visualisation/shiny_dv/database_data.R")
source("../shiny_data_visualisation/shiny_dv/database_precodata.R")
source("../shiny_data_visualisation/shiny_dv/preco_diagram.R")
source("../shiny_data_visualisation/shiny_dv/graphs.R")
source("../shiny_data_visualisation/shiny_dv/maps.R")
source("../shiny_data_visualisation/shiny_dv/filter_and_group_functions.R")
source("../shiny_data_visualisation/shiny_dv/predict_missing.R")



load("../shiny_data_visualisation/shiny_dv/data/maps_for_shiny.Rdata") 
# now data are generated by the script load_data_from_the_database.R
load("../shiny_data_visualisation/shiny_dv/data/ref_and_eel_data.Rdata")
## Download the colors by country

values=c(RColorBrewer::brewer.pal(12,"Set3"),
		RColorBrewer::brewer.pal(12, "Paired"), 
		RColorBrewer::brewer.pal(8,"Accent"),
		RColorBrewer::brewer.pal(8, "Dark2"))
color_countries = setNames(values,country_ref$cou_code)
nrtable <-  0
nrfigure <- 0



```






```{r functions, echo=FALSE, warning=FALSE}

fun.agg<-function(X, scalef){
	if(length(X)>0){
		round(sum(X)/scalef,ifelse(sum(X)>scalef,0,3))
	}
	else{
		sum(c(X,NA))
	}
}
#dataset="landings"; country= 'IE';dataset="landings"; typ=4 ; life_stage="G"; habitat=NULL; year_range=1980:2020; geo="emu";grouphabitat=FALSE; grouplfs=FALSE
# table_pc(dataset="landings", country= 'FR', typ=4 , life_stage="G", habitat=NULL, year_range=1980:2020, geo="emu", grouphabitat=FALSE, grouplfs=FALSE)
library(ggthemes)
#' table per country, only pass one stage
table_pc <- function(country, 
		dataset, 
		typ=NULL, 
		life_stage = NULL, 
		habitat=NULL, 
		year_range = 1900:2100, 
		scalef=1){
	filtered_data <- filter_data(dataset = dataset,
			typ = typ,
			life_stage = life_stage,
			country = country,
			habitat = habitat,
			year_range = year_range
	) 
	if (nrow(filtered_data)>0){
	grouped_data <-group_data(filtered_data,
			geo = "emu",
			habitat = FALSE,
			lfs = FALSE,
			na.rm=TRUE)
    # dcast take a ... arguments and additional params can be passed to fun.aggreagate
	table <- dcast(grouped_data, 
			eel_year~eel_emu_nameshort, 
			value.var = "eel_value",
			fun.aggregate = fun.agg,
			scalef = scalef)
	
	table <- dplyr::rename(table, year="eel_year")
	table<-data.frame(table,
			Sum=rowSums(table[,-1],na.rm=T)
	)
	colnames(table)[2:(ncol(table)-1)]<-substr(colnames(table)[2:(ncol(table)-1)],4,10)
	
	the_kable <- kable(table,			
			digits=2)
	} else {
	the_kable <- kable(data.frame("warning"="no data"))  
	}
	return(the_kable)
}

# dataset="landings"; country= 'IE';dataset="landings"; typ=4 ; life_stage="Y"; habitat=NULL; year_range=1980:2020; 
# geo="emu";grouphabitat=FALSE; grouplfs=FALSE;  ylab. <- "Landings T"
#' plot per country only pass one stage
plot_pc <- function(country, dataset, 
		typ=NULL, 
		life_stage = NULL,
		habitat=NULL, 
		year_range = 1900:2100,	
		ylab.="Landings T", 
		scalef=1){
	filtered_data <- filter_data(dataset = dataset,
			typ = typ,
			life_stage = life_stage,
			country = country,
			habitat = habitat,
			year_range = year_range
	) 
	grouped_data <- group_data(filtered_data,
			geo = "emu",
			habitat = FALSE,
			lfs = FALSE,
			na.rm=TRUE)
	grouped_data$eel_value <- as.numeric(grouped_data$eel_value)/scalef
	grouped_data$eel_emu_nameshort = as.factor(grouped_data$eel_emu_nameshort)
	emus <- levels(grouped_data$eel_emu_nameshort)
	if (length(emus) <11) palette <- gdocs_pal()(length(emus)) else palette <- sequential_hcl(length(emus), "Viridis")
	#palette	[grep("total",emus)] <- "grey50"
	if (nrow(grouped_data) > 0) {
	gg <- 	ggplot(grouped_data) + 
			geom_col(aes(x=eel_year,y=eel_value,fill=eel_emu_nameshort), position='stack')+
			xlab("year") + 
			ylab(ylab.)+		
			scale_fill_manual(values=palette)+
	theme_gdocs()
} else {
	gg <- ggplot() +
			theme_void() +
			geom_text(aes(0,0,label='N/A')) +
			xlab(NULL)
}
	
	return(gg)
}
# dataset="release"; country= 'FR'; typ=9 ; life_stage=c("G","Y","QG","OG","YS","S"); habitat=NULL; year_range=1980:2020; 
# geo="emu";grouphabitat=FALSE; grouplfs=FALSE;
#' Table per country per lifestage.
table_pc_lfs <- function(country, dataset, typ = 9,
		life_stage=c("G","Y","QG","OG","YS","S"),  
		year_range = 1900:2100, 
		habitat=FALSE, 
		scalef=1){
	filtered_data <- filter_data(dataset = dataset,
			life_stage = life_stage,
			country = country,
			year_range = year_range
	) 
	if (nrow(filtered_data)>0){
		grouped_data <-group_data(filtered_data,
				geo = "emu",
				habitat = FALSE,
				lfs = TRUE,
				na.rm=TRUE)
		table = dcast(grouped_data, 
				eel_year~eel_emu_nameshort+eel_lfs_code, 
				value.var = "eel_value",
				fun.aggregate = fun.agg,
				scalef = scalef)
		
		table <- dplyr::rename(table, year="eel_year")
		table<-data.frame(table,
				Sum=rowSums(table[,-1],na.rm=T)
		)
		colnames(table)[2:(ncol(table)-1)]<-substr(colnames(table)[2:(ncol(table)-1)],4,10)
		
		the_kable <- kable(table,			
				digits=2)
	} else {
		the_kable <- kable(data.frame("warning"="no data"))  
	}
	return(the_kable)
}
#' Plot per country per life stage
plot_pc_lfs <- function(country, 
		dataset, 
		typ=NULL, 
		life_stage = NULL, 
		habitat=NULL, 
		year_range = 1900:2100, 
		ylab.="Landings T",  
		scalef=1){
	filtered_data <- filter_data(dataset = dataset,
			typ = typ,
			life_stage = life_stage,
			country = country,
			habitat = habitat,
			year_range = year_range
	) 
	grouped_data <- group_data(filtered_data,
			geo = "emu",
			habitat = FALSE,
			lfs = TRUE,
			na.rm=TRUE)
	grouped_data$eel_value <- as.numeric(grouped_data$eel_value)/scalef
	grouped_data$eel_emu_nameshort = as.factor(grouped_data$eel_emu_nameshort)
	emus <- levels(grouped_data$eel_emu_nameshort)
	if (length(emus) <11) palette <- gdocs_pal()(length(emus)) else palette <- sequential_hcl(length(emus), "Viridis")
	#palette	[grep("total",emus)] <- "grey50"
	if (nrow(grouped_data) > 0) {
		gg <- 	ggplot(grouped_data) + 
				geom_col(aes(x=eel_year,y=eel_value,fill=eel_emu_nameshort), position='stack')+
				xlab("year") + 
				ylab(ylab.)+		
				scale_fill_manual(values=palette)+
				facet_wrap(~eel_lfs_code)
				theme_gdocs()
	} else {
		gg <- ggplot() +
				theme_void() +
				geom_text(aes(0,0,label='N/A')) +
				xlab(NULL)
	}
	
	return(gg)
}



```


```{r G, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Landings commercial fisheries", level=1)
if (params$G){
	pandoc.header("Glass eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings G"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage="G",
			year_range=params$year:CY,
			scalef=1000 # in tons
			)
	print(res %>% kable_styling())
	
	nrfigure=nrfigure+1

	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage="G",
			year_range=1960:2020,
			scalef=1000
			)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings G"))
}
```
	
```{r Y, echo=FALSE, warning=FALSE, results="asis"}

if (params$Y){
	pandoc.header("Yellow eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage="Y",
			year_range=1960:2020, 
			scalef=1000
			)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1

	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage="Y",
			year_range=1960:2020, 		
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow"))
}
```

```{r YS, echo=FALSE, warning=FALSE, results="asis"}

if (params$YS){
	pandoc.header("Yellow silver", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow silver"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage=c("YS"),
			year_range=1960:2020, 
			scalef=1000)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1

	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage=c("YS"),
			year_range=1960:2020, 		
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow silver"))
}
```


```{r S, echo=FALSE, warning=FALSE, results="asis"}

if (params$S){
	pandoc.header("Silver eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Silver"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage=c("S"),
			year_range=1960:2020, 			
			scalef=1000)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1

	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage=c("S"),
			year_range=1960:2020, 			
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Silver"))
}
```


```{r Gr, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Landings Recreational fisheries", level=1)
if (params$Gr){
	pandoc.header("Glass eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings G recrational"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=6 , 
			life_stage="G",
			year_range=1960:2020, 
			scalef=1000
			)
	print(res %>% kable_styling())
	
	nrfigure=nrfigure+1

	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=6 , 
			life_stage="G",
			year_range=1960:2020, 
			scalef=1000
			)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings G"))
}
```
	
```{r Yr, echo=FALSE, warning=FALSE, results="asis"}

if (params$Yr){
	pandoc.header("Yellow eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=6 , 
			life_stage="Y",
			year_range=1960:2020,
			scalef=1000
)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1

	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=6 , 
			life_stage="Y",
			year_range=1960:2020, 
			scalef=1000
)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow recreational"))
}
```

```{r YSr, echo=FALSE, warning=FALSE, results="asis"}

if (params$YSr){
	pandoc.header("Yellow silver", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow silver recreational"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=6 , 
			life_stage=c("YS"),
			year_range=1960:2020, 
			scalef=1000)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=6 , 
			life_stage=c("YS"),
			year_range=1960:2020,
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow silver recreational"))
}
```


```{r Sr, echo=FALSE, warning=FALSE, results="asis"}

if (params$Sr){
	pandoc.header("Silver eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Silver recreational"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=6 , 
			life_stage=c("S"),
			year_range=1960:2020, 
			scalef=1000)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1

	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=6 , 
			life_stage=c("S"),
			year_range=1960:2020, 
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Silver recreational"))
}
```

```{r release, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Release", level=1)
# RELEASE IN NUMBER --------------------------
pandoc.header("In number", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : Release in millions"))
	res <- table_pc_lfs(dataset="release", 
			country=  params$country, 
			typ=9 , 
			life_stage=c("G","Y","QG","OG","YS","S")[
					c(params$releaseG, params$releaseY, params$releaseQG,
							params$releaseOG, params$releaseYS, params$releaseS)],

			year_range=1960:2020, 
			scalef=10^6
			)
	print(res %>% kable_styling())
# FIGURE -------------------------------	
	nrfigure=nrfigure+1

	gg <- plot_pc_lfs(dataset="release", 
			country= params$country, 
			typ=9 , 
			life_stage=c("G","Y","QG","OG","YS","S")[
					c(params$releaseG, params$releaseY, params$releaseQG,
							params$releaseOG, params$releaseYS, params$releaseS)],
			year_range=params$year:CY, 
			scalef=10^6,
			ylab.="Release in million"
	)
	pandoc.p(str_c("Figure ",nrfigure," : Release in million"))
	print(gg)
# RELEASE IN KG --------------------------	
	pandoc.header("In kg", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : Release in kg"))
	res <- table_pc_lfs(dataset="release", 
			country=  params$country, 
			typ=8 , 
			life_stage=c("G","Y","QG","OG","YS","S")[
					c(params$releaseG, params$releaseY, params$releaseQG,
							params$releaseOG, params$releaseYS, params$releaseS)],
			
			year_range=params$year:CY, 
			scalef=1
	)
	print(res %>% kable_styling())
	

	gg <- plot_pc_lfs(dataset="release", 
			country= params$country, 
			typ=8 , 
			life_stage=c("G","Y","QG","OG","YS","S")[
					c(params$releaseG, params$releaseY, params$releaseQG,
							params$releaseOG, params$releaseYS, params$releaseS)],
			year_range=params$year:CY, 
			scalef=,
			ylab.="Release in kg"
	)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : Release in kg"))


```