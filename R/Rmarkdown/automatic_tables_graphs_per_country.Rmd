---
title: "Country report export for `r if (exists('params')) params$country else 'test'`"
author: "ICES EIFAAC GFCM wgeel - Data Group"
date: "`r Sys.Date()`"
documentclass: article
output: 
  bookdown::html_document2:
    fig_caption: true
    number_sections: true
    toc: yes
    toc_depth: 3
    toc_float: true
params:
  year:
    label: "year start"
    value: 1960
    input: slider
    min: 1900
    max: 2020
    step: 1
    sep: ""
  country:   
    label: "Country"
    value: FR
    input: select
    choices: [FR, IE, SE, ES]
  area:
    label: Area
    value: "Elsewhere Europe"
    input: radio
    choices: ["Elsewhere Europe","North Sea"]
  G:   
    label: "Glass eel"
    value: TRUE
  Y:   
    label: "Yellow eel"
    value: TRUE
  YS:   
    label: "Yellow silver eel"
    value: TRUE    
  S:   
    label: "Silver eel"
    value: TRUE
  Gr:   
    label: "Glass eel rec"
    value: TRUE
  Yr:   
    label: "Yellow eel rec"
    value: TRUE
  YSr:   
    label: "Yellow silver eel rec"
    value: TRUE    
  Sr:   
    label: "Silver eel rec"
    value: TRUE
  releaseG:   
    label: "Release G"
    value: TRUE
  releaseOG:   
    label: "Release OG"
    value: TRUE
  releaseQG:   
    label: "Release QG"
    value: TRUE
  releaseY:   
    label: "Release Y"
    value: TRUE
  releaseYS:   
    label: "Release YS"
    value: TRUE    
  releaseS:   
    label: "Release S"
    value: TRUE
  map:
    label: "Draw maps"
    value: TRUE
    

---

```{r setup, include=FALSE}
require(knitr)
knitr::opts_chunk$set(echo = FALSE, warnings=FALSE, fig.width=12, fig.height=8, message=FALSE)
opts_knit$set(eval.after = 'fig.cap' ) # to be used in chunks used only to plot pictures
options(knitr.table.format = 'pandoc') # options pour kable
options(knitr.kable.NA = '.')
my_pandoc_to <- knitr::opts_knit$get('rmarkdown.pandoc.to') # this variable will tell the kind of compilation used
CY=2020
getUsername <- function(){
	name <- Sys.info()[["user"]]
	return(name)
}
if (getUsername() == "hilaire.drouineau") setwd("~/Documents/Bordeaux/migrateurs/WGEEL/github/wg_WGEEL/R/Rmarkdown/") 
if (getUsername() == "cedric.briand") setwd("C:/workspace/gitwgeel/R/Rmarkdown") 
if (!exists("params")){
	warnings("You are not using Rstudio or rmarkdown::render, params have been set by default setup")
	params <- list("country"='FR',G=TRUE,Y=TRUE,YS=TRUE,S=TRUE,Gr=TRUE,Yr=TRUE,YSr=TRUE,Sr=TRUE,
			releaseG=TRUE, releaseY=TRUE,releaseQG=TRUE,releaseOG=TRUE,releaseYS=TRUE,releaseS=TRUE,
			year=1960, area="Elsewhere Europe")
}
```





```{r load_utilities, eval=TRUE, echo=FALSE,include=FALSE}

source("../utilities/load_library.R")

#-----------------
# other libraries
#-----------------
load_package("readxl")
load_package("reshape2")
load_package("stringr")
load_package("tidyverse")
load_package("rlang")
load_package("dplyr")
load_package("RColorBrewer")
load_package("scales")
load_package('stringr') # text handling
load_package("ggplot2") # for excel
load_package("gridExtra")
load_package("colorspace")
load_package("ggrepel")
load_package("viridis")
load_package("glue")
load_package("kableExtra")
load_package("pander")
load_package("ggmap")


# load functions ------------------------------------------------------------------------------------
# retrieve reference tables needed
# the shiny is launched from shiny_data_integration/shiny thus we need the ../
if(is.null(options()$sqldf.RPostgreSQL.user)) 
	source("../shiny_data_visualisation/shiny_dv/database_connection.R")
source("../shiny_data_visualisation/shiny_dv/database_reference.R")
source("../shiny_data_visualisation/shiny_dv/database_data.R")
source("../shiny_data_visualisation/shiny_dv/database_precodata.R")
source("../shiny_data_visualisation/shiny_dv/preco_diagram.R")
source("../shiny_data_visualisation/shiny_dv/graphs.R")
source("../shiny_data_visualisation/shiny_dv/maps.R")
source("../shiny_data_visualisation/shiny_dv/filter_and_group_functions.R")
source("../shiny_data_visualisation/shiny_dv/predict_missing.R")



load("../shiny_data_visualisation/shiny_dv/data/maps_for_shiny.Rdata") 
# now data are generated by the script load_data_from_the_database.R
load("../shiny_data_visualisation/shiny_dv/data/ref_and_eel_data.Rdata")
## Download the colors by country
load("../shiny_data_visualisation/shiny_dv/data/recruitment/wger.Rdata")
load("../shiny_data_visualisation/shiny_dv/data/recruitment/wger_init.Rdata") # before selection process
load("../shiny_data_visualisation/shiny_dv/data/recruitment/statseries.Rdata")
load("../shiny_data_visualisation/shiny_dv/data/recruitment/glass_eel_yoy.Rdata")
load("../shiny_data_visualisation/shiny_dv/data/recruitment/older.Rdata")
load("../shiny_data_visualisation/shiny_dv/data/recruitment/R_stations.Rdata")
load("../shiny_data_visualisation/shiny_dv/data/recruitment/dat_ge.Rdata") ; # named dat_ge
load("../shiny_data_visualisation/shiny_dv/data/recruitment/dat_ye.Rdata") ; # named dat_ye
dat_ye$area <- "Yellow"
load("../shiny_data_visualisation/shiny_dv/data/recruitment/recruitment_models.Rdata") # named model_ge_area and model_older
values=c(RColorBrewer::brewer.pal(12,"Set3"),
		RColorBrewer::brewer.pal(12, "Paired"), 
		RColorBrewer::brewer.pal(8,"Accent"),
		RColorBrewer::brewer.pal(8, "Dark2"))
color_countries = setNames(values,country_ref$cou_code)
nrtable <-  0
nrfigure <- 0



```






```{r functions, echo=FALSE, warning=FALSE}

fun.agg<-function(X, scalef){
	if(length(X)>0){
		round(sum(X)/scalef,ifelse(sum(X)>scalef,0,3))
	}
	else{
		sum(c(X,NA))
	}
}
# dataset="landings"; country= 'ES';dataset="landings"; typ=6 ; life_stage="YS"; habitat=NULL; year_range=1980:2020; scalef=1000
# table_pc(dataset="landings", country= 'FR', typ=4 , life_stage="G", habitat=NULL, year_range=1980:2020)
library(ggthemes)
#' table per country, only pass one stage
table_pc <- function(country, 
		dataset, 
		typ=NULL, 
		life_stage = NULL, 
		habitat=NULL, 
		year_range = 1900:2100, 
		scalef=1){
	filtered_data <- filter_data(dataset = dataset,
			typ = typ,
			life_stage = life_stage,
			country = country,
			habitat = habitat,
			year_range = year_range
	) 
	if (nrow(filtered_data)>0){
		grouped_data <-group_data(filtered_data,
				geo = "emu",
				habitat = FALSE,
				lfs = FALSE,
				na.rm=TRUE)
		# dcast take a ... arguments and additional params can be passed to fun.aggreagate
		table <- dcast(grouped_data, 
				eel_year~eel_emu_nameshort, 
				value.var = "eel_value",
				fun.aggregate = fun.agg,
				scalef = scalef)
		
		table <- dplyr::rename(table, year="eel_year")
		if(ncol(table))
		table<-data.frame(table,
				Sum=rowSums(table[,-1,drop=FALSE],na.rm=T)
		)
		colnames(table)[2:(ncol(table)-1)]<-substr(colnames(table)[2:(ncol(table)-1)],4,10)
		
		the_kable <- kable(table,			
				digits=2)
	} else {
		the_kable <- kable(data.frame("warning"="no data"))  
	}
	return(the_kable)
}

# dataset="landings"; country= 'IE';dataset="landings"; typ=4 ; life_stage="Y"; habitat=NULL; year_range=1980:2020; 
# geo="emu";grouphabitat=FALSE; grouplfs=FALSE;  ylab. <- "Landings T"
#' plot per country only pass one stage
plot_pc <- function(country, dataset, 
		typ=NULL, 
		life_stage = NULL,
		habitat=NULL, 
		year_range = 1900:2100,	
		ylab.="Landings T", 
		scalef=1){
	filtered_data <- filter_data(dataset = dataset,
			typ = typ,
			life_stage = life_stage,
			country = country,
			habitat = habitat,
			year_range = year_range
	) 
	grouped_data <- group_data(filtered_data,
			geo = "emu",
			habitat = FALSE,
			lfs = FALSE,
			na.rm=TRUE)
	grouped_data$eel_value <- as.numeric(grouped_data$eel_value)/scalef
	grouped_data$eel_emu_nameshort = as.factor(grouped_data$eel_emu_nameshort)
	emus <- levels(grouped_data$eel_emu_nameshort)
	if (length(emus) <11) palette <- gdocs_pal()(length(emus)) else palette <- sequential_hcl(length(emus), "Viridis")
	#palette	[grep("total",emus)] <- "grey50"
	if (nrow(grouped_data) > 0) {
		gg <- 	ggplot(grouped_data) + 
				geom_col(aes(x=eel_year,y=eel_value,fill=eel_emu_nameshort), position='stack')+
				xlab("year") + 
				ylab(ylab.)+		
				scale_fill_manual(values=palette)+
				theme_gdocs()
	} else {
		gg <- ggplot() +
				theme_void() +
				geom_text(aes(0,0,label='N/A')) +
				xlab(NULL)
	}
	
	return(gg)
}
# dataset="release"; country= 'FR'; typ=9 ; life_stage=c("G","Y","QG","OG","YS","S"); habitat=NULL; year_range=1980:2020; 
# geo="emu";grouphabitat=FALSE; grouplfs=FALSE;
#' Table per country per lifestage.
table_pc_lfs <- function(country, dataset, typ = 9,
		life_stage=c("G","Y","QG","OG","YS","S"),  
		year_range = 1900:2100, 
		habitat=FALSE, 
		scalef=1){
	filtered_data <- filter_data(dataset = dataset,
			life_stage = life_stage,
			country = country,
			year_range = year_range
	) 
	if (nrow(filtered_data)>0){
		grouped_data <-group_data(filtered_data,
				geo = "emu",
				habitat = FALSE,
				lfs = TRUE,
				na.rm=TRUE)
		table = dcast(grouped_data, 
				eel_year~eel_emu_nameshort+eel_lfs_code, 
				value.var = "eel_value",
				fun.aggregate = fun.agg,
				scalef = scalef)
		
		table <- dplyr::rename(table, year="eel_year")
		table<-data.frame(table,
				Sum=rowSums(table[,-1],na.rm=T)
		)
		colnames(table)[2:(ncol(table)-1)]<-substr(colnames(table)[2:(ncol(table)-1)],4,10)
		
		the_kable <- kable(table,			
				digits=2)
	} else {
		the_kable <- kable(data.frame("warning"="no data"))  
	}
	return(the_kable)
}
#' Plot per country per life stage
plot_pc_lfs <- function(country, 
		dataset, 
		typ=NULL, 
		life_stage = NULL, 
		habitat=NULL, 
		year_range = 1900:2100, 
		ylab.="Landings T",  
		scalef=1){
	filtered_data <- filter_data(dataset = dataset,
			typ = typ,
			life_stage = life_stage,
			country = country,
			habitat = habitat,
			year_range = year_range
	) 
	grouped_data <- group_data(filtered_data,
			geo = "emu",
			habitat = FALSE,
			lfs = TRUE,
			na.rm=TRUE)
	grouped_data$eel_value <- as.numeric(grouped_data$eel_value)/scalef
	grouped_data$eel_emu_nameshort = as.factor(grouped_data$eel_emu_nameshort)
	emus <- levels(grouped_data$eel_emu_nameshort)
	if (length(emus) <11) palette <- gdocs_pal()(length(emus)) else palette <- sequential_hcl(length(emus), "Viridis")
	#palette	[grep("total",emus)] <- "grey50"
	if (nrow(grouped_data) > 0) {
		gg <- 	ggplot(grouped_data) + 
				geom_col(aes(x=eel_year,y=eel_value,fill=eel_emu_nameshort), position='stack')+
				xlab("year") + 
				ylab(ylab.)+		
				scale_fill_manual(values=palette)+
				facet_wrap(~eel_lfs_code)
		theme_gdocs()
	} else {
		gg <- ggplot() +
				theme_void() +
				geom_text(aes(0,0,label='N/A')) +
				xlab(NULL)
	}
	
	return(gg)
}


figure_recruitment <- function(){	
	
	# These values are standardized against the predictions in 1960s-1970s
	# the predictions are the predictions of the expand.grid(year,site,area)		
	# this is the North Sea or Elswhere Europe series
	
	the_series <-  	dat_ge[,c("year",
					"p", # predictions in the log scale for EE or NS series
					"mean", # mean of predictions 1960-1979 log scale
					"p_std_1960_1979", # scaled prediction exp(p-mean)
					"p_std_1960_1979_min",     
					"p_std_1960_1979_max",
					"p_std_1960_1979_maxgraph")]
	
	# extracting scaled value for the plot -------------------------------------------
	model_data <- model_ge_area$model 	
	df_coeff_site<- data.frame("site"=
					gsub("site","",names(coefficients(model_ge_area)[grep("site",names(coefficients(model_ge_area)))])),
			"co"= coefficients(model_ge_area)[grep("site",names(coefficients(model_ge_area)))]
	)
	
	
	selected <- model_data %>% 
			stacomirtools::killfactor()%>%
			left_join(df_coeff_site) %>%
			mutate(year=as.numeric(as.character(year_f))) %>% 
			mutate_at(c("co"),replace_na, replace = 0) %>% 
			full_join(                             
					dat_ge[,c("year",
									"area",
									"p", # predictions in the log scale for EE or NS series
									"mean", # mean of predictions 1960-1979 log scale
									"p_std_1960_1979", # scaled prediction exp(p-mean)
									"p_std_1960_1979_min",     
									"p_std_1960_1979_max",
									"p_std_1960_1979_maxgraph")],
					by=c("year", "area"))	%>% # join by year
			right_join(wger %>% dplyr::select(year, das_qal_id, site),
					by=c("year","site"))%>% # getting das_qal_id for the graph 
			inner_join(R_stations %>% select(ser_nameshort,cou_code) %>%rename(site = ser_nameshort ))%>%
			mutate(value_std_1960_1979=exp(log(value_std)-co-mean))	%>%
			arrange(site,year)  %>%
			mutate("selected" = TRUE) %>%
			select("year","area","cou_code","site","value_std_1960_1979","p_std_1960_1979","p_std_1960_1979_min","p_std_1960_1979_max","p_std_1960_1979_maxgraph","selected")
	
	
	not_selected <-	 wger_init %>% dplyr::select(value,year,site,ser_qal_id,area) %>%			         
			filter(ser_qal_id==0|ser_qal_id==3) %>% select(value,year,site,area)
	not_selected <-	left_join(not_selected,
					not_selected %>% group_by(site) %>% summarize(meanser=mean(value,na.rm=TRUE))
			) %>% mutate(value=value/meanser) %>%
			full_join(                             
					dat_ge[,c("year",
									"area",
									"p", # predictions in the log scale for EE or NS series
									"mean", # mean of predictions 1960-1979 log scale
									"p_std_1960_1979", # scaled prediction exp(p-mean)
									"p_std_1960_1979_min",     
									"p_std_1960_1979_max",
									"p_std_1960_1979_maxgraph"
							)],
					by=c("year","area") ) %>%		
			# calculate log average when value is not missing to rescale only on the common period
			inner_join(R_stations %>% select(ser_nameshort,cou_code) %>%rename(site = ser_nameshort ))
	
	not_selected <- inner_join(not_selected,
					not_selected %>% group_by(site) %>%
							summarize(		
									mean_pred_when_existing = mean(p[!is.na(value)]), # geometric mean log scale
									mean_pred_value_std = mean(log(value),na.rm=TRUE) # mean of log of existing observed											
							)
			) %>%						
			# Standardize the value to existing predictions
			mutate(
					standardized_same_period= log(value) - mean_pred_value_std + mean_pred_when_existing
			)%>% 	 
			# calculate the value standardized to 1960_1979, the wgeel series has also been scaled by mean 
			# which is the average 1960_1979
			mutate(
					value_std_1960_1979= exp(standardized_same_period -mean), 
					selected=FALSE
			)%>%
			select("year","area","cou_code","site","value_std_1960_1979","p_std_1960_1979","p_std_1960_1979_min","p_std_1960_1979_max","p_std_1960_1979_maxgraph","selected")
	
	all_data <- rbind(selected, not_selected)	
	sites_cou <- unique(filter(all_data, cou_code==params$country)$site)
	if (length(sites_cou) <11) palette <- gdocs_pal()(length(sites_cou)) else 
		palette <- gdocs_pal()(10)
		palette <- colorRampPalette(palette)(length(sites_cou))
	
	
	g <- ggplot(filter(all_data, cou_code==params$country)) +
			geom_ribbon(data=dat_ge[dat_ge$area==params$area,],
					aes(x=year, ymin=p_std_1960_1979_min, ymax=p_std_1960_1979_max),
					size=0.5,fill="dodgerblue",alpha=0.5) +
			geom_line(data=dat_ge[dat_ge$area==params$area,],
					aes(x=year, y=p_std_1960_1979), colour="darkblue", alpha=0.2) +
			geom_point(aes(x=year, y=value_std_1960_1979, color=site),size=1.5) +
			geom_line(aes(x=year, y=value_std_1960_1979, group=site, color=site),size=0.8, alpha=0.5) +
			scale_x_continuous( limits=c(1960,CY),breaks=c(1970,1980,1990,2000,2010,2020),
					minor_breaks=seq(from=min(1960,
									to=max(all_data$year),by=2))) +
			scale_colour_manual(values=palette) +
			facet_wrap(~selected)
	
	return(g)
}





map_recruitment <- function(){	
	
	# These values are standardized against the predictions in 1960s-1970s
	# the predictions are the predictions of the expand.grid(year,site,area)		
	# this is the North Sea or Elswhere Europe series
  
  
  	selected <- wger_init %>% dplyr::select(site,ser_qal_id,ser_id) %>%			         
			filter(ser_qal_id==1) %>% select(site,ser_id) %>%
	  distinct() %>%
	  inner_join(R_stations %>% 
	               select(ser_id,ser_nameshort,cou_code,ser_x,ser_y) %>%
	               rename(site = ser_nameshort )) %>%
	  mutate(selected=TRUE)%>%
	  filter(cou_code==params$country)
	
	not_selected <-	 wger_init %>% dplyr::select(site,ser_qal_id,ser_id) %>%			         
			filter(ser_qal_id==0|ser_qal_id==3) %>% select(site,ser_id) %>%
	  distinct() %>%
	  inner_join(R_stations %>% 
	               select(ser_id,ser_nameshort,cou_code,ser_x,ser_y) %>%
	               rename(site = ser_nameshort )) %>%
	  mutate(selected=FALSE)%>%
	  filter(cou_code==params$country)
	
	
	
	all_data <- rbind(selected, not_selected)	
	sites_cou <- unique(all_data$site)
	if (length(sites_cou) <11) palette <- gdocs_pal()(length(sites_cou)) else 
		palette <- gdocs_pal()(10)
		palette <- colorRampPalette(palette)(length(sites_cou))
	
	location=c(left=min(all_data$ser_x,na.rm=TRUE)-0.5,
	                        bottom=min(all_data$ser_y,na.rm=TRUE)-0.5,
	                        right=max(all_data$ser_x,na.rm=TRUE)+0.5,
	                        top=max(all_data$ser_y,na.rm=TRUE)+0.5)
	lon_range <- location[c("left", "right")]
  lat_range <- location[c("bottom", "top")]
  lonlength <- diff(lon_range)
  latlength <- diff(lat_range)
  zoomlon <- ceiling(log2(360 * 2/lonlength))
  zoomlat <- ceiling(log2(180 * 2/latlength))
  zoom <- max(zoomlon, zoomlat)
	
	mymap <-get_stamenmap(location,zoom=zoom,
	                maptype = "terrain-background",
	                source="stamen")
	
	g <- ggmap(mymap)+
	  geom_point(data=all_data,
	             aes(x=ser_x, y=ser_y,
	                 shape=as.factor(selected),
	                 col=site),
	             cex=3)+
	  scale_shape("Used in GLM")+
	  scale_colour_manual(values=palette)+
	  xlab("")+
	  ylab("")
	return(g)
}

```


```{r G, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Landings commercial fisheries", level=1)
if (params$G){
	pandoc.header("Glass eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings G"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage="G",
			year_range=params$year:CY,
			scalef=1000 # in tons
	)
	print(res %>% kable_styling())
	
	nrfigure=nrfigure+1
	
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage="G",
			year_range=1960:2020,
			scalef=1000
	)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings G"))
}
```
	
```{r Y, echo=FALSE, warning=FALSE, results="asis"}

if (params$Y){
	pandoc.header("Yellow eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage="Y",
			year_range=1960:2020, 
			scalef=1000
	)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage="Y",
			year_range=1960:2020, 		
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow"))
}
```

```{r YS, echo=FALSE, warning=FALSE, results="asis"}

if (params$YS){
	pandoc.header("Yellow silver", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow silver"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage=c("YS"),
			year_range=1960:2020, 
			scalef=1000)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage=c("YS"),
			year_range=1960:2020, 		
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow silver"))
}
```


```{r S, echo=FALSE, warning=FALSE, results="asis"}

if (params$S){
	pandoc.header("Silver eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Silver"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage=c("S"),
			year_range=1960:2020, 			
			scalef=1000)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage=c("S"),
			year_range=1960:2020, 			
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Silver"))
}
```


```{r Gr, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Landings Recreational fisheries", level=1)
if (params$Gr){
	pandoc.header("Glass eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings G recrational"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=6 , 
			life_stage="G",
			year_range=1960:2020, 
			scalef=1000
	)
	print(res %>% kable_styling())
	
	nrfigure=nrfigure+1
	
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=6 , 
			life_stage="G",
			year_range=1960:2020, 
			scalef=1000
	)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings G"))
}
```
	
```{r Yr, echo=FALSE, warning=FALSE, results="asis"}

if (params$Yr){
	pandoc.header("Yellow eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=6 , 
			life_stage="Y",
			year_range=1960:2020,
			scalef=1000
	)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=6 , 
			life_stage="Y",
			year_range=1960:2020, 
			scalef=1000
	)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow recreational"))
}
```

```{r YSr, echo=FALSE, warning=FALSE, results="asis"}

if (params$YSr){
	pandoc.header("Yellow silver", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow silver recreational"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=6 , 
			life_stage=c("YS"),
			year_range=1960:2020, 
			scalef=1000)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=6 , 
			life_stage=c("YS"),
			year_range=1960:2020,
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow silver recreational"))
}
```


```{r Sr, echo=FALSE, warning=FALSE, results="asis"}

if (params$Sr){
	pandoc.header("Silver eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Silver recreational"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=6 , 
			life_stage=c("S"),
			year_range=1960:2020, 
			scalef=1000)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=6 , 
			life_stage=c("S"),
			year_range=1960:2020, 
			scalef=1000)
	print(gg)
	pandoc.p(str_c("Figure ",nrfigure," : landings Silver recreational"))
}
```

```{r release, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Release", level=1)
# RELEASE IN NUMBER --------------------------
pandoc.header("In number", level=2)
nrtable=nrtable+1
pandoc.p(str_c("Table ",nrtable," : Release in millions"))
res <- table_pc_lfs(dataset="release", 
		country=  params$country, 
		typ=9 , 
		life_stage=c("G","Y","QG","OG","YS","S")[
				c(params$releaseG, params$releaseY, params$releaseQG,
						params$releaseOG, params$releaseYS, params$releaseS)],
		
		year_range=1960:2020, 
		scalef=10^6
)
print(res %>% kable_styling())
# FIGURE -------------------------------	
nrfigure=nrfigure+1

gg <- plot_pc_lfs(dataset="release", 
		country= params$country, 
		typ=9 , 
		life_stage=c("G","Y","QG","OG","YS","S")[
				c(params$releaseG, params$releaseY, params$releaseQG,
						params$releaseOG, params$releaseYS, params$releaseS)],
		year_range=params$year:CY, 
		scalef=10^6,
		ylab.="Release in million"
)
print(gg)
pandoc.p(str_c("Figure ",nrfigure," : Release in million"))

# RELEASE IN KG --------------------------	
pandoc.header("In kg", level=2)
nrtable=nrtable+1
pandoc.p(str_c("Table ",nrtable," : Release in kg"))
res <- table_pc_lfs(dataset="release", 
		country=  params$country, 
		typ=8 , 
		life_stage=c("G","Y","QG","OG","YS","S")[
				c(params$releaseG, params$releaseY, params$releaseQG,
						params$releaseOG, params$releaseYS, params$releaseS)],
		
		year_range=params$year:CY, 
		scalef=1
)
print(res %>% kable_styling())


gg <- plot_pc_lfs(dataset="release", 
		country= params$country, 
		typ=8 , 
		life_stage=c("G","Y","QG","OG","YS","S")[
				c(params$releaseG, params$releaseY, params$releaseQG,
						params$releaseOG, params$releaseYS, params$releaseS)],
		year_range=params$year:CY, 
		scalef=,
		ylab.="Release in kg"
)
print(gg)
pandoc.p(str_c("Figure ",nrfigure," : Release in kg"))

```

```{r aquaculture, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Aquaculture", level=1)
# RELEASE IN NUMBER --------------------------
nrtable=nrtable+1
pandoc.p(str_c("Table ",nrtable," : Aquaculture in Tons"))
res <- table_pc_lfs(dataset="aquaculture", 
		country=  params$country, 
		typ=11 , 
		life_stage=c("G","Y","QG","OG"),		
		year_range=1960:2020, 
		scalef=1000	    
)
print(res %>% kable_styling())
# FIGURE -------------------------------	
nrfigure=nrfigure+1

gg <- plot_pc_lfs(dataset="aquaculture", 
		country= params$country, 
		typ=11 , 
		life_stage=c("G","Y","QG","OG")	,
		year_range=params$year:CY, 
		scalef=1000,
		ylab.="Aquaculture in tons"
)
print(gg)
pandoc.p(str_c("Figure ",nrfigure," : Aquaculture"))



```
		
```{r recruit, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Recruitment series", level=1)
g <- figure_recruitment()
nrfigure=nrfigure+1
print(g)
pandoc.p(str_c("Figure ",nrfigure," : Recruitment, panel indicate if selected"))
nrfigure=nrfigure+1
print(g + scale_y_log10(limits=c(0.01,30),breaks=c(0.01,0.1,1,10,100,1000),labels=c("0.01","0.1","1","10","100","1000")))
pandoc.p(str_c("Figure ",nrfigure," : Recruitment log scale"))
```



```{r map, echo=FALSE, warning=FALSE, results="asis"}
if (params$map){
  pandoc.header("Maps of recruitment series", level=1)
  g <- map_recruitment()
  nrfigure=nrfigure+1
  print(g)
  pandoc.p(str_c("Figure ",nrfigure," : Maps of recruitment time series"))
}
```