---
title: "Country report for `r params$country`"
author: "ICES Data Group"
date: "`r Sys.Date()`"
documentclass: article
output: 
  bookdown::html_document2:
    fig_caption: true
    number_sections: true
    toc: yes
    toc_depth: 3
    toc_float: true
params:
  country:   
    label: "Country"
    value: FR
    input: select
    choices: [FR, IE, SE]
  G:   
    label: "Glass eel"
    value: TRUE
  Y:   
    label: "Yellow eel"
    value: TRUE
  YS:   
    label: "Yellow silver eel"
    value: TRUE    
  S:   
    label: "Silver eel"
    value: TRUE
---

```{r setup, include=FALSE}
require(knitr)
knitr::opts_chunk$set(echo = FALSE, warnings=FALSE, fig.width=12, fig.height=8)
opts_knit$set(eval.after = 'fig.cap' ) # to be used in chunks used only to plot pictures
options(knitr.table.format = 'pandoc') # options pour kable
options(knitr.kable.NA = '.')
my_pandoc_to <- knitr::opts_knit$get('rmarkdown.pandoc.to') # this variable will tell the kind of compilation used
CY=2020
getUsername <- function(){
	name <- Sys.info()[["user"]]
	return(name)
}
if (getUsername() == "cedric.briand") setwd("C:/workspace/gitwgeel/R/Rmarkdown") 
```





```{r load_utilities, eval=TRUE, echo=FALSE,include=FALSE}

source("../utilities/load_library.R")

#-----------------
# other libraries
#-----------------
load_package("readxl")
load_package("stringr")
load_package("tidyverse")
load_package("rlang")
load_package("dplyr")
load_package("RColorBrewer")
load_package("scales")
load_package('stringr') # text handling
load_package("ggplot2") # for excel
load_package("gridExtra")
load_package("colorspace")
load_package("ggrepel")
load_package("viridis")
load_package("glue")
load_package("kableExtra")
load_package("pander")

# load functions ------------------------------------------------------------------------------------
# retrieve reference tables needed
# the shiny is launched from shiny_data_integration/shiny thus we need the ../
if(is.null(options()$sqldf.RPostgreSQL.user)) 
	source("../shiny_data_visualisation/shiny_dv/database_connection.R")
source("../shiny_data_visualisation/shiny_dv/database_reference.R")
source("../shiny_data_visualisation/shiny_dv/database_data.R")
source("../shiny_data_visualisation/shiny_dv/database_precodata.R")
source("../shiny_data_visualisation/shiny_dv/preco_diagram.R")
source("../shiny_data_visualisation/shiny_dv/graphs.R")
source("../shiny_data_visualisation/shiny_dv/maps.R")
source("../shiny_data_visualisation/shiny_dv/filter_and_group_functions.R")
source("../shiny_data_visualisation/shiny_dv/predict_missing.R")



load("../shiny_data_visualisation/shiny_dv/data/maps_for_shiny.Rdata") 
# now data are generated by the script load_data_from_the_database.R
load("../shiny_data_visualisation/shiny_dv/data/ref_and_eel_data.Rdata")
## Download the colors by country

values=c(RColorBrewer::brewer.pal(12,"Set3"),
		RColorBrewer::brewer.pal(12, "Paired"), 
		RColorBrewer::brewer.pal(8,"Accent"),
		RColorBrewer::brewer.pal(8, "Dark2"))
color_countries = setNames(values,country_ref$cou_code)
nrtable <-  0
nrfigure <- 0



```






```{r functions, echo=FALSE, warning=FALSE}


#dataset="landings"; country= 'IE';dataset="landings"; typ=4 ; life_stage="G"; habitat=NULL; year_range=1980:2020; geo="emu";grouphabitat=FALSE; grouplfs=FALSE
# table_pc(dataset="landings", country= 'FR', typ=4 , life_stage="G", habitat=NULL, year_range=1980:2020, geo="emu", grouphabitat=FALSE, grouplfs=FALSE)
library(ggthemes)
# table per country
table_pc <- function(country, dataset, typ=NULL, life_stage = NULL, habitat=NULL, 
		year_range = 1900:2100,  grouphabitat=TRUE, grouplfs=TRUE){
	filtered_data <- filter_data(dataset = dataset,
			typ = typ,
			life_stage = life_stage,
			country = country,
			habitat = habitat,
			year_range = year_range
	) 
	grouped_data <-group_data(filtered_data,
			geo = "emu",
			habitat = grouphabitat,
			lfs = grouplfs,
			na.rm=TRUE)
	fun.agg<-function(X){
		if(length(X)>0){
			round(sum(X)/1000,ifelse(sum(X)>1000,0,3))
		}
		else{
			sum(c(X,NA))
		}
	}
	table = dcast(grouped_data, 
			eel_year~eel_emu_nameshort, 
			value.var = "eel_value",
			fun.aggregate = fun.agg)
	
	table <- dplyr::rename(table, year="eel_year")
	table<-data.frame(table,
			Sum=rowSums(table[,-1],na.rm=T)
	)
	colnames(table)[2:(ncol(table)-1)]<-substr(colnames(table)[2:(ncol(table)-1)],4,10)
	
	the_kable <- kable(table,			
			digits=2)
	return(the_kable)
}

# dataset="landings"; country= 'IE';dataset="landings"; typ=4 ; life_stage="Y"; habitat=NULL; year_range=1980:2020; 
# geo="emu";grouphabitat=FALSE; grouplfs=FALSE; scalingf=1/1000; ylb <- "Landings T"

plot_pc <- function(country, dataset, typ=NULL, life_stage = NULL, habitat=NULL, 
		year_range = 1900:2100,  grouphabitat=TRUE, grouplfs=TRUE,
		ylb="Landings T", scalingf=1/1000){
	filtered_data <- filter_data(dataset = dataset,
			typ = typ,
			life_stage = life_stage,
			country = country,
			habitat = habitat,
			year_range = year_range
	) 
	grouped_data <- group_data(filtered_data,
			geo = "emu",
			habitat = grouphabitat,
			lfs = grouplfs,
			na.rm=TRUE)
	
	grouped_data$eel_value <- as.numeric(grouped_data$eel_value) * scalingf
	grouped_data$eel_emu_nameshort = as.factor(grouped_data$eel_emu_nameshort)
	emus <- levels(grouped_data$eel_emu_nameshort)
	if (length(emus) <11) palette <- gdocs_pal()(length(emus)) else palette <- sequential_hcl(length(emus), "Viridis")
	#palette	[grep("total",emus)] <- "grey50"
	gg <- 	ggplot(grouped_data) + 
			geom_col(aes(x=eel_year,y=eel_value,fill=eel_emu_nameshort), position='stack')+
			xlab("year") + 
			ylab(ylb)+		
			scale_fill_manual(values=palette)+
	theme_gdocs()
	
	return(gg)
}
```


```{r G, echo=FALSE, warning=FALSE, results="asis"}
pandoc.header("Landings", level=1)
if (params$G){
	pandoc.header("Glass eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings G"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage="G",
			habitat=NULL, 
			year_range=1960:2020
			)
	print(res %>% kable_styling())
	
	nrfigure=nrfigure+1
	pandoc.p(str_c("Figure ",nrfigure," : landings G"))
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage="G",
			habitat=NULL, 
			year_range=1960:2020
			)
	print(gg)
}
```
	
```{r Y, echo=FALSE, warning=FALSE, results="asis"}

if (params$Y){
	pandoc.header("Yellow eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage="Y",
			habitat=NULL, 
			year_range=1960:2020, 
			grouphabitat=FALSE, 
			grouplfs=FALSE)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow"))
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage="Y",
			habitat=NULL, 
			year_range=1960:2020, 
			grouphabitat=FALSE, 
			grouplfs=FALSE)
	print(gg)
}
```

```{r YS, echo=FALSE, warning=FALSE, results="asis"}

if (params$YS){
	pandoc.header("Yellow silver", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Yellow silver"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage=c("YS"),
			habitat=NULL, 
			year_range=1960:2020, 
			grouphabitat=FALSE, 
			grouplfs=FALSE)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	pandoc.p(str_c("Figure ",nrfigure," : landings Yellow silver"))
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage=c("YS"),
			habitat=NULL, 
			year_range=1960:2020, 
			grouphabitat=FALSE, 
			grouplfs=FALSE)
	print(gg)
}
```


```{r S, echo=FALSE, warning=FALSE, results="asis"}

if (params$S){
	pandoc.header("Silver eel", level=2)
	nrtable=nrtable+1
	pandoc.p(str_c("Table ",nrtable," : landings Silver"))
	res <- table_pc(dataset="landings", 
			country=  params$country, 
			typ=4 , 
			life_stage=c("S"),
			habitat=NULL, 
			year_range=1960:2020, 
			grouphabitat=FALSE, 
			grouplfs=FALSE)
	print(res %>% kable_styling())
	
	nfigure=nrfigure+1
	pandoc.p(str_c("Figure ",nrfigure," : landings Silver"))
	gg <-plot_pc(dataset="landings", 
			country= params$country, 
			typ=4 , 
			life_stage=c("S"),
			habitat=NULL, 
			year_range=1960:2020, 
			grouphabitat=FALSE, 
			grouplfs=FALSE)
	print(gg)
}
```