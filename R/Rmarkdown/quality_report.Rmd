---
title: "Trend in fisheries"
author: "WGEEL"
date: "27 September 2021"
output: word_document
keep_md: yes
test: "`r paste('_metadata.yaml')`"
---
\newline
```{r setup, include=TRUE, echo=FALSE}
# replace word_document or html_document

#--------------------------------
# get your current name 
#--------------------------------
getUsername <- function(){
	name <- Sys.info()[["user"]]
	return(name)
}
#--------------------------------

#if (getUsername() == "hilaire.drouineau") setwd("~/Documents/Bordeaux/migrateurs/WGEEL/github/wg_WGEEL/R/Rmarkdown/")
#if (getUsername() == "cedric.briand") setwd("C:/workspace/gitwgeel/R/Rmarkdown") 
#if (getUsername() == "cboulenger") setwd("C:/Users/cboulenger/Documents/wg_WGEEL/R/Rmarkdown") 

CY=2022
library(stringr)
knitr::opts_chunk$set(echo = TRUE, warnings=FALSE, error = TRUE)
#source("R/utilities/set_directory.R")
#data_directory <- wg_choose.dir(caption = "Where do you want to save the tables and the graphs")
#data_directory <-"C:/temp"
#knitr::opts_knit$set(root.dir = data_directory)
render="docx"  # html 
# temporary file to store the variables (this is necessary to print the text)

# to test the output and adapt the type of table
output <- rmarkdown::metadata$output
```



```{r load_utilities, eval=TRUE, echo=FALSE,include=FALSE}

source("../utilities/load_library.R")

#-----------------
# other libraries
#-----------------
load_package("readxl")
load_package("stringr")
load_package("reshape2")
load_package("tidyr") # unite cols in maps
load_package("rlang")
load_package("sp")
#load_package("pool")
#load_package("DBI")
load_package("RPostgreSQL")
load_package("dplyr")
load_package("RColorBrewer")
load_package("sqldf")
load_package("scales")
load_package('stringr') # text handling
#load_package("XLConnect") # for excel
load_package("ggplot2") # for excel
load_package("gridExtra")
load_package("colorspace")
load_package("ggrepel")
load_package("viridis")
load_package("svglite")
load_package("leaflet.minicharts")
load_package("glue")
load_package("kableExtra")
load_package("yaml")

# load functions ------------------------------------------------------------------------------------
# retrieve reference tables needed
# the shiny is launched from shiny_data_integration/shiny thus we need the ../
if(is.null(options()$sqldf.RPostgreSQL.user)){
	wd <- getwd()
	setwd("../shiny_data_visualisation/shiny_dv/")
	source("database_connection.R")
	setwd(wd)
}
biometry_group_data_series <- dbGetQuery(
		con_wgeel,
		"SELECT * FROM datawg.t_series_ser
				JOIN datawg.t_groupseries_grser  ON grser_ser_id = ser_id
				JOIN datawg.t_metricgroupseries_megser ON meg_gr_id = gr_id 
				LEFT JOIN ref.tr_metrictype_mty ON mty_id=meg_mty_id 
				")
biometry_group_data_sampling <- dbGetQuery(
		con_wgeel,
		"SELECT * FROM datawg.t_samplinginfo_sai 
				JOIN datawg.t_groupsamp_grsa  ON grsa_sai_id = sai_id
				JOIN datawg.t_metricgroupsamp_megsa ON meg_gr_id = gr_id 
				LEFT JOIN ref.tr_metrictype_mty ON mty_id=meg_mty_id 
				")
dbDisconnect(con_wgeel)

biometry_group_data_series_long <- biometry_group_data_series %>% 
		select(-geom, -mty_id, -mty_min, -mty_max)  %>% 
		pivot_wider(names_from = mty_name, values_from = meg_value)

biometry_group_data_sampling_long <- biometry_group_data_sampling %>% 
		select( -mty_id, -mty_min, -mty_max)  %>% 
		pivot_wider(names_from = mty_name, values_from = meg_value)



```

